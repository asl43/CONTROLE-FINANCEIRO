<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; padding:20px; }
.container { max-width:1200px; margin:0 auto; }
header { text-align:center; margin-bottom:20px; }
header h1 { font-size:2em; color:#333; }
.cards-summary { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:20px; }
.card { background:white; border-radius:12px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
.card-label { font-size:0.85em; color:#666; margin-bottom:5px; text-transform:uppercase; }
.card-value { font-size:1.5em; font-weight:600; }
.card-pagar .card-value { color:#ff6b6b; }
.card-receber .card-value { color:#51cf66; }
.card-saldo .card-value { color:#667eea; }
.content { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
.form-section, .chart-section, .table-section { background:white; border-radius:12px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
.form-section h2, .chart-section h2, .table-section h2 { font-size:1.2em; margin-bottom:15px; }
.form-group { margin-bottom:10px; }
label { display:block; font-size:0.85em; color:#666; margin-bottom:5px; text-transform:uppercase; }
input, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; }
button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
.btn-primary { background:#667eea; color:white; width:100%; }
.btn-primary:hover { background:#5568d3; }
.btn-danger { background:#ff6b6b; color:white; }
.btn-edit { background:#51cf66; color:white; }
.btn-fav { background:#ffc107; color:white; font-size:0.8em; padding:5px 10px; }
.search-bar { margin-bottom:10px; }
.search-bar input { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; }
table { width:100%; border-collapse:collapse; }
th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
tr:hover { background:#f9f9f9; }
.badge { padding:3px 8px; border-radius:12px; font-size:0.75em; font-weight:600; text-transform:uppercase; }
.badge-pagar { background:#ffe5e5; color:#ff6b6b; }
.badge-receber { background:#e5ffe5; color:#51cf66; }
.badge-pendente { background:#fff4e5; color:#ffc107; }
.badge-pago { background:#e5ffe5; color:#51cf66; }
.actions { display:flex; gap:5px; }
.export-btn { margin-bottom:10px; background:#667eea; color:white; }
.star { color: #ffc107; font-size:1.2em; cursor:pointer; }
.star-empty { color:#ddd; font-size:1.2em; cursor:pointer; }
@media(max-width:768px){ .content{grid-template-columns:1fr;} }
</style>
</head>
<body>

<div class="container">
<header>
<h1>💰 Controle Financeiro</h1>
</header>

<div class="cards-summary">
<div class="card card-pagar"><div class="card-label">Total a Pagar</div><div class="card-value" id="totalPagar">R$ 0,00</div></div>
<div class="card card-receber"><div class="card-label">Total a Receber</div><div class="card-value" id="totalReceber">R$ 0,00</div></div>
<div class="card card-saldo"><div class="card-label">Saldo do Dia</div><div class="card-value" id="totalDia">R$ 0,00</div></div>
</div>

<div class="content">
<div class="form-section">
<h2>Novo Registro</h2>
<form id="financeForm">
<input type="hidden" id="row">

<div class="form-group">
<label for="data">Data</label>
<input type="date" id="data" required>
</div>

<div class="form-group">
<label for="tipo">Tipo</label>
<select id="tipo" required>
<option value="Pagar">Pagar</option>
<option value="Receber">Receber</option>
</select>
</div>

<div class="form-group">
<label for="descricao">Descrição</label>
<input type="text" id="descricao" placeholder="Ex: Aluguel, Salário..." required>
</div>

<div class="form-group">
<label for="valor">Valor</label>
<input type="number" id="valor" placeholder="0,00" required step="0.01">
</div>

<div class="form-group">
<label for="status">Status</label>
<select id="status" required>
<option value="Pendente">Pendente</option>
<option value="Pago">Pago</option>
</select>
</div>

<div class="form-group">
<label for="campo1">Campo Adicional 1</label>
<input type="text" id="campo1" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo2">Campo Adicional 2</label>
<input type="text" id="campo2" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo3">Campo Adicional 3</label>
<input type="text" id="campo3" placeholder="Opcional">
</div>

<button type="submit" class="btn-primary">Salvar Registro</button>
</form>
</div>

<div class="chart-section">
<h2>Resumo Visual</h2>
<canvas id="graficoTipo"></canvas>
</div>
</div>

<div class="table-section">
<h2>Registros</h2>
<div class="search-bar">
<input type="text" id="buscar" placeholder="🔍 Buscar por descrição, data ou tipo...">
</div>
<button class="btn-primary export-btn" onclick="exportarExcel()">📊 Exportar para Excel</button>
<table id="tabelaFinance">
<thead>
<tr>
<th>Fav</th>
<th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th><th>Status</th><th>Campos</th><th>Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<script>
let registros = [];
let chart;

// LINKS DOS WEB APPS
const WEB_APP1 = "https://script.google.com/macros/s/AKfycby8RMoklQLNtr6Ffg9_ubqo8cH2in9hJgpP5zezr5CyzrULaRF74k4mnWzd11lmx-P2/exec";
const WEB_APP2 = "https://script.google.com/macros/s/AKfycbyRZVTP6kiEh4_f5kucZvc82U4WtiGaKhTNo5g1Gerqh4yzLwVBs8gxEJVTwmmHCtf2/exec";

const formatarMoeda = valor => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);

function mostrarRegistros(lista){
const tbody = document.querySelector("#tabelaFinance tbody");
tbody.innerHTML="";
let totalPagar=0,totalReceber=0;
lista.forEach(r=>{
const tr=document.createElement("tr");
const tipoBadge=r.tipo==="Pagar"?"badge-pagar":"badge-receber";
const statusBadge=r.status==="Pendente"?"badge-pendente":"badge-pago";
const starClass = r.fav ? "star" : "star-empty";
tr.innerHTML=`<td><span class="${starClass}" onclick="toggleFav(${r.row})">★</span></td>
<td>${new Date(r.data).toLocaleDateString('pt-BR')}</td>
<td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
<td>${r.descricao}</td>
<td>${formatarMoeda(parseFloat(r.valor))}</td>
<td><span class="badge ${statusBadge}">${r.status}</span></td>
<td>${r.campo1||'-'} ${r.campo2||''} ${r.campo3||''}</td>
<td><div class="actions">
<button class="btn-edit" onclick="editar(${r.row})">Editar</button>
<button class="btn-danger" onclick="excluir(${r.row})">Excluir</button>
</div></td>`;
tbody.appendChild(tr);
if(r.tipo==="Pagar") totalPagar+=parseFloat(r.valor);
if(r.tipo==="Receber") totalReceber+=parseFloat(r.valor);
});
document.getElementById("totalPagar").innerText=formatarMoeda(totalPagar);
document.getElementById("totalReceber").innerText=formatarMoeda(totalReceber);
document.getElementById("totalDia").innerText=formatarMoeda(totalReceber-totalPagar);
atualizarGrafico(lista);
}

function atualizarGrafico(filtro=registros){
const pagar=filtro.filter(r=>r.tipo==="Pagar").reduce((sum,r)=>sum+parseFloat(r.valor),0);
const receber=filtro.filter(r=>r.tipo==="Receber").reduce((sum,r)=>sum+parseFloat(r.valor),0);
const ctx=document.getElementById('graficoTipo').getContext('2d');
if(chart) chart.destroy();
chart=new Chart(ctx,{type:'doughnut',data:{labels:['Pagar','Receber'],datasets:[{data:[pagar,receber],backgroundColor:['#ff6b6b','#51cf66'],borderColor:'white',borderWidth:3}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
}

async function enviarWebApp(dados){
try{
await fetch(WEB_APP1,{method:'POST',body:JSON.stringify(dados)});
await fetch(WEB_APP2,{method:'POST',body:JSON.stringify(dados)});
}catch(e){console.error("Erro ao enviar WebApp:",e);}
}

async function carregarRegistros(){
try{
const resp1=await fetch(WEB_APP1,{method:'POST',body:JSON.stringify({action:'get'})});
const resp2=await fetch(WEB_APP2,{method:'POST',body:JSON.stringify({action:'get'})});
const data1=await resp1.json();
const data2=await resp2.json();
registros=[...data1,...data2].map((r,i)=>({...r,row:i+1,fav:r.fav||false}));
mostrarRegistros(registros);
}catch(e){console.error("Erro ao carregar:",e);}
}

document.getElementById("financeForm").addEventListener("submit",function(e){
e.preventDefault();
const data=document.getElementById("data").value;
const tipo=document.getElementById("tipo").value;
const descricao=document.getElementById("descricao").value;
const valor=document.getElementById("valor").value;
const status=document.getElementById("status").value;
const campo1=document.getElementById("campo1").value;
const campo2=document.getElementById("campo2").value;
const campo3=document.getElementById("campo3").value;
if(!data||!tipo||!descricao||!valor||!status){alert("Preencha todos os campos!"); return;}
const row=document.getElementById("row").value;
if(row){ // Editar existente
const idx = registros.findIndex(r=>r.row==row);
registros[idx]={...registros[idx],data,tipo,descricao,valor,status,campo1,campo2,campo3};
enviarWebApp({...registros[idx],action:'edit'});
document.getElementById("row").value="";
}else{ // Novo registro
const novoRegistro={data,tipo,descricao,valor,status,campo1,campo2,campo3,fav:false,row:registros.length+1};
registros.push(novoRegistro);
enviarWebApp({...novoRegistro,action:'add'});
}
this.reset();
document.getElementById("data").valueAsDate=new Date();
mostrarRegistros(registros);
});

document.getElementById("buscar").addEventListener("input",function(){
const termo=this.value.toLowerCase();
const filtrados=registros.filter(r=>r.descricao.toLowerCase().includes(termo)||r.tipo.toLowerCase().includes(termo)||r.data.includes(termo));
mostrarRegistros(filtrados);
});

function exportarExcel(){
const ws_data=registros.map(r=>[r.fav?"★":"",new Date(r.data).toLocaleDateString('pt-BR'),r.tipo,r.descricao,r.valor,r.status,r.campo1,r.campo2,r.campo3]);
ws_data.unshift(["Fav","Data","Tipo","Descrição","Valor","Status","Campo1","Campo2","Campo3"]);
const wb=XLSX.utils.book_new();
const ws=XLSX.utils.aoa_to_sheet(ws_data);
XLSX.utils.book_append_sheet(wb,ws,"Financeiro");
XLSX.writeFile(wb,"Controle_Financeiro.xlsx");
}

function editar(row){
const r=registros.find(r=>r.row===row);
if(r){
document.getElementById("row").value=r.row;
document.getElementById("data").value=r.data;
document.getElementById("tipo").value=r.tipo;
document.getElementById("descricao").value=r.descricao;
document.getElementById("valor").value=r.valor;
document.getElementById("status").value=r.status;
document.getElementById("campo1").value=r.campo1;
document.getElementById("campo2").value=r.campo2;
document.getElementById("campo3").value=r.campo3;
window.scrollTo({top:0,behavior:'smooth'});
}
}

function excluir(row){
if(confirm("Deseja excluir este registro?")){
const idx = registros.findIndex(r=>r.row===row);
enviarWebApp({...registros[idx],action:'delete'});
registros.splice(idx,1);
mostrarRegistros(registros);
}
}

function toggleFav(row){
const idx = registros.findIndex(r=>r.row===row);
registros[idx].fav=!registros[idx].fav;
enviarWebApp({...registros[idx],action:'edit'});
mostrarRegistros(registros);
}

// Inicializar
document.getElementById("data").valueAsDate=new Date();
carregarRegistros();
</script>

</body>
</html>

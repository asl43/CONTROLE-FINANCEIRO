<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* VARI√ÅVEIS DE COR E TEMA */
:root {
    --bg-dark: linear-gradient(135deg,#1e1e2e 0%,#2a2a3e 100%);
    --bg-light: linear-gradient(135deg,#f0f0f5 0%,#e0e0eeb0 100%);
    --card-bg-dark: linear-gradient(135deg,#2a2a3e 0%,#1f1f2e 100%);
    --card-bg-light: #ffffff;
    --text-color-dark: #e0e0e0;
    --text-color-light: #333333;
    --header-color-dark: #fff;
    --header-color-light: #4a90e2;
    --input-bg-dark: rgba(255,255,255,0.05);
    --input-bg-light: #ffffff;
    --input-border-dark: rgba(255,255,255,0.2);
    --input-border-light: #dddddd;
    --table-header-bg-dark: rgba(255,255,255,0.05);
    --table-header-bg-light: #f5f5f5;
    --table-row-hover-dark: rgba(255,255,255,0.05);
    --table-row-hover-light: #f0f0f0;
    --primary-color: #4a90e2;
    --pagar-color: #ff6b9d;
    --receber-color: #26de81;
    --vencido-color: #f74f4f;
    --meta-color: #9966ff;
    --warning-color: #ffc107;
}

/* TEMA CLARO */
html[data-theme="light"] {
    --bg-dark: var(--bg-light);
    --card-bg-dark: var(--card-bg-light);
    --text-color-dark: var(--text-color-light);
    --header-color-dark: var(--header-color-light);
    --input-bg-dark: var(--input-bg-light);
    --input-border-dark: var(--input-border-light);
    --table-header-bg-dark: var(--table-header-bg-light);
    --table-row-hover-dark: var(--table-row-hover-light);
    --sync-dot-dark: #26de81;
}

/* ESTILOS BASEADOS EM VARI√ÅVEIS */
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background:var(--bg-dark);
  padding:20px; 
  color:var(--text-color-dark);
  min-height:100vh;
  transition: background 0.5s, color 0.5s;
}
.container { max-width:1400px; margin:0 auto; }
header { text-align:center; margin-bottom:40px; }
header h1 { 
  font-size:2.5em; 
  color:var(--header-color-dark); 
  font-weight:700;
  letter-spacing:-1px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
}

/* Estilos para o bot√£o de tema */
.theme-toggle-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-color);
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* Estilos para tela de login */
.login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
.login-box {
    background: var(--card-bg-dark);
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    text-align: center;
    min-width: 350px;
}
.login-box h2 {
    color: var(--header-color-dark);
    margin-bottom: 10px;
}
.login-box input {
    width: 100%;
    padding: 12px 15px;
    margin: 20px 0;
    border: 1px solid var(--input-border-dark);
    border-radius: 10px;
    background: var(--input-bg-dark);
    color: var(--text-color-dark);
    font-size: 1em;
}
.login-box button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, var(--primary-color), #357abd);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1em;
}
.erro-senha {
    color: var(--pagar-color);
    margin-top: 15px;
    font-weight: 600;
}
.loading {
    display: none;
    text-align: center;
    padding: 15px;
    color: var(--primary-color);
    font-weight: 600;
}
.loading.show {
    display: block;
}

.sync-status {
  background:rgba(38,222,129,0.2);
  border:1px solid rgba(38,222,129,0.5);
  color:var(--receber-color);
  padding:10px 15px;
  border-radius:10px;
  font-size:0.9em;
  margin-bottom:20px;
  display:flex;
  align-items:center;
  gap:10px;
  width:fit-content;
  margin-left:auto;
  margin-right:auto;
}
.sync-status.offline {
  background:rgba(255,107,157,0.2);
  border-color:rgba(255,107,157,0.5);
  color:var(--pagar-color);
}
.sync-status .dot {
  width:10px;
  height:10px;
  border-radius:50%;
  background:var(--receber-color);
  animation:pulse 2s infinite;
}
.sync-status.offline .dot {
  background:var(--pagar-color);
  animation:none;
}
@keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.5; } }

.cards-summary { 
  display:grid; 
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px; 
  margin-bottom:30px; 
}
.card { 
  background:var(--card-bg-dark);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  transition:transform 0.3s ease,box-shadow 0.3s ease, background 0.5s;
  backdrop-filter:blur(10px);
}
html[data-theme="light"] .card {
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    border: 1px solid #eeeeee;
}
.card:hover { 
  transform:translateY(-5px); 
  box-shadow:0 15px 50px rgba(0,0,0,0.4);
}
.card-label { 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:10px; 
  text-transform:uppercase; 
  letter-spacing:1px;
  font-weight:600;
}
.card-value { 
  font-size:1.8em;
  font-weight:700;
  letter-spacing:-1px;
}
.card-pagar .card-value { color:var(--pagar-color); }
.card-receber .card-value { color:var(--receber-color); }
.card-saldo .card-value { color:var(--primary-color); }
.card-vencido .card-value { color:var(--vencido-color); }
.card-meta .card-value { color:var(--meta-color); }
.card-meta { position: relative; cursor: pointer; }
.card-meta:hover { border-color: var(--meta-color); }
.card-meta .edit-hint {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 0.8em;
    color: var(--meta-color);
    opacity: 0.7;
}
.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    margin-top: 10px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--receber-color), var(--primary-color));
    border-radius: 10px;
    transition: width 0.3s ease;
}
.progress-fill.warning {
    background: linear-gradient(90deg, var(--warning-color), var(--pagar-color));
}
.progress-fill.danger {
    background: linear-gradient(90deg, var(--pagar-color), var(--vencido-color));
}

.content { 
  display:grid; 
  grid-template-columns:1fr 1fr; 
  gap:25px; 
  margin-bottom:30px; 
}
.form-section, .chart-section, .table-section { 
  background:var(--card-bg-dark);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  transition: background 0.5s;
}
html[data-theme="light"] .form-section, 
html[data-theme="light"] .chart-section, 
html[data-theme="light"] .table-section {
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    border: 1px solid #eeeeee;
}
.form-section h2, .chart-section h2, .table-section h2 { 
  font-size:1.4em; 
  margin-bottom:20px;
  color:var(--header-color-dark);
  font-weight:700;
  transition: color 0.5s;
}
.form-group { margin-bottom:15px; }
label { 
  display:block; 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:8px; 
  text-transform:uppercase; 
  font-weight:600;
  letter-spacing:0.5px;
}
input, select { 
  width:100%; 
  padding:12px 15px; 
  border:1px solid var(--input-border-dark); 
  border-radius:10px; 
  background:var(--input-bg-dark);
  color:var(--text-color-dark);
  font-size:1em;
  transition:all 0.3s ease;
}
html[data-theme="light"] input, 
html[data-theme="light"] select {
    color: var(--text-color-light);
}
input:focus, select:focus { 
  outline:none;
  border-color:var(--primary-color);
  background:rgba(74,144,226,0.1);
  box-shadow:0 0 20px rgba(74,144,226,0.3);
}
button { 
  padding:12px 24px; 
  border:none; 
  border-radius:10px; 
  cursor:pointer; 
  font-weight:600;
  font-size:1em;
  transition:all 0.3s ease;
}
.btn-primary { 
  background:linear-gradient(135deg,var(--primary-color) 0%,#357abd 100%);
  color:white; 
  width:100%; 
}
.btn-primary:hover { 
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(74,144,226,0.4);
}
.btn-danger { 
  background:linear-gradient(135deg,var(--pagar-color) 0%,#d63447 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-edit { 
  background:linear-gradient(135deg,var(--receber-color) 0%,#1bb366 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-filter {
  background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%);
  color:white;
  padding:10px 20px;
  margin-bottom:0; 
  font-size:0.95em;
  width: auto;
}
.btn-filter.active {
  background:linear-gradient(135deg,var(--pagar-color) 0%,#d63447 100%);
}
.search-bar { margin-bottom:15px; }
.search-bar input { width:100%; }

table { width:100%; border-collapse:collapse; }
th { 
  padding:15px 10px; 
  text-align:left; 
  background:var(--table-header-bg-dark);
  border-bottom:2px solid rgba(255,255,255,0.1);
  font-weight:700;
  color:var(--header-color-dark);
  font-size:0.95em;
  transition: background 0.5s, color 0.5s;
}
td { 
  padding:15px 10px; 
  border-bottom:1px solid rgba(255,255,255,0.05); 
}
html[data-theme="light"] td {
    border-bottom: 1px solid #eeeeee;
}
tr:hover { background:var(--table-row-hover-dark); }

.badge { 
  padding:6px 12px; 
  border-radius:20px; 
  font-size:0.8em; 
  font-weight:700; 
  text-transform:uppercase;
  letter-spacing:0.5px;
  display:inline-block;
}
.badge-pagar { 
  background:rgba(255,107,157,0.2); 
  color:var(--pagar-color); 
  border:1px solid rgba(255,107,157,0.5);
}
.badge-receber { 
  background:rgba(38,222,129,0.2); 
  color:var(--receber-color); 
  border:1px solid rgba(38,222,129,0.5);
}
.badge-pendente { 
  background:rgba(255,193,7,0.2); 
  color:#ffc107; 
  border:1px solid rgba(255,193,7,0.5);
}
.badge-pago { 
  background:rgba(38,222,129,0.2); 
  color:var(--receber-color); 
  border:1px solid rgba(38,222,129,0.5);
}

.status-filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
    padding: 15px;
    background: var(--input-bg-dark);
    border-radius: 10px;
    border: 1px solid var(--input-border-dark);
}
.status-filter-btn {
    padding: 8px 16px;
    border: 2px solid transparent;
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
    color: var(--text-color-dark);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}
.status-filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.status-filter-btn.active {
    border-color: var(--primary-color);
    background: rgba(74,144,226,0.2);
    color: var(--primary-color);
}
.status-filter-btn.filter-pendente.active {
    border-color: var(--warning-color);
    background: rgba(255,193,7,0.2);
    color: var(--warning-color);
}
.status-filter-btn.filter-pago.active {
    border-color: var(--receber-color);
    background: rgba(38,222,129,0.2);
    color: var(--receber-color);
}
.status-filter-btn.filter-recebido.active {
    border-color: var(--receber-color);
    background: rgba(38,222,129,0.2);
    color: var(--receber-color);
}
.status-filter-btn.filter-pagar.active {
    border-color: var(--pagar-color);
    background: rgba(255,107,157,0.2);
    color: var(--pagar-color);
}
.status-filter-btn.filter-receber.active {
    border-color: var(--receber-color);
    background: rgba(38,222,129,0.2);
    color: var(--receber-color);
}
.filter-count {
    background: rgba(255,255,255,0.2);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 700;
}

.actions { 
  display:flex; 
  gap:8px;
}
.filter-controls {
    display:flex; 
    gap:10px; 
    margin-bottom:15px; 
    flex-wrap:wrap; 
    align-items:flex-end;
}
.filter-item {
    min-width:150px;
    flex: 1;
}
.filter-item-large {
    flex: 2;
    min-width: 250px;
}
.filter-summary {
    background: rgba(74,144,226,0.1);
    border: 1px solid var(--primary-color);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    font-weight: 600;
    display: flex;
    justify-content: space-around;
    align-items: center;
    flex-wrap: wrap;
    display: none;
}
.filter-summary span {
    margin: 5px 10px;
}
.summary-value-pagar { color: var(--pagar-color); font-weight: 700; }
.summary-value-receber { color: var(--receber-color); font-weight: 700; }
.summary-value-saldo { color: var(--primary-color); font-weight: 700; }
.star-empty, .star {
    font-size: 1.2em;
    cursor: pointer;
    transition: color 0.2s;
}
.star-empty {
    color: #b0b0b0;
}
.star {
    color: #ffc107;
}

@media(max-width:768px){
  .content{ grid-template-columns:1fr; }
  header h1 { font-size:1.8em; }
  .card-value { font-size:1.5em; }
  table { font-size:0.9em; }
  th, td { padding:10px 5px; }
  .filter-controls > div {
      min-width: 100%;
  }
  .status-filters {
      justify-content: center;
  }
  .status-filter-btn {
      font-size: 0.85em;
      padding: 6px 12px;
  }
}
</style>
</head>
<body>

<button class="theme-toggle-btn" onclick="toggleTheme()">‚òÄÔ∏è Modo Diurno</button>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>üîê Acesso Restrito</h2>
    <p style="color:#b0b0b0; margin-bottom:20px;">Digite a senha para acessar o sistema</p>
    <input type="password" id="senhaInput" placeholder="Digite sua senha" onkeypress="if(event.key==='Enter') fazerLogin()">
    <button onclick="fazerLogin()">üîì Entrar</button>
    <div class="erro-senha" id="erroSenha"></div>
  </div>
</div>

<div class="container" id="mainContainer" style="display:none;">
<header>
<h1>üí∞ Controle Financeiro</h1>
<div class="sync-status" id="syncStatus">
  <div class="dot"></div>
  <span id="syncText">Sincronizado</span>
</div>
</header>

<div class="cards-summary">
    <div class="card card-pagar"><div class="card-label">Total a Pagar</div><div class="card-value" id="totalPagar">R$ 0,00</div></div>
    <div class="card card-receber"><div class="card-label">Total a Receber</div><div class="card-value" id="totalReceber">R$ 0,00</div></div>
    <div class="card card-saldo"><div class="card-label">Saldo do Dia</div><div class="card-value" id="totalDia">R$ 0,00</div></div>
    <div class="card card-vencido"><div class="card-label">Contas Vencidas</div><div class="card-value" id="totalVencidos">R$ 0,00</div></div>
    <div class="card card-pagar"><div class="card-label">Vencem 7 Dias</div><div class="card-value" id="vencemSeteDias">R$ 0,00</div></div>
    <div class="card card-pagar"><div class="card-label">Gasto Hoje</div><div class="card-value" id="gastoHoje">R$ 0,00</div></div>
    <div class="card card-pagar"><div class="card-label">Gasto este M√™s</div><div class="card-value" id="gastoMes">R$ 0,00</div></div>
    
    <div class="card card-meta" onclick="editarMeta()">
        <div class="edit-hint">‚úèÔ∏è Clique para editar</div>
        <div class="card-label" id="metaLabel">Meta de Gastos (M√™s)</div>
        <div class="card-value" id="metaValor">R$ 0,00</div>
        <div class="progress-bar">
            <div class="progress-fill" id="metaProgress"></div>
        </div>
        <div style="font-size: 0.85em; margin-top: 8px; color: #b0b0b0;" id="metaPercentual">0% utilizado</div>
    </div>
</div>

<div class="content">
<div class="form-section">
<h2>üìù Novo Registro (Atalho: Pressione '+' ou 'n' para Focar)</h2>
<form id="financeForm">
<input type="hidden" id="row">
<input type="hidden" id="sheetRowId">

<div class="form-group">
<label for="data">Data</label>
<input type="date" id="data" required>
</div>

<div class="form-group">
<label for="tipo">Tipo</label>
<select id="tipo" required>
<option value="Pagar">Pagar</option>
<option value="Receber">Receber</option>
</select>
</div>

<div class="form-group">
<label for="descricao">Descri√ß√£o</label>
<input type="text" id="descricao" placeholder="Ex: Aluguel, Sal√°rio..." required>
</div>

<div class="form-group">
    <label for="categoria">Categoria</label>
    <select id="categoria" required>
        <option value="">Selecione a Categoria</option>
        <option value="Sal√°rio/Renda">Sal√°rio/Renda</option>
        <option value="Investimento">Investimento</option>
        <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
        <option value="Moradia/Aluguel">Moradia/Aluguel</option>
        <option value="Transporte">Transporte</option>
        <option value="Lazer">Lazer</option>
        <option value="Sa√∫de">Sa√∫de</option>
        <option value="Educa√ß√£o">Educa√ß√£o</option>
        <option value="Outros">Outros</option>
    </select>
</div>

<div class="form-group">
<label for="valor">Valor</label>
<input type="number" id="valor" placeholder="0,00" required step="0.01">
</div>

<div class="form-group">
<label for="status">Status</label>
<select id="status" required>
<option value="Pendente">Pendente</option>
<option value="Pago">Pago</option>
<option value="Recebido">Recebido</option>
</select>
</div>

<div class="form-group">
<label for="campo2">Campo Adicional 2</label>
<input type="text" id="campo2" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo3">Campo Adicional 3</label>
<input type="text" id="campo3" placeholder="Opcional">
</div>

<button type="submit" class="btn-primary">üíæ Salvar Registro</button>
</form>
</div>

<div class="chart-section">
<h2>üìä Resumo Visual (Pendentes por Categoria)</h2>
<canvas id="graficoTipo"></canvas>
</div>
</div>

<div class="content" style="grid-template-columns: 1fr;">
<div class="table-section">
<h2>üìã Registros</h2>
<div class="loading" id="loading">‚è≥ Sincronizando...</div>

<div class="status-filters">
    <button class="status-filter-btn filter-todos active" onclick="filtrarPorStatus('todos')">
        üîç Todos <span class="filter-count" id="countTodos">0</span>
    </button>
    <button class="status-filter-btn filter-pendente" onclick="filtrarPorStatus('Pendente')">
        ‚è≥ Pendentes <span class="filter-count" id="countPendente">0</span>
    </button>
    <button class="status-filter-btn filter-pago" onclick="filtrarPorStatus('Pago')">
        ‚úÖ Pagos <span class="filter-count" id="countPago">0</span>
    </button>
    <button class="status-filter-btn filter-recebido" onclick="filtrarPorStatus('Recebido')">
        üí∞ Recebidos <span class="filter-count" id="countRecebido">0</span>
    </button>
    <button class="status-filter-btn filter-pagar" onclick="filtrarPorStatus('tipo-pagar')">
        üí∏ A Pagar <span class="filter-count" id="countPagar">0</span>
    </button>
    <button class="status-filter-btn filter-receber" onclick="filtrarPorStatus('tipo-receber')">
        üíµ A Receber <span class="filter-count" id="countReceber">0</span>
    </button>
</div>
    
<div class="filter-controls">
    <div class="filter-item-large">
        <label for="buscar" style="margin-bottom: 5px; font-size: 0.8em; color:var(--primary-color);">Buscar Texto</label>
        <input type="text" id="buscar" placeholder="üîç Descri√ß√£o, data ou tipo..." style="width:100%; padding:12px 15px; border-radius:10px;">
    </div>
    
    <div class="filter-item">
        <label for="filtroPeriodo" style="margin-bottom: 5px; font-size: 0.8em;">Per√≠odo Din√¢mico</label>
        <select id="filtroPeriodo" style="padding:10px 15px;">
            <option value="all">Todos os Registros</option>
            <option value="1" selected>Dia Atual</option>
            <option value="2-30">√öltimos 30 Dias (Excluindo o Dia Atual)</option>
            <option value="45">√öltimos 45 Dias</option>
            <option value="60">√öltimos 60 Dias</option>
            <option value="75">√öltimos 75 Dias</option>
            <option value="90">√öltimos 90 Dias</option>
            <option value="120">√öltimos 120 Dias</option>
            <option value="150">√öltimos 150 Dias</option>
            <option value="180">√öltimos 180 Dias</option>
            <option value="customDays">Outra Quantidade de Dias</option>
        </select>
    </div>

    <div class="filter-item" id="customDaysInput" style="display:none;">
        <label for="diasCustomizados" style="margin-bottom: 5px; font-size: 0.8em;">Quantos Dias Retroativos?</label>
        <input type="number" id="diasCustomizados" placeholder="Ex: 250" style="padding:10px 15px; min-width: 150px;">
    </div>

    <div class="filter-item">
        <label for="dataInicio" style="margin-bottom: 5px; font-size: 0.8em;">In√≠cio (Customizado)</label>
        <input type="date" id="dataInicio" style="padding:10px 15px;">
    </div>
    <div class="filter-item">
        <label for="dataFim" style="margin-bottom: 5px; font-size: 0.8em;">Fim (Customizado)</label>
        <input type="date" id="dataFim" style="padding:10px 15px;">
    </div>
    
    <button class="btn-filter" id="btnFiltrarData" style="min-width:120px; height: 45px; padding:10px 20px; align-self:flex-end;">Filtrar Customizado</button>
    
    <button class="btn-filter" id="btnFiltrarFav" style="height: 45px; padding:10px 20px; align-self:flex-end;">‚≠ê Apenas Favoritos</button>
    <button class="btn-primary export-btn" onclick="exportarExcel()" style="width: auto; height: 45px; padding:10px 20px; align-self:flex-end;">üì• Exportar Excel</button>
</div>

<div class="filter-summary" id="periodSummary">
    <span>Per√≠odo Filtrado:</span>
    <span>Total Pagar: <span class="summary-value-pagar" id="summaryPagar"></span></span>
    <span>Total Receber: <span class="summary-value-receber" id="summaryReceber"></span></span>
    <span>Saldo Per√≠odo: <span class="summary-value-saldo" id="summarySaldo"></span></span>
</div>

<table id="tabelaFinance">
<thead>
<tr>
<th>Fav</th>
<th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>Status</th><th>Campos</th><th>A√ß√µes</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="content" style="grid-template-columns: 1fr 1fr;">
    <div class="chart-section">
        <h2>üìà Gastos por Dia (√öltimos 7 dias)</h2>
        <canvas id="graficoDiario"></canvas>
    </div>

    <div class="chart-section">
        <h2>üìâ Gastos Mensais por Categoria (√öltimos 12 meses)</h2>
        <canvas id="graficoMensal"></canvas>
    </div>
</div>

</div>

<script>
let registros = [];
let chart;
let chartDiario;
let chartMensal;
let mostraApenasFav = false;
let usuarioAutenticado = false;
let currentTheme = localStorage.getItem('theme') || 'dark';
let filtroStatusAtual = 'todos';

let metaTipo = localStorage.getItem('metaTipo') || 'mensal';
let metaValor = parseFloat(localStorage.getItem('metaValor')) || 5000;

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxCkEbskP0tA-4Ii_9v1wS7z2_9yHP0nn-_GroK_Z4paEiurRMz6Iole6902c00FR-Q/exec";

const SENHA_ACESSO = "minhasenha123";

const formatarMoeda = valor => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);

function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', currentTheme);
    applyTheme();
}

function applyTheme() {
    document.documentElement.setAttribute('data-theme', currentTheme);
    const themeButton = document.querySelector('.theme-toggle-btn');
    if (currentTheme === 'light') {
        themeButton.innerHTML = 'üåô Modo Noturno';
        if(chart) atualizarGraficos(registros); 
    } else {
        themeButton.innerHTML = '‚òÄÔ∏è Modo Diurno';
        if(chart) atualizarGraficos(registros); 
    }
}

function fazerLogin() {
  const senha = document.getElementById("senhaInput").value;
  const erroDiv = document.getElementById("erroSenha");
  
  if(senha === SENHA_ACESSO) {
    usuarioAutenticado = true;
    sessionStorage.setItem("autenticado", "true");
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainContainer").style.display = "block";
    carregarRegistros();
    erroDiv.innerText = "";
  } else {
    erroDiv.innerText = "‚ùå Senha incorreta! Tente novamente.";
    document.getElementById("senhaInput").value = "";
  }
}

function verificarAutenticacao() {
  if(sessionStorage.getItem("autenticado") === "true") {
    usuarioAutenticado = true;
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainContainer").style.display = "block";
  }
}

function corrigirData(dataInput) {
  const data = new Date(dataInput + 'T12:00:00'); 
  const ano = data.getFullYear();
  const mes = String(data.getMonth() + 1).padStart(2, '0');
  const dia = String(data.getDate()).padStart(2, '0');
  return `${ano}-${mes}-${dia}`;
}

function mostrarLoading(show) {
  const loading = document.getElementById("loading");
  if(show) loading.classList.add("show");
  else loading.classList.remove("show");
}

function atualizarStatusSync(sincronizado) {
  const status = document.getElementById("syncStatus");
  const text = document.getElementById("syncText");
  
  if(sincronizado) {
    status.classList.remove("offline");
    text.innerText = "‚úì Sincronizado";
  } else {
    status.classList.add("offline");
    text.innerText = "‚ö† Offline - Dados locais";
  }
}

function atualizarCardsGlobais(dataList) {
    let totalPagarGlobal=0,totalReceberGlobal=0;
    let gastoHojeGlobal = 0, gastoMesGlobal = 0;
    let totalVencidos = 0;
    let vencemSeteDias = 0;
    
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const hojeStr = hoje.toISOString().split('T')[0];
    const limiteSeteDias = new Date(hoje);
    limiteSeteDias.setDate(hoje.getDate() + 7);

    const mesAtual = new Date().getMonth();
    const anoAtual = new Date().getFullYear();

    dataList.forEach(r => {
        const dataRegistro = new Date(r.data + 'T12:00:00'); 
        const valor = parseFloat(r.valor);

        if(r.tipo==="Pagar" && r.status==="Pendente") totalPagarGlobal += valor;
        if(r.tipo==="Receber" && r.status==="Pendente") totalReceberGlobal += valor;
        
        if(r.data === hojeStr && r.tipo==="Pagar") {
            gastoHojeGlobal += valor;
        }
        
        if(dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual && r.tipo==="Pagar") {
            gastoMesGlobal += valor;
        }
        
        if(r.tipo==="Pagar" && r.status==="Pendente") {
            if (dataRegistro < hoje) {
                totalVencidos += valor;
            }
            if (dataRegistro >= hoje && dataRegistro <= limiteSeteDias) {
                 vencemSeteDias += valor;
            }
        }
    });

    document.getElementById("totalPagar").innerText=formatarMoeda(totalPagarGlobal);
    document.getElementById("totalReceber").innerText=formatarMoeda(totalReceberGlobal);
    document.getElementById("totalDia").innerText=formatarMoeda(totalReceberGlobal-totalPagarGlobal);
    document.getElementById("gastoHoje").innerText=formatarMoeda(gastoHojeGlobal);
    document.getElementById("gastoMes").innerText=formatarMoeda(gastoMesGlobal);
    document.getElementById("totalVencidos").innerText=formatarMoeda(totalVencidos);
    document.getElementById("vencemSeteDias").innerText=formatarMoeda(vencemSeteDias);
    
    atualizarCardMeta(gastoHojeGlobal, gastoMesGlobal);
    atualizarContadoresFiltros(dataList);
}

function mostrarRegistros(lista){
  const tbody = document.querySelector("#tabelaFinance tbody");
  tbody.innerHTML="";
  
  atualizarCardsGlobais(registros);
  
  lista.forEach(r=>{
    const tr=document.createElement("tr");
    const tipoBadge=r.tipo==="Pagar"?"badge-pagar":"badge-receber";
    const statusBadge=r.status==="Pendente"?"badge-pendente":(r.status==="Pago"||r.status==="Recebido")?"badge-pago":"badge-pendente";
    const starClass = r.fav ? "star" : "star-empty";
    
    tr.innerHTML=`
      <td><span class="${starClass}" onclick="toggleFav(${r.row})" style="cursor:pointer;">‚òÖ</span></td>
      <td>${new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
      <td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
      <td>${r.descricao}</td>
      <td>${r.categoria || '-'}</td>
      <td><strong>${formatarMoeda(parseFloat(r.valor))}</strong></td>
      <td><span class="badge ${statusBadge}" onclick="mudarStatus(${r.row})" style="cursor:pointer;">${r.status}</span></td>
      <td>${r.campo2||'-'} ${r.campo3||''}</td>
      <td>
        <div class="actions">
          <button class="btn-edit" onclick="editar(${r.row})">Editar</button>
          <button class="btn-danger" onclick="excluir(${r.row})">Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  atualizarGraficos(registros); 
}

function atualizarGraficos(dataList){
  const fontColor = currentTheme === 'light' ? '#333333' : '#e0e0e0';
  const gridColor = currentTheme === 'light' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
  
  const pagar=dataList.filter(r=>r.tipo==="Pagar" && r.status==="Pendente").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  const receber=dataList.filter(r=>r.tipo==="Receber" && r.status==="Pendente").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  
  const ctx=document.getElementById('graficoTipo').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['A Pagar','A Receber'],
      datasets:[{
        data:[pagar,receber],
        backgroundColor:['#ff6b9d','#26de81'],
        borderColor: currentTheme === 'light' ? '#ffffff' : '#1f1f2e',
        borderWidth:3
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom',labels:{color:fontColor,font:{size:12,weight:'bold'}}}
      }
    }
  });
  
  const gastosPorDia = {};
  const hoje = new Date();
  
  for(let i = 6; i >= 0; i--) {
    const data = new Date(hoje);
    data.setDate(data.getDate() - i);
    const chave = data.toISOString().split('T')[0];
    gastosPorDia[chave] = 0;
  }
  
  dataList.forEach(r => {
    if(r.tipo==="Pagar") {
      if(gastosPorDia.hasOwnProperty(r.data)) {
        gastosPorDia[r.data] += parseFloat(r.valor);
      }
    }
  });
  
  const diasLabels = Object.keys(gastosPorDia).map(d => new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'}));
  const diasValores = Object.values(gastosPorDia);
  
  const ctxDiario = document.getElementById('graficoDiario').getContext('2d');
  if(chartDiario) chartDiario.destroy();
  chartDiario = new Chart(ctxDiario, {
    type: 'line',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Gastos Di√°rios',
        data: diasValores,
        borderColor: '#ff6b9d',
        backgroundColor: 'rgba(255, 107, 157, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#ff6b9d',
        pointBorderColor: currentTheme === 'light' ? '#333' : '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 12, weight: 'bold'}}}
      },
      scales: {
        y: {beginAtZero: true, ticks: {color: fontColor}, grid: {color: gridColor}},
        x: {ticks: {color: fontColor}, grid: {color: gridColor}}
      }
    }
  });
  
  const gastosPorMesECategoria = {};
  const categorias = ["Alimenta√ß√£o", "Moradia/Aluguel", "Transporte", "Lazer", "Sa√∫de", "Educa√ß√£o", "Outros"];
  const mesesLabels = [];

  const hojeMes = new Date().getMonth();
  const hojeAno = new Date().getFullYear();
  
  for(let i = 0; i < 12; i++) {
    const mes = (hojeMes - i + 12) % 12;
    const ano = hojeAno - Math.floor((hojeMes - i) / 12);
    const nomeMes = new Date(ano, mes, 1).toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
    mesesLabels.push(nomeMes);
    gastosPorMesECategoria[nomeMes] = {};
    categorias.forEach(cat => gastosPorMesECategoria[nomeMes][cat] = 0);
  }
  mesesLabels.reverse();

  dataList.forEach(r => {
    if(r.tipo==="Pagar" && categorias.includes(r.categoria)) {
      const dataParse = new Date(r.data);
      const nomeMes = dataParse.toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
      if(gastosPorMesECategoria.hasOwnProperty(nomeMes)) {
        gastosPorMesECategoria[nomeMes][r.categoria] += parseFloat(r.valor);
      }
    }
  });

  const categoryColors = {
      "Alimenta√ß√£o": "#ff6384", "Moradia/Aluguel": "#36a2eb", "Transporte": "#ff9f40", 
      "Lazer": "#4bc0c0", "Sa√∫de": "#9966ff", "Educa√ß√£o": "#ffcd56", "Outros": "#c9cbcf"
  };

  const datasets = categorias.map(cat => ({
      label: cat,
      data: mesesLabels.map(mes => gastosPorMesECategoria[mes][cat]),
      backgroundColor: categoryColors[cat]
  }));
  
  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  if(chartMensal) chartMensal.destroy();
  chartMensal = new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: mesesLabels,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 12, weight: 'bold'}}},
        title: {display: true, text: 'Total Gasto por Categoria/M√™s', color: fontColor}
      },
      scales: {
        x: {stacked: true, ticks: {color: fontColor}, grid: {color: gridColor}},
        y: {stacked: true, beginAtZero: true, ticks: {color: fontColor}, grid: {color: gridColor}}
      }
    }
  });
}

async function enviarParaPlanilha(dados){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify(dados)
    });
    const result = await resp.json();
    atualizarStatusSync(true);
    mostrarLoading(false);
    return result;
  }catch(e){
    console.error("Erro ao sincronizar:",e);
    atualizarStatusSync(false);
    mostrarLoading(false);
    alert("‚ö†Ô∏è Erro ao sincronizar. Verifique sua conex√£o e a URL do Web App.");
  }
}

async function carregarRegistros(){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify({action:'get'})
    });
    const data = await resp.json();
    
    if(Array.isArray(data)) {
      registros = data.map((r, idx) => ({
          ...r, 
          row: idx + 1, 
          fav: r.fav || false,
          categoria: r.campo1 || r.categoria || 'Outros',
          campo1: r.campo1 || r.categoria || 'Outros'
      }));
      atualizarStatusSync(true);
      aplicarFiltros(); 
      console.log("‚úì Carregados " + registros.length + " registros");
    }
  }catch(e){
    console.error("Erro ao carregar:",e);
    atualizarStatusSync(false);
  }
  mostrarLoading(false);
}

document.getElementById("financeForm").addEventListener("submit",function(e){
  e.preventDefault();
  const data=corrigirData(document.getElementById("data").value);
  const tipo=document.getElementById("tipo").value;
  const descricao=document.getElementById("descricao").value;
  const valor=document.getElementById("valor").value;
  const status=document.getElementById("status").value;
  const categoria=document.getElementById("categoria").value;
  const campo2=document.getElementById("campo2").value;
  const campo3=document.getElementById("campo3").value;
  
  if(!data||!tipo||!descricao||!valor||!status||!categoria){alert("Preencha todos os campos obrigat√≥rios!"); return;}
  
  const row=document.getElementById("row").value;
  const sheetRowId=document.getElementById("sheetRowId").value;
  
  const dadosRegistro = {data,tipo,descricao,valor,status,campo1:categoria,campo2,campo3,categoria,fav:false};

  if(row){
    const idx = registros.findIndex(r=>r.id == sheetRowId);
    if(idx !== -1) {
      registros[idx]={...registros[idx],...dadosRegistro, row:parseInt(row)};
      enviarParaPlanilha({...registros[idx],action:'update'});
    }
    document.getElementById("row").value="";
    document.getElementById("sheetRowId").value="";
  }else{
    const novoRegistro = {...dadosRegistro, row: registros.length + 1};
    registros.push(novoRegistro);
    enviarParaPlanilha({...novoRegistro,action:'add'});
  }
  
  this.reset();
  document.getElementById("data").valueAsDate=new Date();
  mostraApenasFav = false;
  document.getElementById("btnFiltrarFav").classList.remove("active");
  aplicarFiltros(); 
  document.getElementById("descricao").focus();
});

document.getElementById("filtroPeriodo").addEventListener("change", function() {
    const customDaysInput = document.getElementById("customDaysInput");
    if (this.value === 'customDays') {
        customDaysInput.style.display = 'block';
    } else {
        customDaysInput.style.display = 'none';
        document.getElementById("diasCustomizados").value = '';
    }
    aplicarFiltros();
});

document.getElementById("diasCustomizados").addEventListener("input", aplicarFiltros);

function aplicarFiltros() {
    const termo = document.getElementById("buscar").value.toLowerCase();
    const periodoSelecionado = document.getElementById("filtroPeriodo").value; 
    let dataInicioStr = document.getElementById("dataInicio").value;
    let dataFimStr = document.getElementById("dataFim").value;
    const diasCustomizados = document.getElementById("diasCustomizados").value;
    const summaryDiv = document.getElementById("periodSummary");
    
    let filtrados = registros;
    let totalPagarPeriodo = 0;
    let totalReceberPeriodo = 0;
    let dataFiltroAtivo = false;

    let dataInicioFiltro, dataFimFiltro;

    if (periodoSelecionado !== 'all') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); 
        dataFimFiltro = new Date();
        dataFimFiltro.setHours(23, 59, 59, 999); 

        if (periodoSelecionado === '1') {
            dataInicioFiltro = hoje;
        } else if (periodoSelecionado === '2-30') {
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - 30);
            dataInicioFiltro = inicio; 
            
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1); 
            dataFimFiltro = new Date(ontem.toISOString().split('T')[0] + 'T23:59:59'); 

        } else if (periodoSelecionado === 'customDays' && diasCustomizados) {
            const dias = parseInt(diasCustomizados);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            } else {
                dataFiltroAtivo = false;
            }
        }
        else {
            const dias = parseInt(periodoSelecionado);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1)); 
            }
        }
        
        if (dataInicioFiltro && dataFimFiltro) {
            dataFiltroAtivo = true; 
        }
        
        dataInicioStr = '';
        dataFimStr = '';
    }
    
    if (dataInicioStr && dataFimStr) {
        dataInicioFiltro = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        dataFimFiltro = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
        dataFiltroAtivo = true;
    }

    if (dataFiltroAtivo) {
        filtrados = filtrados.filter(r => {
            const dataRegistro = new Date(r.data + 'T12:00:00'); 
            return dataRegistro >= dataInicioFiltro && dataRegistro <= dataFimFiltro;
        });
    }

    if (filtroStatusAtual !== 'todos') {
        if (filtroStatusAtual === 'tipo-pagar') {
            filtrados = filtrados.filter(r => r.tipo === 'Pagar');
        } else if (filtroStatusAtual === 'tipo-receber') {
            filtrados = filtrados.filter(r => r.tipo === 'Receber');
        } else {
            filtrados = filtrados.filter(r => r.status === filtroStatusAtual);
        }
    }

    if (mostraApenasFav) {
        filtrados = filtrados.filter(r => r.fav);
    }

    if (termo) {
        filtrados = filtrados.filter(r => 
            r.descricao.toLowerCase().includes(termo) || 
            r.tipo.toLowerCase().includes(termo) || 
            r.categoria.toLowerCase().includes(termo) ||
            r.data.includes(termo)
        );
    }
    
    totalPagarPeriodo = filtrados.filter(r => r.tipo === "Pagar").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    totalReceberPeriodo = filtrados.filter(r => r.tipo === "Receber").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    
    if (dataFiltroAtivo || mostraApenasFav || termo || filtroStatusAtual !== 'todos') {
        document.getElementById("summaryPagar").innerText = formatarMoeda(totalPagarPeriodo);
        document.getElementById("summaryReceber").innerText = formatarMoeda(totalReceberPeriodo);
        document.getElementById("summarySaldo").innerText = formatarMoeda(totalReceberPeriodo - totalPagarPeriodo);
        summaryDiv.style.display = 'flex';
    } else {
        summaryDiv.style.display = 'none';
    }

    mostrarRegistros(filtrados);
}

document.getElementById("buscar").addEventListener("input", aplicarFiltros);
document.getElementById("btnFiltrarData").addEventListener("click", aplicarFiltros);

document.getElementById("btnFiltrarFav").addEventListener("click", function(){
  mostraApenasFav = !mostraApenasFav;
  this.classList.toggle("active");
  aplicarFiltros();
});

function atualizarContadoresFiltros(dataList) {
    const countTodos = dataList.length;
    const countPendente = dataList.filter(r => r.status === "Pendente").length;
    const countPago = dataList.filter(r => r.status === "Pago").length;
    const countRecebido = dataList.filter(r => r.status === "Recebido").length;
    const countPagar = dataList.filter(r => r.tipo === "Pagar").length;
    const countReceber = dataList.filter(r => r.tipo === "Receber").length;
    
    document.getElementById("countTodos").innerText = countTodos;
    document.getElementById("countPendente").innerText = countPendente;
    document.getElementById("countPago").innerText = countPago;
    document.getElementById("countRecebido").innerText = countRecebido;
    document.getElementById("countPagar").innerText = countPagar;
    document.getElementById("countReceber").innerText = countReceber;
}

function filtrarPorStatus(tipo) {
    filtroStatusAtual = tipo;
    
    document.querySelectorAll('.status-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if(tipo === 'todos') {
        document.querySelector('.filter-todos').classList.add('active');
    } else if(tipo === 'Pendente') {
        document.querySelector('.filter-pendente').classList.add('active');
    } else if(tipo === 'Pago') {
        document.querySelector('.filter-pago').classList.add('active');
    } else if(tipo === 'Recebido') {
        document.querySelector('.filter-recebido').classList.add('active');
    } else if(tipo === 'tipo-pagar') {
        document.querySelector('.filter-pagar').classList.add('active');
    } else if(tipo === 'tipo-receber') {
        document.querySelector('.filter-receber').classList.add('active');
    }
    
    aplicarFiltros();
}

function atualizarCardMeta(gastoHoje, gastoMes) {
    const label = metaTipo === 'diario' ? 'Meta de Gastos (Dia)' : 'Meta de Gastos (M√™s)';
    const gastoAtual = metaTipo === 'diario' ? gastoHoje : gastoMes;
    const percentual = metaValor > 0 ? (gastoAtual / metaValor * 100) : 0;
    
    document.getElementById("metaLabel").innerText = label;
    document.getElementById("metaValor").innerText = formatarMoeda(metaValor);
    document.getElementById("metaPercentual").innerText = `${percentual.toFixed(1)}% utilizado (${formatarMoeda(gastoAtual)} de ${formatarMoeda(metaValor)})`;
    
    const progressBar = document.getElementById("metaProgress");
    progressBar.style.width = Math.min(percentual, 100) + '%';
    
    progressBar.classList.remove('warning', 'danger');
    if(percentual >= 90) {
        progressBar.classList.add('danger');
    } else if(percentual >= 70) {
        progressBar.classList.add('warning');
    }
}

function editarMeta() {
    const tipoAtual = metaTipo === 'diario' ? 'Di√°rio' : 'Mensal';
    const novoTipo = prompt(`Tipo de Meta Atual: ${tipoAtual}\n\nDigite:\n1 - Para Meta Di√°ria\n2 - Para Meta Mensal`, metaTipo === 'diario' ? '1' : '2');
    
    if(novoTipo === '1') {
        metaTipo = 'diario';
    } else if(novoTipo === '2') {
        metaTipo = 'mensal';
    } else if(novoTipo !== null) {
        alert('Op√ß√£o inv√°lida! Use 1 para Di√°rio ou 2 para Mensal.');
        return;
    } else {
        return;
    }
    
    const novoValor = prompt(`Meta de Gastos ${metaTipo === 'diario' ? 'Di√°ria' : 'Mensal'}:\n\nValor Atual: R$ ${metaValor.toFixed(2)}\n\nDigite o novo valor (ex: 5000):`, metaValor);
    
    if(novoValor !== null) {
        const valorParseado = parseFloat(novoValor.replace(',', '.'));
        if(!isNaN(valorParseado) && valorParseado > 0) {
            metaValor = valorParseado;
            localStorage.setItem('metaTipo', metaTipo);
            localStorage.setItem('metaValor', metaValor);
            
            const hoje = new Date();
            const hojeStr = hoje.toISOString().split('T')[0];
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            let gastoHoje = 0, gastoMes = 0;
            registros.forEach(r => {
                const dataRegistro = new Date(r.data + 'T12:00:00');
                const valor = parseFloat(r.valor);
                if(r.data === hojeStr && r.tipo === "Pagar") gastoHoje += valor;
                if(dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual && r.tipo === "Pagar") gastoMes += valor;
            });
            
            atualizarCardMeta(gastoHoje, gastoMes);
            alert(`‚úÖ Meta ${metaTipo === 'diario' ? 'Di√°ria' : 'Mensal'} atualizada para ${formatarMoeda(metaValor)}`);
        } else {
            alert('‚ùå Valor inv√°lido! Digite um n√∫mero positivo.');
        }
    }
}

function mudarStatus(row) {
  const registro = registros.find(r => r.row === row);
  if(!registro) return;
  
  let novoStatus = registro.status;
  if(registro.status === "Pendente") {
    novoStatus = registro.tipo === "Pagar" ? "Pago" : "Recebido";
  } else {
    novoStatus = "Pendente";
  }
  
  registro.status = novoStatus;
  enviarParaPlanilha({...registro, action:'update'});
  aplicarFiltros(); 
}

function exportarExcel(){
  const termo = document.getElementById("buscar").value.toLowerCase();
  const periodoSelecionado = document.getElementById("filtroPeriodo").value; 
  let dataInicioStr = document.getElementById("dataInicio").value;
  let dataFimStr = document.getElementById("dataFim").value;
  const diasCustomizados = document.getElementById("diasCustomizados").value;
  
  let listaExportar = registros;
  let dataFiltroAtivo = false;
  let dataInicioFiltro, dataFimFiltro;

  if (periodoSelecionado !== 'all') {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0); 
      dataFimFiltro = new Date();
      dataFimFiltro.setHours(23, 59, 59, 999);

        if (periodoSelecionado === '1') {
            dataInicioFiltro = hoje;
        } else if (periodoSelecionado === '2-30') {
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - 30);
            dataInicioFiltro = inicio; 
            
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1); 
            dataFimFiltro = new Date(ontem.toISOString().split('T')[0] + 'T23:59:59'); 
        } else if (periodoSelecionado === 'customDays' && diasCustomizados) {
            const dias = parseInt(diasCustomizados);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            } else {
                dataFiltroAtivo = false;
            }
        } else {
            const dias = parseInt(periodoSelecionado);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1)); 
            }
        }
        
        if (dataInicioFiltro && dataFimFiltro) {
            dataFiltroAtivo = true;
        }
  }
  
  if (dataInicioStr && dataFimStr) {
      dataInicioFiltro = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
      dataFimFiltro = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
      dataFiltroAtivo = true;
  }
  
  if (dataFiltroAtivo) {
      listaExportar = listaExportar.filter(r => {
          const dataRegistro = new Date(r.data + 'T12:00:00'); 
          return dataRegistro >= dataInicioFiltro && dataRegistro <= dataFimFiltro;
      });
  }

  if (filtroStatusAtual !== 'todos') {
      if (filtroStatusAtual === 'tipo-pagar') {
          listaExportar = listaExportar.filter(r => r.tipo === 'Pagar');
      } else if (filtroStatusAtual === 'tipo-receber') {
          listaExportar = listaExportar.filter(r => r.tipo === 'Receber');
      } else {
          listaExportar = listaExportar.filter(r => r.status === filtroStatusAtual);
      }
  }

  if (mostraApenasFav) {
      listaExportar = listaExportar.filter(r => r.fav);
  }

  if (termo) {
      listaExportar = listaExportar.filter(r => 
          r.descricao.toLowerCase().includes(termo) || 
          r.tipo.toLowerCase().includes(termo) || 
          r.categoria.toLowerCase().includes(termo) ||
          r.data.includes(termo)
      );
  }
  
  const ws_data=listaExportar.map(r=>[
    r.fav?"‚òÖ":"",
    new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR'),
    r.tipo,
    r.descricao,
    r.categoria || '-',
    r.valor,
    r.status,
    r.campo2||'',
    r.campo3||''
  ]);

  ws_data.unshift(["Fav","Data","Tipo","Descri√ß√£o","Categoria","Valor","Status","Campo2","Campo3"]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Financeiro");
  XLSX.writeFile(wb,"Controle_Financeiro.xlsx");
}

function editar(row){
  const r=registros.find(r=>r.row===row);
  if(r){
    document.getElementById("row").value=r.row;
    document.getElementById("sheetRowId").value=r.id;
    document.getElementById("data").value=r.data;
    document.getElementById("tipo").value=r.tipo;
    document.getElementById("descricao").value=r.descricao;
    document.getElementById("valor").value=r.valor;
    document.getElementById("status").value=r.status;
    document.getElementById("categoria").value=r.categoria || r.campo1 || '';
    document.getElementById("campo2").value=r.campo2||'';
    document.getElementById("campo3").value=r.campo3||'';
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

function excluir(row){
  if(confirm("Deseja excluir este registro?")){
    const r = registros.find(r=>r.row===row);
    const idx = registros.findIndex(r=>r.row===row);
    enviarParaPlanilha({...r,action:'delete'});
    registros.splice(idx,1);
    mostraApenasFav = false;
    document.getElementById("btnFiltrarFav").classList.remove("active");
    aplicarFiltros();
  }
}

function toggleFav(row){
  const idx = registros.findIndex(r=>r.row===row);
  registros[idx].fav=!registros[idx].fav;
  enviarParaPlanilha({...registros[idx],action:'update'});
  aplicarFiltros();
}

document.addEventListener('keydown', (e) => {
    if (usuarioAutenticado) {
        if (e.key === '+' || e.key.toLowerCase() === 'n') {
            e.preventDefault();
            document.getElementById("descricao").focus();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    }
});

document.getElementById("data").valueAsDate=new Date();
verificarAutenticacao();
applyTheme();

setInterval(() => {
  if(usuarioAutenticado) {
    carregarRegistros();
    console.log("‚Üª Sincronizando...");
  }
}, 10000);
</script>

</body>
</html>

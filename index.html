<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background:linear-gradient(135deg,#1e1e2e 0%,#2a2a3e 100%);
  padding:20px; 
  color:#e0e0e0;
  min-height:100vh;
}
.container { max-width:1400px; margin:0 auto; }
header { text-align:center; margin-bottom:40px; }
header h1 { 
  font-size:2.5em; 
  color:#fff; 
  font-weight:700;
  letter-spacing:-1px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
}
.sync-status {
  background:rgba(38,222,129,0.2);
  border:1px solid rgba(38,222,129,0.5);
  color:#26de81;
  padding:10px 15px;
  border-radius:10px;
  font-size:0.9em;
  margin-bottom:20px;
  display:flex;
  align-items:center;
  gap:10px;
  width:fit-content;
  margin-left:auto;
  margin-right:auto;
}
.sync-status.offline {
  background:rgba(255,107,157,0.2);
  border-color:rgba(255,107,157,0.5);
  color:#ff6b9d;
}
.sync-status .dot {
  width:10px;
  height:10px;
  border-radius:50%;
  background:#26de81;
  animation:pulse 2s infinite;
}
.sync-status.offline .dot {
  background:#ff6b9d;
  animation:none;
}
@keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.5; } }
.cards-summary { 
  display:grid; 
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); 
  gap:20px; 
  margin-bottom:30px; 
}
.card { 
  background:linear-gradient(135deg,#2a2a3e 0%,#1f1f2e 100%);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  transition:transform 0.3s ease,box-shadow 0.3s ease;
  backdrop-filter:blur(10px);
}
.card:hover { 
  transform:translateY(-5px); 
  box-shadow:0 15px 50px rgba(0,0,0,0.4);
}
.card-label { 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:10px; 
  text-transform:uppercase; 
  letter-spacing:1px;
  font-weight:600;
}
.card-value { 
  font-size:2em; 
  font-weight:700;
  letter-spacing:-1px;
}
.card-pagar .card-value { color:#ff6b9d; }
.card-receber .card-value { color:#26de81; }
.card-saldo .card-value { color:#4a90e2; }
.content { 
  display:grid; 
  grid-template-columns:1fr 1fr; 
  gap:25px; 
  margin-bottom:30px; 
}
.form-section, .chart-section, .table-section { 
  background:linear-gradient(135deg,#2a2a3e 0%,#1f1f2e 100%);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
}
.form-section h2, .chart-section h2, .table-section h2 { 
  font-size:1.4em; 
  margin-bottom:20px;
  color:#fff;
  font-weight:700;
}
.form-group { margin-bottom:15px; }
label { 
  display:block; 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:8px; 
  text-transform:uppercase; 
  font-weight:600;
  letter-spacing:0.5px;
}
input, select { 
  width:100%; 
  padding:12px 15px; 
  border:1px solid rgba(255,255,255,0.2); 
  border-radius:10px; 
  background:rgba(255,255,255,0.05);
  color:#fff;
  font-size:1em;
  transition:all 0.3s ease;
}
input:focus, select:focus { 
  outline:none;
  border-color:#4a90e2;
  background:rgba(255,255,255,0.1);
  box-shadow:0 0 20px rgba(74,144,226,0.3);
}
button { 
  padding:12px 24px; 
  border:none; 
  border-radius:10px; 
  cursor:pointer; 
  font-weight:600;
  font-size:1em;
  transition:all 0.3s ease;
}
.btn-primary { 
  background:linear-gradient(135deg,#4a90e2 0%,#357abd 100%);
  color:white; 
  width:100%; 
}
.btn-primary:hover { 
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(74,144,226,0.4);
}
.btn-danger { 
  background:linear-gradient(135deg,#ff6b9d 0%,#d63447 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-edit { 
  background:linear-gradient(135deg,#26de81 0%,#1bb366 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-filter {
  background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%);
  color:white;
  padding:10px 20px;
  margin-bottom:0; /* Ajustado para alinhamento */
  font-size:0.95em;
  width: auto;
}
.btn-filter.active {
  background:linear-gradient(135deg,#ff6b9d 0%,#d63447 100%);
}
.search-bar { margin-bottom:15px; }
.search-bar input { width:100%; }
table { width:100%; border-collapse:collapse; }
th { 
  padding:15px 10px; 
  text-align:left; 
  background:rgba(255,255,255,0.05);
  border-bottom:2px solid rgba(255,255,255,0.1);
  font-weight:700;
  color:#fff;
  font-size:0.95em;
}
td { 
  padding:15px 10px; 
  border-bottom:1px solid rgba(255,255,255,0.05); 
}
tr:hover { background:rgba(255,255,255,0.05); }
.badge { 
  padding:6px 12px; 
  border-radius:20px; 
  font-size:0.8em; 
  font-weight:700; 
  text-transform:uppercase;
  letter-spacing:0.5px;
  display:inline-block;
}
.badge-pagar { 
  background:rgba(255,107,157,0.2); 
  color:#ff6b9d; 
  border:1px solid rgba(255,107,157,0.5);
}
.badge-receber { 
  background:rgba(38,222,129,0.2); 
  color:#26de81; 
  border:1px solid rgba(38,222,129,0.5);
}
.badge-pendente { 
  background:rgba(255,193,7,0.2); 
  color:#ffc107; 
  border:1px solid rgba(255,193,7,0.5);
}
.badge-pago { 
  background:rgba(38,222,129,0.2); 
  color:#26de81; 
  border:1px solid rgba(38,222,129,0.5);
}
.actions { 
  display:flex; 
  gap:8px;
}
.export-btn { margin-bottom:15px; }
.star { 
  color:#ffc107; 
  font-size:1.3em; 
  cursor:pointer;
  transition:all 0.3s ease;
}
.star:hover { 
  transform:scale(1.2);
  text-shadow:0 0 10px rgba(255,193,7,0.6);
}
.star-empty { 
  color:rgba(255,255,255,0.2); 
  font-size:1.3em; 
  cursor:pointer;
  transition:all 0.3s ease;
}
.star-empty:hover { 
  color:#ffc107;
  transform:scale(1.2);
}
.loading {
  display:none;
  text-align:center;
  padding:20px;
  color:#4a90e2;
  font-weight:600;
}
.loading.show {
  display:block;
  animation:spin 1s linear infinite;
}
@keyframes spin {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}
.login-overlay {
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.95);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.login-box {
  background:linear-gradient(135deg,#2a2a3e 0%,#1f1f2e 100%);
  border-radius:20px;
  padding:40px;
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
  border:1px solid rgba(255,255,255,0.1);
  max-width:400px;
  width:90%;
  text-align:center;
}
.login-box h2 {
  color:#fff;
  margin-bottom:30px;
  font-size:2em;
}
.login-box input {
  width:100%;
  padding:15px;
  margin-bottom:20px;
  border:1px solid rgba(255,255,255,0.2);
  border-radius:10px;
  background:rgba(255,255,255,0.05);
  color:#fff;
  font-size:1.1em;
}
.login-box button {
  width:100%;
  padding:15px;
  background:linear-gradient(135deg,#4a90e2 0%,#357abd 100%);
  color:white;
  border:none;
  border-radius:10px;
  font-size:1.1em;
  font-weight:600;
  cursor:pointer;
}
.login-box button:hover {
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(74,144,226,0.4);
}
.erro-senha {
  color:#ff6b9d;
  margin-top:10px;
  font-size:0.9em;
}
.filter-controls {
    display:flex; 
    gap:10px; 
    margin-bottom:15px; 
    flex-wrap:wrap; 
    align-items:flex-end;
}
.filter-item {
    min-width:150px;
    flex: 1;
}
.filter-item-large {
    flex: 2;
    min-width: 250px;
}
@media(max-width:768px){
  .content{ grid-template-columns:1fr; }
  header h1 { font-size:1.8em; }
  .card-value { font-size:1.5em; }
  table { font-size:0.9em; }
  th, td { padding:10px 5px; }
  .filter-controls > div {
      min-width: 100%;
  }
}
</style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>ğŸ” Acesso Restrito</h2>
    <p style="color:#b0b0b0; margin-bottom:20px;">Digite a senha para acessar o sistema</p>
    <input type="password" id="senhaInput" placeholder="Digite sua senha" onkeypress="if(event.key==='Enter') fazerLogin()">
    <button onclick="fazerLogin()">ğŸ”“ Entrar</button>
    <div class="erro-senha" id="erroSenha"></div>
  </div>
</div>

<div class="container" id="mainContainer" style="display:none;">
<header>
<h1>ğŸ’° Controle Financeiro</h1>
<div class="sync-status" id="syncStatus">
  <div class="dot"></div>
  <span id="syncText">Sincronizado</span>
</div>
</header>

<div class="cards-summary">
<div class="card card-pagar"><div class="card-label">Total a Pagar</div><div class="card-value" id="totalPagar">R$ 0,00</div></div>
<div class="card card-receber"><div class="card-label">Total a Receber</div><div class="card-value" id="totalReceber">R$ 0,00</div></div>
<div class="card card-saldo"><div class="card-label">Saldo do Dia</div><div class="card-value" id="totalDia">R$ 0,00</div></div>
<div class="card card-pagar"><div class="card-label">Gasto Hoje</div><div class="card-value" id="gastoHoje">R$ 0,00</div></div>
<div class="card card-pagar"><div class="card-label">Gasto este MÃªs</div><div class="card-value" id="gastoMes">R$ 0,00</div></div>
</div>

<div class="content">
<div class="form-section">
<h2>ğŸ“ Novo Registro</h2>
<form id="financeForm">
<input type="hidden" id="row">
<input type="hidden" id="sheetRowId">

<div class="form-group">
<label for="data">Data</label>
<input type="date" id="data" required>
</div>

<div class="form-group">
<label for="tipo">Tipo</label>
<select id="tipo" required>
<option value="Pagar">Pagar</option>
<option value="Receber">Receber</option>
</select>
</div>

<div class="form-group">
<label for="descricao">DescriÃ§Ã£o</label>
<input type="text" id="descricao" placeholder="Ex: Aluguel, SalÃ¡rio..." required>
</div>

<div class="form-group">
<label for="valor">Valor</label>
<input type="number" id="valor" placeholder="0,00" required step="0.01">
</div>

<div class="form-group">
<label for="status">Status</label>
<select id="status" required>
<option value="Pendente">Pendente</option>
<option value="Pago">Pago</option>
<option value="Recebido">Recebido</option>
</select>
</div>

<div class="form-group">
<label for="campo1">Campo Adicional 1</label>
<input type="text" id="campo1" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo2">Campo Adicional 2</label>
<input type="text" id="campo2" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo3">Campo Adicional 3</label>
<input type="text" id="campo3" placeholder="Opcional">
</div>

<button type="submit" class="btn-primary">ğŸ’¾ Salvar Registro</button>
</form>
</div>

<div class="chart-section">
<h2>ğŸ“Š Resumo Visual</h2>
<canvas id="graficoTipo"></canvas>
</div>
</div>

<div class="content" style="grid-template-columns: 1fr;">
<div class="table-section">
<h2>ğŸ“‹ Registros</h2>
<div class="loading" id="loading">â³ Sincronizando...</div>
    
<div class="filter-controls">
    <div class="filter-item-large">
        <label for="buscar" style="margin-bottom: 5px; font-size: 0.8em; color:#4a90e2;">Buscar Texto</label>
        <input type="text" id="buscar" placeholder="ğŸ” DescriÃ§Ã£o, data ou tipo..." style="width:100%; padding:12px 15px; border:1px solid rgba(255,255,255,0.2); border-radius:10px; background:rgba(255,255,255,0.05); color:#fff;">
    </div>
    
    <div class="filter-item">
        <label for="dataInicio" style="margin-bottom: 5px; font-size: 0.8em;">InÃ­cio</label>
        <input type="date" id="dataInicio" style="padding:10px 15px;">
    </div>
    <div class="filter-item">
        <label for="dataFim" style="margin-bottom: 5px; font-size: 0.8em;">Fim</label>
        <input type="date" id="dataFim" style="padding:10px 15px;">
    </div>
    
    <button class="btn-filter" id="btnFiltrarData" style="min-width:120px; height: 45px; padding:10px 20px; align-self:flex-end;">Filtrar</button>
    
    <button class="btn-filter" id="btnFiltrarFav" style="height: 45px; padding:10px 20px; align-self:flex-end;">â­ Apenas Favoritos</button>
    <button class="btn-primary export-btn" onclick="exportarExcel()" style="width: auto; height: 45px; padding:10px 20px; align-self:flex-end;">ğŸ“¥ Exportar Excel</button>
</div>

<table id="tabelaFinance">
<thead>
<tr>
<th>Fav</th>
<th>Data</th><th>Tipo</th><th>DescriÃ§Ã£o</th><th>Valor</th><th>Status</th><th>Campos</th><th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="content" style="grid-template-columns: 1fr 1fr;">
    <div class="chart-section">
        <h2>ğŸ“ˆ Gastos por Dia (Ãšltimos 7 dias)</h2>
        <canvas id="graficoDiario"></canvas>
    </div>

    <div class="chart-section">
        <h2>ğŸ“‰ Gastos Mensais (Ãšltimos 12 meses)</h2>
        <canvas id="graficoMensal"></canvas>
    </div>
</div>


<script>
let registros = [];
let chart;
let chartDiario;
let chartMensal;
let mostraApenasFav = false; // Corrigido de "mostraApenasHartos" para um nome mais claro
let usuarioAutenticado = false;

// URL DO WEB APP CONFIGURADA
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxCkEbskP0tA-4Ii_9v1wS7z2_9yHP0nn-_GroK_Z4paEiurRMz6Iole6902c00FR-Q/exec";

// CONFIGURE SUA SENHA AQUI (troque por uma senha forte!)
const SENHA_ACESSO = "minhasenha123";

const formatarMoeda = valor => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);

function fazerLogin() {
  const senha = document.getElementById("senhaInput").value;
  const erroDiv = document.getElementById("erroSenha");
  
  if(senha === SENHA_ACESSO) {
    usuarioAutenticado = true;
    sessionStorage.setItem("autenticado", "true");
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainContainer").style.display = "block";
    carregarRegistros();
    erroDiv.innerText = "";
  } else {
    erroDiv.innerText = "âŒ Senha incorreta! Tente novamente.";
    document.getElementById("senhaInput").value = "";
  }
}

function verificarAutenticacao() {
  if(sessionStorage.getItem("autenticado") === "true") {
    usuarioAutenticado = true;
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainContainer").style.display = "block";
  }
}

/**
 * Corrige o problema do fuso horÃ¡rio em inputs de data, 
 * garantindo que a data seja interpretada no fuso local.
 * @param {string} dataInput - String de data no formato YYYY-MM-DD.
 * @returns {string} - String de data no formato YYYY-MM-DD.
 */
function corrigirData(dataInput) {
  // O fuso horÃ¡rio pode causar desvios de 1 dia ao criar a data.
  // Adicionar 'T12:00:00' garante que o objeto Date seja criado 
  // ao meio-dia no fuso local, evitando que fusos negativos joguem 
  // a data para o dia anterior (UTC).
  const data = new Date(dataInput + 'T12:00:00'); 
  const ano = data.getFullYear();
  const mes = String(data.getMonth() + 1).padStart(2, '0');
  const dia = String(data.getDate()).padStart(2, '0');
  return `${ano}-${mes}-${dia}`;
}

function mostrarLoading(show) {
  const loading = document.getElementById("loading");
  if(show) loading.classList.add("show");
  else loading.classList.remove("show");
}

function atualizarStatusSync(sincronizado) {
  const status = document.getElementById("syncStatus");
  const text = document.getElementById("syncText");
  
  if(sincronizado) {
    status.classList.remove("offline");
    text.innerText = "âœ“ Sincronizado";
  } else {
    status.classList.add("offline");
    text.innerText = "âš  Offline - Dados locais";
  }
}

function mostrarRegistros(lista){
  const tbody = document.querySelector("#tabelaFinance tbody");
  tbody.innerHTML="";
  
  // Calcula os totais GLOBAIS para os cards de resumo (baseados em TODOS os registros)
  let totalPagarGlobal=0,totalReceberGlobal=0;
  let gastoHojeGlobal = 0, gastoMesGlobal = 0;
  const hoje = new Date().toISOString().split('T')[0];
  const mesAtual = new Date().getMonth();
  const anoAtual = new Date().getFullYear();
  
  registros.forEach(r => { // Usa 'registros' (global) para os cards de resumo
    if(r.tipo==="Pagar" && r.status==="Pendente") totalPagarGlobal+=parseFloat(r.valor);
    if(r.tipo==="Receber" && r.status==="Pendente") totalReceberGlobal+=parseFloat(r.valor);
    
    // Calcular gastos de hoje (apenas `Pagar`)
    if(r.data === hoje && r.tipo==="Pagar") {
      gastoHojeGlobal += parseFloat(r.valor);
    }
    
    // Calcular gastos do mÃªs (apenas `Pagar`)
    const dataParse = new Date(r.data);
    if(dataParse.getMonth() === mesAtual && dataParse.getFullYear() === anoAtual && r.tipo==="Pagar") {
      gastoMesGlobal += parseFloat(r.valor);
    }
  });
  
  // Atualiza os cards de resumo com os totais GLOBAIS
  document.getElementById("totalPagar").innerText=formatarMoeda(totalPagarGlobal);
  document.getElementById("totalReceber").innerText=formatarMoeda(totalReceberGlobal);
  document.getElementById("totalDia").innerText=formatarMoeda(totalReceberGlobal-totalPagarGlobal);
  document.getElementById("gastoHoje").innerText=formatarMoeda(gastoHojeGlobal);
  document.getElementById("gastoMes").innerText=formatarMoeda(gastoMesGlobal);
  
  // Preenche a tabela com a lista filtrada
  lista.forEach(r=>{
    const tr=document.createElement("tr");
    const tipoBadge=r.tipo==="Pagar"?"badge-pagar":"badge-receber";
    const statusBadge=r.status==="Pendente"?"badge-pendente":(r.status==="Pago"||r.status==="Recebido")?"badge-pago":"badge-pendente";
    const starClass = r.fav ? "star" : "star-empty";
    
    tr.innerHTML=`
      <td><span class="${starClass}" onclick="toggleFav(${r.row})">â˜…</span></td>
      <td>${new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
      <td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
      <td>${r.descricao}</td>
      <td><strong>${formatarMoeda(parseFloat(r.valor))}</strong></td>
      <td><span class="badge ${statusBadge}" onclick="mudarStatus(${r.row})" style="cursor:pointer;">${r.status}</span></td>
      <td>${r.campo1||'-'} ${r.campo2||''} ${r.campo3||''}</td>
      <td>
        <div class="actions">
          <button class="btn-edit" onclick="editar(${r.row})">Editar</button>
          <button class="btn-danger" onclick="excluir(${r.row})">Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  atualizarGraficos(registros); // MantÃ©m os grÃ¡ficos baseados em todos os registros
}

function atualizarGraficos(dataList){
  // A lÃ³gica de grÃ¡ficos foi mantida para usar a lista COMPLETA de registros (dataList)
  // para ter uma visÃ£o geral consistente, independentemente dos filtros da tabela.
  
  const pagar=dataList.filter(r=>r.tipo==="Pagar" && r.status==="Pendente").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  const receber=dataList.filter(r=>r.tipo==="Receber" && r.status==="Pendente").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  
  // GrÃ¡fico Tipo (Pizza)
  const ctx=document.getElementById('graficoTipo').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['A Pagar','A Receber'],
      datasets:[{
        data:[pagar,receber],
        backgroundColor:['#ff6b9d','#26de81'],
        borderColor:'#1f1f2e',
        borderWidth:3
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom',labels:{color:'#e0e0e0',font:{size:12,weight:'bold'}}}
      }
    }
  });
  
  // GrÃ¡fico DiÃ¡rio (Linha - Ãšltimos 7 dias)
  const gastosPorDia = {};
  const hoje = new Date();
  
  for(let i = 6; i >= 0; i--) {
    const data = new Date(hoje);
    data.setDate(data.getDate() - i);
    const chave = data.toISOString().split('T')[0];
    gastosPorDia[chave] = 0;
  }
  
  dataList.forEach(r => {
    if(r.tipo==="Pagar") {
      if(gastosPorDia.hasOwnProperty(r.data)) {
        gastosPorDia[r.data] += parseFloat(r.valor);
      }
    }
  });
  
  const diasLabels = Object.keys(gastosPorDia).map(d => new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'}));
  const diasValores = Object.values(gastosPorDia);
  
  const ctxDiario = document.getElementById('graficoDiario').getContext('2d');
  if(chartDiario) chartDiario.destroy();
  chartDiario = new Chart(ctxDiario, {
    type: 'line',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Gastos DiÃ¡rios',
        data: diasValores,
        borderColor: '#ff6b9d',
        backgroundColor: 'rgba(255, 107, 157, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#ff6b9d',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: '#e0e0e0', font: {size: 12, weight: 'bold'}}}
      },
      scales: {
        y: {beginAtZero: true, ticks: {color: '#b0b0b0'}, grid: {color: 'rgba(255,255,255,0.1)'}},
        x: {ticks: {color: '#b0b0b0'}, grid: {color: 'rgba(255,255,255,0.1)'}}
      }
    }
  });
  
  // GrÃ¡fico Mensal (Coluna - Ãšltimos 12 meses)
  const gastosPorMes = {};
  const hojeMes = new Date().getMonth();
  const hojeAno = new Date().getFullYear();
  
  // Inicializa os Ãºltimos 12 meses
  for(let i = 0; i < 12; i++) {
    const mes = (hojeMes - i + 12) % 12;
    const ano = hojeAno - Math.floor((hojeMes - i) / 12);
    const nomeMes = new Date(ano, mes, 1).toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
    gastosPorMes[nomeMes] = 0;
  }
  
  dataList.forEach(r => {
    if(r.tipo==="Pagar") {
      const dataParse = new Date(r.data);
      const nomeMes = dataParse.toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
      if(gastosPorMes.hasOwnProperty(nomeMes)) {
        gastosPorMes[nomeMes] += parseFloat(r.valor);
      }
    }
  });
  
  const labelsMeses = Object.keys(gastosPorMes).sort((a,b) => {
      // LÃ³gica de ordenaÃ§Ã£o simples baseada nos Ãºltimos 12 meses
      const mesA = parseInt(a.match(/\d{2}/)[0]);
      const mesB = parseInt(b.match(/\d{2}/)[0]);
      return mesA - mesB;
  });

  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  if(chartMensal) chartMensal.destroy();
  chartMensal = new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: Object.keys(gastosPorMes),
      datasets: [{
        label: 'Gastos Mensais',
        data: Object.values(gastosPorMes),
        backgroundColor: '#4a90e2',
        borderColor: '#357abd',
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: '#e0e0e0', font: {size: 12, weight: 'bold'}}}
      },
      scales: {
        y: {beginAtZero: true, ticks: {color: '#b0b0b0'}, grid: {color: 'rgba(255,255,255,0.1)'}},
        x: {ticks: {color: '#b0b0b0'}, grid: {color: 'rgba(255,255,255,0.1)'}}
      }
    }
  });
}

async function enviarParaPlanilha(dados){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify(dados)
    });
    const result = await resp.json();
    atualizarStatusSync(true);
    mostrarLoading(false);
    return result;
  }catch(e){
    console.error("Erro ao sincronizar:",e);
    atualizarStatusSync(false);
    mostrarLoading(false);
    alert("âš ï¸ Erro ao sincronizar. Verifique sua conexÃ£o e a URL do Web App.");
  }
}

async function carregarRegistros(){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify({action:'get'})
    });
    const data = await resp.json();
    
    if(Array.isArray(data)) {
      // Reindexar registros com nÃºmeros sequenciais
      registros = data.map((r, idx) => ({...r, row: idx + 1, fav: r.fav || false}));
      atualizarStatusSync(true);
      aplicarFiltros(); // Usa a funÃ§Ã£o de filtro ao carregar
      console.log("âœ“ Carregados " + registros.length + " registros");
    }
  }catch(e){
    console.error("Erro ao carregar:",e);
    atualizarStatusSync(false);
  }
  mostrarLoading(false);
}

document.getElementById("financeForm").addEventListener("submit",function(e){
  e.preventDefault();
  const data=corrigirData(document.getElementById("data").value); // Usando a correÃ§Ã£o de data
  const tipo=document.getElementById("tipo").value;
  const descricao=document.getElementById("descricao").value;
  const valor=document.getElementById("valor").value;
  const status=document.getElementById("status").value;
  const campo1=document.getElementById("campo1").value;
  const campo2=document.getElementById("campo2").value;
  const campo3=document.getElementById("campo3").value;
  
  if(!data||!tipo||!descricao||!valor||!status){alert("Preencha todos os campos!"); return;}
  
  const row=document.getElementById("row").value;
  const sheetRowId=document.getElementById("sheetRowId").value;
  
  if(row){
    const idx = registros.findIndex(r=>r.id == sheetRowId);
    if(idx !== -1) {
      registros[idx]={...registros[idx],data,tipo,descricao,valor,status,campo1,campo2,campo3};
      enviarParaPlanilha({...registros[idx],action:'update'});
    }
    document.getElementById("row").value="";
    document.getElementById("sheetRowId").value="";
  }else{
    const novoRegistro={data,tipo,descricao,valor,status,campo1,campo2,campo3,fav:false};
    registros.push(novoRegistro);
    enviarParaPlanilha({...novoRegistro,action:'add'});
  }
  
  this.reset();
  document.getElementById("data").valueAsDate=new Date();
  mostraApenasFav = false;
  document.getElementById("btnFiltrarFav").classList.remove("active");
  aplicarFiltros(); // Atualiza a tabela apÃ³s salvar
});

/**
 * FunÃ§Ã£o unificada para aplicar todos os filtros (texto, data, favoritos) e atualizar a tabela.
 */
function aplicarFiltros() {
    const termo = document.getElementById("buscar").value.toLowerCase();
    const dataInicioStr = document.getElementById("dataInicio").value;
    const dataFimStr = document.getElementById("dataFim").value;
    
    let filtrados = registros;

    // 1. Filtragem por data
    if (dataInicioStr && dataFimStr) {
        // Usa a correÃ§Ã£o de data e define limites de tempo para cobrir o dia todo
        const dataInicio = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        const dataFim = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
        
        filtrados = filtrados.filter(r => {
            // Cria um objeto Date para o registro, usando 'T12:00:00' para consistÃªncia
            const dataRegistro = new Date(r.data + 'T12:00:00'); 
            return dataRegistro >= dataInicio && dataRegistro <= dataFim;
        });
        
        // Calcula os totais do filtro para notificar o usuÃ¡rio
        const totalPagarPeriodo = filtrados.filter(r => r.tipo === "Pagar").reduce((sum, r) => sum + parseFloat(r.valor), 0);
        const totalReceberPeriodo = filtrados.filter(r => r.tipo === "Receber").reduce((sum, r) => sum + parseFloat(r.valor), 0);
        
        if(filtrados.length > 0) {
            console.log(`Resumo do Filtro por Data (${dataInicioStr} a ${dataFimStr}): Pagar: ${formatarMoeda(totalPagarPeriodo)}, Receber: ${formatarMoeda(totalReceberPeriodo)}`);
        }
    }

    // 2. Filtragem por favoritos
    if (mostraApenasFav) {
        filtrados = filtrados.filter(r => r.fav);
    }

    // 3. Filtragem por texto
    if (termo) {
        filtrados = filtrados.filter(r => 
            r.descricao.toLowerCase().includes(termo) || 
            r.tipo.toLowerCase().includes(termo) || 
            r.data.includes(termo)
        );
    }
    
    mostrarRegistros(filtrados);
}

// Event Listeners atualizados
document.getElementById("buscar").addEventListener("input", aplicarFiltros);
document.getElementById("btnFiltrarData").addEventListener("click", aplicarFiltros);

document.getElementById("btnFiltrarFav").addEventListener("click", function(){
  mostraApenasFav = !mostraApenasFav;
  this.classList.toggle("active");
  aplicarFiltros();
});

function mudarStatus(row) {
  const registro = registros.find(r => r.row === row);
  if(!registro) return;
  
  let novoStatus = registro.status;
  if(registro.status === "Pendente") {
    novoStatus = registro.tipo === "Pagar" ? "Pago" : "Recebido";
  } else {
    novoStatus = "Pendente";
  }
  
  registro.status = novoStatus;
  enviarParaPlanilha({...registro, action:'update'});
  aplicarFiltros(); // Atualiza a tabela e re-aplica filtros
}

function exportarExcel(){
  let listaExportar = registros;
  if(mostraApenasFav) {
    listaExportar = registros.filter(r => r.fav);
  }
  // Aplica filtro de data e texto na exportaÃ§Ã£o se houver um filtro ativo na tela
  const termo = document.getElementById("buscar").value.toLowerCase();
  const dataInicioStr = document.getElementById("dataInicio").value;
  const dataFimStr = document.getElementById("dataFim").value;

  if (termo || (dataInicioStr && dataFimStr)) {
      listaExportar = listaExportar.filter(r => {
          // Filtro por texto
          const textoMatch = !termo || r.descricao.toLowerCase().includes(termo) || r.tipo.toLowerCase().includes(termo) || r.data.includes(termo);

          // Filtro por data
          let dataMatch = true;
          if (dataInicioStr && dataFimStr) {
              const dataInicio = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
              const dataFim = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
              const dataRegistro = new Date(r.data + 'T12:00:00'); 
              dataMatch = dataRegistro >= dataInicio && dataRegistro <= dataFim;
          }
          return textoMatch && dataMatch;
      });
  }

  const ws_data=listaExportar.map(r=>[r.fav?"â˜…":"",new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR'),r.tipo,r.descricao,r.valor,r.status,r.campo1||'',r.campo2||'',r.campo3||'']);
  ws_data.unshift(["Fav","Data","Tipo","DescriÃ§Ã£o","Valor","Status","Campo1","Campo2","Campo3"]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Financeiro");
  XLSX.writeFile(wb,"Controle_Financeiro.xlsx");
}

function editar(row){
  const r=registros.find(r=>r.row===row);
  if(r){
    document.getElementById("row").value=r.row;
    document.getElementById("sheetRowId").value=r.id;
    document.getElementById("data").value=r.data;
    document.getElementById("tipo").value=r.tipo;
    document.getElementById("descricao").value=r.descricao;
    document.getElementById("valor").value=r.valor;
    document.getElementById("status").value=r.status;
    document.getElementById("campo1").value=r.campo1||'';
    document.getElementById("campo2").value=r.campo2||'';
    document.getElementById("campo3").value=r.campo3||'';
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

function excluir(row){
  if(confirm("Deseja excluir este registro?")){
    const r = registros.find(r=>r.row===row);
    const idx = registros.findIndex(r=>r.row===row);
    enviarParaPlanilha({...r,action:'delete'});
    registros.splice(idx,1);
    mostraApenasFav = false;
    document.getElementById("btnFiltrarFav").classList.remove("active");
    aplicarFiltros();
  }
}

function toggleFav(row){
  const idx = registros.findIndex(r=>r.row===row);
  registros[idx].fav=!registros[idx].fav;
  enviarParaPlanilha({...registros[idx],action:'update'});
  aplicarFiltros();
}

document.getElementById("data").valueAsDate=new Date();
verificarAutenticacao();

// Sincronizar a cada 10 segundos (apenas se autenticado)
setInterval(() => {
  if(usuarioAutenticado) {
    carregarRegistros();
    console.log("â†» Sincronizando...");
  }
}, 10000);
</script>

</body>
</html>

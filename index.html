<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background:linear-gradient(135deg,#1e1e2e 0%,#2a2a3e 100%);
  padding:20px; 
  color:#e0e0e0;
  min-height:100vh;
}
.container { max-width:1400px; margin:0 auto; }
header { text-align:center; margin-bottom:40px; }
header h1 { 
  font-size:2.5em; 
  color:#fff; 
  font-weight:700;
  letter-spacing:-1px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
}
.cards-summary { 
  display:grid; 
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); 
  gap:20px; 
  margin-bottom:30px; 
}
.card { 
  background:linear-gradient(135deg,#2a2a3e 0%,#1f1f2e 100%);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  transition:transform 0.3s ease,box-shadow 0.3s ease;
  backdrop-filter:blur(10px);
}
.card:hover { 
  transform:translateY(-5px); 
  box-shadow:0 15px 50px rgba(0,0,0,0.4);
}
.card-label { 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:10px; 
  text-transform:uppercase; 
  letter-spacing:1px;
  font-weight:600;
}
.card-value { 
  font-size:2em; 
  font-weight:700;
  letter-spacing:-1px;
}
.card-pagar .card-value { color:#ff6b9d; }
.card-receber .card-value { color:#26de81; }
.card-saldo .card-value { color:#4a90e2; }
.content { 
  display:grid; 
  grid-template-columns:1fr 1fr; 
  gap:25px; 
  margin-bottom:30px; 
}
.form-section, .chart-section, .table-section { 
  background:linear-gradient(135deg,#2a2a3e 0%,#1f1f2e 100%);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
}
.form-section h2, .chart-section h2, .table-section h2 { 
  font-size:1.4em; 
  margin-bottom:20px;
  color:#fff;
  font-weight:700;
}
.form-group { margin-bottom:15px; }
label { 
  display:block; 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:8px; 
  text-transform:uppercase; 
  font-weight:600;
  letter-spacing:0.5px;
}
input, select { 
  width:100%; 
  padding:12px 15px; 
  border:1px solid rgba(255,255,255,0.2); 
  border-radius:10px; 
  background:rgba(255,255,255,0.05);
  color:#fff;
  font-size:1em;
  transition:all 0.3s ease;
}
input:focus, select:focus { 
  outline:none;
  border-color:#4a90e2;
  background:rgba(255,255,255,0.1);
  box-shadow:0 0 20px rgba(74,144,226,0.3);
}
button { 
  padding:12px 24px; 
  border:none; 
  border-radius:10px; 
  cursor:pointer; 
  font-weight:600;
  font-size:1em;
  transition:all 0.3s ease;
}
.btn-primary { 
  background:linear-gradient(135deg,#4a90e2 0%,#357abd 100%);
  color:white; 
  width:100%; 
}
.btn-primary:hover { 
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(74,144,226,0.4);
}
.btn-danger { 
  background:linear-gradient(135deg,#ff6b9d 0%,#d63447 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-edit { 
  background:linear-gradient(135deg,#26de81 0%,#1bb366 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-filter {
  background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%);
  color:white;
  padding:10px 20px;
  margin-bottom:15px;
  font-size:0.95em;
}
.btn-filter.active {
  background:linear-gradient(135deg,#ff6b9d 0%,#d63447 100%);
}
.search-bar { margin-bottom:15px; }
.search-bar input { width:100%; }
table { width:100%; border-collapse:collapse; }
th { 
  padding:15px 10px; 
  text-align:left; 
  background:rgba(255,255,255,0.05);
  border-bottom:2px solid rgba(255,255,255,0.1);
  font-weight:700;
  color:#fff;
  font-size:0.95em;
}
td { 
  padding:15px 10px; 
  border-bottom:1px solid rgba(255,255,255,0.05); 
}
tr:hover { background:rgba(255,255,255,0.05); }
.badge { 
  padding:6px 12px; 
  border-radius:20px; 
  font-size:0.8em; 
  font-weight:700; 
  text-transform:uppercase;
  letter-spacing:0.5px;
  display:inline-block;
}
.badge-pagar { 
  background:rgba(255,107,157,0.2); 
  color:#ff6b9d; 
  border:1px solid rgba(255,107,157,0.5);
}
.badge-receber { 
  background:rgba(38,222,129,0.2); 
  color:#26de81; 
  border:1px solid rgba(38,222,129,0.5);
}
.badge-pendente { 
  background:rgba(255,193,7,0.2); 
  color:#ffc107; 
  border:1px solid rgba(255,193,7,0.5);
}
.badge-pago { 
  background:rgba(38,222,129,0.2); 
  color:#26de81; 
  border:1px solid rgba(38,222,129,0.5);
}
.actions { 
  display:flex; 
  gap:8px;
}
.export-btn { margin-bottom:15px; }
.star { 
  color:#ffc107; 
  font-size:1.3em; 
  cursor:pointer;
  transition:all 0.3s ease;
}
.star:hover { 
  transform:scale(1.2);
  text-shadow:0 0 10px rgba(255,193,7,0.6);
}
.star-empty { 
  color:rgba(255,255,255,0.2); 
  font-size:1.3em; 
  cursor:pointer;
  transition:all 0.3s ease;
}
.star-empty:hover { 
  color:#ffc107;
  transform:scale(1.2);
}
@media(max-width:768px){
  .content{ grid-template-columns:1fr; }
  header h1 { font-size:1.8em; }
  .card-value { font-size:1.5em; }
  table { font-size:0.9em; }
  th, td { padding:10px 5px; }
}
</style>
</head>
<body>

<div class="container">
<header>
<h1>üí∞ Controle Financeiro</h1>
</header>

<div class="cards-summary">
<div class="card card-pagar"><div class="card-label">Total a Pagar</div><div class="card-value" id="totalPagar">R$ 0,00</div></div>
<div class="card card-receber"><div class="card-label">Total a Receber</div><div class="card-value" id="totalReceber">R$ 0,00</div></div>
<div class="card card-saldo"><div class="card-label">Saldo do Dia</div><div class="card-value" id="totalDia">R$ 0,00</div></div>
</div>

<div class="content">
<div class="form-section">
<h2>üìù Novo Registro</h2>
<form id="financeForm">
<input type="hidden" id="row">

<div class="form-group">
<label for="data">Data</label>
<input type="date" id="data" required>
</div>

<div class="form-group">
<label for="tipo">Tipo</label>
<select id="tipo" required>
<option value="Pagar">Pagar</option>
<option value="Receber">Receber</option>
</select>
</div>

<div class="form-group">
<label for="descricao">Descri√ß√£o</label>
<input type="text" id="descricao" placeholder="Ex: Aluguel, Sal√°rio..." required>
</div>

<div class="form-group">
<label for="valor">Valor</label>
<input type="number" id="valor" placeholder="0,00" required step="0.01">
</div>

<div class="form-group">
<label for="status">Status</label>
<select id="status" required>
<option value="Pendente">Pendente</option>
<option value="Pago">Pago</option>
</select>
</div>

<div class="form-group">
<label for="campo1">Campo Adicional 1</label>
<input type="text" id="campo1" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo2">Campo Adicional 2</label>
<input type="text" id="campo2" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo3">Campo Adicional 3</label>
<input type="text" id="campo3" placeholder="Opcional">
</div>

<button type="submit" class="btn-primary">üíæ Salvar Registro</button>
</form>
</div>

<div class="chart-section">
<h2>üìä Resumo Visual</h2>
<canvas id="graficoTipo"></canvas>
</div>
</div>

<div class="table-section">
<h2>üìã Registros</h2>
<div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
<div style="flex:1; min-width:200px;">
<input type="text" id="buscar" placeholder="üîç Buscar por descri√ß√£o, data ou tipo..." style="width:100%; padding:12px 15px; border:1px solid rgba(255,255,255,0.2); border-radius:10px; background:rgba(255,255,255,0.05); color:#fff;">
</div>
<button class="btn-filter" id="btnFiltrarFav">‚≠ê Apenas Favoritos</button>
<button class="btn-primary export-btn" onclick="exportarExcel()">üì• Exportar Excel</button>
</div>
<table id="tabelaFinance">
<thead>
<tr>
<th>Fav</th>
<th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Valor</th><th>Status</th><th>Campos</th><th>A√ß√µes</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<script>
let registros = [];
let chart;
let mostraApenasHartos = false;

const WEB_APP1 = "https://script.google.com/macros/s/AKfycby8RMoklQLNtr6Ffg9_ubqo8cH2in9hJgpP5zezr5CyzrULaRF74k4mnWzd11lmx-P2/exec";

const formatarMoeda = valor => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);

function mostrarRegistros(lista){
  const tbody = document.querySelector("#tabelaFinance tbody");
  tbody.innerHTML="";
  let totalPagar=0,totalReceber=0;
  
  lista.forEach(r=>{
    const tr=document.createElement("tr");
    const tipoBadge=r.tipo==="Pagar"?"badge-pagar":"badge-receber";
    const statusBadge=r.status==="Pendente"?"badge-pendente":"badge-pago";
    const starClass = r.fav ? "star" : "star-empty";
    
    tr.innerHTML=`
      <td><span class="${starClass}" onclick="toggleFav(${r.row})">‚òÖ</span></td>
      <td>${new Date(r.data).toLocaleDateString('pt-BR')}</td>
      <td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
      <td>${r.descricao}</td>
      <td><strong>${formatarMoeda(parseFloat(r.valor))}</strong></td>
      <td><span class="badge ${statusBadge}">${r.status}</span></td>
      <td>${r.campo1||'-'} ${r.campo2||''} ${r.campo3||''}</td>
      <td>
        <div class="actions">
          <button class="btn-edit" onclick="editar(${r.row})">Editar</button>
          <button class="btn-danger" onclick="excluir(${r.row})">Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
    
    if(r.tipo==="Pagar") totalPagar+=parseFloat(r.valor);
    if(r.tipo==="Receber") totalReceber+=parseFloat(r.valor);
  });
  
  document.getElementById("totalPagar").innerText=formatarMoeda(totalPagar);
  document.getElementById("totalReceber").innerText=formatarMoeda(totalReceber);
  document.getElementById("totalDia").innerText=formatarMoeda(totalReceber-totalPagar);
  atualizarGrafico(lista);
}

function atualizarGrafico(filtro=registros){
  const pagar=filtro.filter(r=>r.tipo==="Pagar").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  const receber=filtro.filter(r=>r.tipo==="Receber").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  const ctx=document.getElementById('graficoTipo').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['Pagar','Receber'],
      datasets:[{
        data:[pagar,receber],
        backgroundColor:['#ff6b9d','#26de81'],
        borderColor:'#1f1f2e',
        borderWidth:3
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom',labels:{color:'#e0e0e0',font:{size:12,weight:'bold'}}}
      }
    }
  });
}

async function enviarWebApp(dados){
  try{
    await fetch(WEB_APP1,{method:'POST',body:JSON.stringify(dados)});
  }catch(e){console.error("Erro ao enviar WebApp:",e);}
}

async function carregarRegistros(){
  try{
    const resp1=await fetch(WEB_APP1,{method:'POST',body:JSON.stringify({action:'get'})});
    const data1=await resp1.json();
    
    // Remove duplicatas usando um Set
    const registrosUnicos = [];
    const vistosSet = new Set();
    
    data1.forEach((r, i) => {
      const chave = `${r.data}-${r.tipo}-${r.descricao}-${r.valor}`;
      if (!vistosSet.has(chave)) {
        vistosSet.add(chave);
        registrosUnicos.push({...r, row: registrosUnicos.length + 1, fav: r.fav || false});
      }
    });
    
    registros = registrosUnicos;
    mostrarRegistros(registros);
  }catch(e){console.error("Erro ao carregar:",e);}
}

document.getElementById("financeForm").addEventListener("submit",function(e){
  e.preventDefault();
  const data=document.getElementById("data").value;
  const tipo=document.getElementById("tipo").value;
  const descricao=document.getElementById("descricao").value;
  const valor=document.getElementById("valor").value;
  const status=document.getElementById("status").value;
  const campo1=document.getElementById("campo1").value;
  const campo2=document.getElementById("campo2").value;
  const campo3=document.getElementById("campo3").value;
  
  if(!data||!tipo||!descricao||!valor||!status){alert("Preencha todos os campos!"); return;}
  
  const row=document.getElementById("row").value;
  if(row){
    const idx = registros.findIndex(r=>r.row==row);
    registros[idx]={...registros[idx],data,tipo,descricao,valor,status,campo1,campo2,campo3};
    enviarWebApp({...registros[idx],action:'edit'});
    document.getElementById("row").value="";
  }else{
    const novoRegistro={data,tipo,descricao,valor,status,campo1,campo2,campo3,fav:false,row:registros.length+1};
    registros.push(novoRegistro);
    enviarWebApp({...novoRegistro,action:'add'});
  }
  
  this.reset();
  document.getElementById("data").valueAsDate=new Date();
  mostraApenasHartos = false;
  document.getElementById("btnFiltrarFav").classList.remove("active");
  mostrarRegistros(registros);
});

document.getElementById("buscar").addEventListener("input",function(){
  const termo=this.value.toLowerCase();
  let filtrados=registros.filter(r=>r.descricao.toLowerCase().includes(termo)||r.tipo.toLowerCase().includes(termo)||r.data.includes(termo));
  
  if(mostraApenasHartos) {
    filtrados = filtrados.filter(r => r.fav);
  }
  
  mostrarRegistros(filtrados);
});

document.getElementById("btnFiltrarFav").addEventListener("click", function(){
  mostraApenasHartos = !mostraApenasHartos;
  this.classList.toggle("active");
  
  let filtrados = registros;
  if(mostraApenasHartos) {
    filtrados = registros.filter(r => r.fav);
  }
  
  const termo = document.getElementById("buscar").value.toLowerCase();
  if(termo) {
    filtrados = filtrados.filter(r=>r.descricao.toLowerCase().includes(termo)||r.tipo.toLowerCase().includes(termo)||r.data.includes(termo));
  }
  
  mostrarRegistros(filtrados);
});

function exportarExcel(){
  let listaExportar = registros;
  if(mostraApenasHartos) {
    listaExportar = registros.filter(r => r.fav);
  }
  
  const ws_data=listaExportar.map(r=>[r.fav?"‚òÖ":"",new Date(r.data).toLocaleDateString('pt-BR'),r.tipo,r.descricao,r.valor,r.status,r.campo1,r.campo2,r.campo3]);
  ws_data.unshift(["Fav","Data","Tipo","Descri√ß√£o","Valor","Status","Campo1","Campo2","Campo3"]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Financeiro");
  XLSX.writeFile(wb,"Controle_Financeiro.xlsx");
}

function editar(row){
  const r=registros.find(r=>r.row===row);
  if(r){
    document.getElementById("row").value=r.row;
    document.getElementById("data").value=r.data;
    document.getElementById("tipo").value=r.tipo;
    document.getElementById("descricao").value=r.descricao;
    document.getElementById("valor").value=r.valor;
    document.getElementById("status").value=r.status;
    document.getElementById("campo1").value=r.campo1;
    document.getElementById("campo2").value=r.campo2;
    document.getElementById("campo3").value=r.campo3;
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

function excluir(row){
  if(confirm("Deseja excluir este registro?")){
    const idx = registros.findIndex(r=>r.row===row);
    enviarWebApp({...registros[idx],action:'delete'});
    registros.splice(idx,1);
    mostraApenasHartos = false;
    document.getElementById("btnFiltrarFav").classList.remove("active");
    mostrarRegistros(registros);
  }
}

function toggleFav(row){
  const idx = registros.findIndex(r=>r.row===row);
  registros[idx].fav=!registros[idx].fav;
  enviarWebApp({...registros[idx],action:'edit'});
  
  let listaExibicao = registros;
  if(mostraApenasHartos) {
    listaExibicao = registros.filter(r => r.fav);
  }
  
  mostrarRegistros(listaExibicao);
}

document.getElementById("data").valueAsDate=new Date();
carregarRegistros();
</script>

</body>
</html>

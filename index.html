<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro - Vers√£o Moderna</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
:root {
    --bg-dark: #0a0e27;
    --bg-secondary-dark: #131829;
    --card-bg-dark: #1a1f3a;
    --text-color-dark: #e8eaf0;
    --text-secondary-dark: #a0a8c0;
    --header-color-dark: #ffffff;
    --input-bg-dark: #1a1f3a;
    --input-border-dark: #2a3151;
    --primary-color: #6366f1;
    --primary-hover: #4f46e5;
    --pagar-color: #ef4444;
    --receber-color: #10b981;
    --vencido-color: #f97316;
    --meta-color: #8b5cf6;
    --warning-color: #f59e0b;
    --sobra-color: #10b981;
    --falta-color: #ef4444;
    --fab-color: #6366f1;
    --shadow-color: rgba(0, 0, 0, 0.3);
    --glow-color: rgba(99, 102, 241, 0.2);
}
html[data-theme="light"] {
    --bg-dark: #f8fafc;
    --bg-secondary-dark: #f1f5f9;
    --card-bg-dark: #ffffff;
    --text-color-dark: #1e293b;
    --text-secondary-dark: #64748b;
    --header-color-dark: #0f172a;
    --input-bg-dark: #ffffff;
    --input-border-dark: #e2e8f0;
    --shadow-color: rgba(0, 0, 0, 0.1);
    --glow-color: rgba(99, 102, 241, 0.1);
}
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-dark);
    color: var(--text-color-dark);
    min-height: 100vh;
    transition: background 0.3s ease, color 0.3s ease;
    overflow-x: hidden;
}
/* Background Gradient */
body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.05) 0%, transparent 50%);
    animation: gradientMove 15s ease infinite;
    z-index: -1;
}
@keyframes gradientMove {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(5%, 5%); }
}
.container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}
/* Header */
header {
    text-align: center;
    padding: 40px 20px;
    margin-bottom: 40px;
    position: relative;
}
header h1 {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary-color), var(--meta-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px;
    letter-spacing: -1px;
}
.theme-toggle-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card-bg-dark);
    border: 2px solid var(--input-border-dark);
    color: var(--text-color-dark);
    padding: 12px 20px;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    z-index: 1000;
    box-shadow: 0 4px 20px var(--shadow-color);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}
.theme-toggle-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px var(--shadow-color);
}
/* Sync Status */
.sync-status {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    background: var(--card-bg-dark);
    border: 2px solid var(--receber-color);
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--receber-color);
}
.sync-status.offline {
    border-color: var(--pagar-color);
    color: var(--pagar-color);
}
.sync-status .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--receber-color);
    animation: pulse 2s infinite;
}
.sync-status.offline .dot {
    background: var(--pagar-color);
    animation: none;
}
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.2); }
}
/* Cards Summary */
.cards-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}
.card {
    background: var(--card-bg-dark);
    border-radius: 20px;
    padding: 25px;
    border: 1px solid var(--input-border-dark);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--meta-color));
    opacity: 0;
    transition: opacity 0.3s ease;
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px var(--shadow-color), 0 0 20px var(--glow-color);
}
.card:hover::before {
    opacity: 1;
}
.card-label {
    font-size: 0.85rem;
    color: var(--text-secondary-dark);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    margin-bottom: 12px;
}
.card-value {
    font-size: 2rem;
    font-weight: 800;
    letter-spacing: -1px;
}
.card-pagar .card-value { color: var(--pagar-color); }
.card-receber .card-value { color: var(--receber-color); }
.card-saldo .card-value { color: var(--primary-color); }
.card-vencido .card-value { color: var(--vencido-color); }
.card-meta .card-value { color: var(--meta-color); }
.card-sobra .card-value { color: var(--sobra-color); }
.card-falta .card-value { color: var(--falta-color); }
/* Anima√ß√£o Contas Vencidas */
.card-vencido.pulsing {
    animation: pulse-vencidos 1.5s infinite;
    border-color: var(--vencido-color);
}
@keyframes pulse-vencidos {
    0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); }
    70% { box-shadow: 0 0 0 15px rgba(249, 115, 22, 0); }
    100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); }
}
.edit-hint {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 1.2rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.card:hover .edit-hint {
    opacity: 0.7;
}
.progress-bar {
    width: 100%;
    height: 6px;
    background: var(--input-bg-dark);
    border-radius: 10px;
    margin-top: 15px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--receber-color), var(--primary-color));
    border-radius: 10px;
    transition: width 0.5s ease;
}
.progress-fill.warning {
    background: linear-gradient(90deg, var(--warning-color), var(--vencido-color));
}
.progress-fill.danger {
    background: linear-gradient(90deg, var(--pagar-color), var(--vencido-color));
}
/* Content Grid */
.content {
    display: grid;
    gap: 25px;
    margin-bottom: 30px;
}
.content.two-col {
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
}
.content.three-col {
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
}
.content.full-width {
    grid-template-columns: 1fr;
}
.form-section, .chart-section, .table-section {
    background: var(--card-bg-dark);
    border-radius: 20px;
    padding: 30px;
    border: 1px solid var(--input-border-dark);
    transition: all 0.3s ease;
}
.form-section h2, .chart-section h2, .table-section h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 25px;
    color: var(--header-color-dark);
}
/* Form Styles */
.form-group {
    margin-bottom: 20px;
}
label {
    display: block;
    font-size: 0.85rem;
    color: var(--text-secondary-dark);
    margin-bottom: 8px;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}
input, select {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid var(--input-border-dark);
    border-radius: 12px;
    background: var(--input-bg-dark);
    color: var(--text-color-dark);
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.3s ease;
}
input:focus, select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--glow-color);
}
/* Buttons */
button {
    padding: 14px 28px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    font-family: inherit;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}
button:hover::before {
    width: 300px;
    height: 300px;
}
.btn-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
    color: white;
    width: 100%;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
}
.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
}
.btn-danger {
    background: linear-gradient(135deg, var(--pagar-color), #dc2626);
    color: white;
    font-size: 0.85rem;
    padding: 10px 18px;
}
.btn-edit {
    background: linear-gradient(135deg, var(--receber-color), #059669);
    color: white;
    font-size: 0.85rem;
    padding: 10px 18px;
}
.btn-partial {
    background: linear-gradient(135deg, var(--warning-color), #ea580c);
    color: white;
    font-size: 0.85rem;
    padding: 10px 18px;
}
.btn-filter {
    background: var(--card-bg-dark);
    border: 2px solid var(--input-border-dark);
    color: var(--text-color-dark);
    padding: 12px 24px;
    font-size: 0.9rem;
}
.btn-filter:hover {
    border-color: var(--primary-color);
    background: var(--glow-color);
}
.btn-filter.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}
/* Status Filters */
.status-filters {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    padding: 20px;
    background: var(--input-bg-dark);
    border-radius: 16px;
    border: 1px solid var(--input-border-dark);
}
.status-filter-btn {
    padding: 10px 20px;
    border: 2px solid transparent;
    border-radius: 50px;
    background: var(--card-bg-dark);
    color: var(--text-color-dark);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}
.status-filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px var(--shadow-color);
}
.status-filter-btn.active {
    border-color: var(--primary-color);
    background: var(--glow-color);
    color: var(--primary-color);
}
.filter-count {
    background: var(--input-border-dark);
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
}
/* Table */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
}
th {
    padding: 15px 12px;
    text-align: left;
    background: var(--input-bg-dark);
    font-weight: 700;
    color: var(--text-secondary-dark);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: color 0.2s ease;
}
th:hover {
    color: var(--primary-color);
}
th:first-child {
    border-radius: 12px 0 0 12px;
}
th:last-child {
    border-radius: 0 12px 12px 0;
}
td {
    padding: 18px 12px;
    background: var(--input-bg-dark);
    border-top: 1px solid var(--input-border-dark);
    border-bottom: 1px solid var(--input-border-dark);
    transition: background 0.2s ease;
}
td:first-child {
    border-left: 1px solid var(--input-border-dark);
    border-radius: 12px 0 0 12px;
}
td:last-child {
    border-right: 1px solid var(--input-border-dark);
    border-radius: 0 12px 12px 0;
}
tr:hover td {
    background: var(--card-bg-dark);
}
.badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}
.badge-pagar {
    background: rgba(239, 68, 68, 0.2);
    color: var(--pagar-color);
    border: 1px solid var(--pagar-color);
}
.badge-receber {
    background: rgba(16, 185, 129, 0.2);
    color: var(--receber-color);
    border: 1px solid var(--receber-color);
}
.badge-pendente {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning-color);
    border: 1px solid var(--warning-color);
}
.badge-pago {
    background: rgba(16, 185, 129, 0.2);
    color: var(--receber-color);
    border: 1px solid var(--receber-color);
}
.actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
/* Filter Controls */
.filter-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.filter-item {
    display: flex;
    flex-direction: column;
}
.filter-item-large {
    grid-column: span 2;
}
.filter-summary {
    background: var(--glow-color);
    border: 2px solid var(--primary-color);
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 20px;
    font-weight: 600;
    display: none;
    justify-content: space-around;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}
.summary-value-pagar { color: var(--pagar-color); }
.summary-value-receber { color: var(--receber-color); }
.summary-value-saldo { color: var(--primary-color); }
/* FAB */
.fab-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 900;
}
.fab-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
    color: white;
    font-size: 2em;
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
.fab-btn:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 12px 40px rgba(99, 102, 241, 0.6);
}
.quick-menu {
    position: absolute;
    bottom: 80px;
    right: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    transform: translateY(20px);
}
.quick-menu.visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
}
.quick-menu button {
    width: 160px;
    padding: 12px 20px;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 4px 20px var(--shadow-color);
}
/* Modal Overlay */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}
.modal-box {
    background: var(--card-bg-dark);
    padding: 50px;
    border-radius: 24px;
    box-shadow: 0 20px 60px var(--shadow-color);
    text-align: left;
    min-width: 500px;
    max-width: 90%;
    border: 1px solid var(--input-border-dark);
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
}
.modal-box h2 {
    color: var(--header-color-dark);
    margin-bottom: 25px;
    font-size: 1.8rem;
    text-align: center;
}
.modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary-dark);
    cursor: pointer;
    transition: color 0.2s ease;
    padding: 10px;
}
.modal-close:hover {
    color: var(--pagar-color);
    transform: rotate(90deg);
}
.loading {
    display: none;
    text-align: center;
    padding: 20px;
    color: var(--primary-color);
    font-weight: 600;
    font-size: 1.1rem;
}
.loading.show {
    display: block;
}
/* Calendar */
.calendar-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.calendar-controls button {
    padding: 8px 15px;
    width: auto;
    font-size: 0.8rem;
    background: var(--input-bg-dark);
    border: 1px solid var(--input-border-dark);
    color: var(--text-color-dark);
    transition: background 0.3s ease;
}
.calendar-controls button:hover {
    background: var(--primary-color);
    color: white;
}
.financial-calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    font-size: 0.85rem;
    text-align: center;
}
.calendar-header {
    font-weight: 700;
    padding: 10px 0;
    color: var(--text-secondary-dark);
}
.calendar-day {
    padding: 12px 8px;
    border-radius: 12px;
    min-height: 70px;
    background: var(--input-bg-dark);
    border: 1px solid var(--input-border-dark);
    cursor: pointer;
    transition: all 0.3s ease;
}
.calendar-day:hover {
    background: var(--card-bg-dark);
    transform: scale(1.05);
}
.calendar-day-number {
    font-weight: 700;
    display: block;
    margin-bottom: 5px;
}
.day-pagar {
    color: var(--pagar-color);
    font-weight: 600;
    font-size: 0.75rem;
}
.day-receber {
    color: var(--receber-color);
    font-weight: 600;
    font-size: 0.75rem;
}
.day-has-events {
    box-shadow: 0 0 15px var(--glow-color);
    border-color: var(--primary-color);
}
/* Category Progress */
.category-progress-container {
    margin-top: 25px;
    padding: 20px;
    background: var(--input-bg-dark);
    border-radius: 16px;
    border: 1px solid var(--input-border-dark);
    max-height: 300px;
    overflow-y: auto;
}
.category-progress-item {
    margin-bottom: 15px;
    padding: 12px 0;
    border-bottom: 1px dashed var(--input-border-dark);
    cursor: pointer;
    transition: all 0.3s ease;
}
.category-progress-item:hover {
    background: var(--card-bg-dark);
    padding: 12px;
    border-radius: 8px;
}
.category-progress-item:last-child {
    border-bottom: none;
}
.category-progress-item .label {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-color-dark);
    margin-bottom: 8px;
}
/* Statistics Modal */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}
.stat-item {
    background: var(--input-bg-dark);
    padding: 15px;
    border-radius: 12px;
    border-left: 5px solid var(--primary-color);
}
.stat-item-label {
    font-size: 0.8rem;
    color: var(--text-secondary-dark);
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 5px;
}
.stat-item-value {
    font-size: 1.3rem;
    font-weight: 700;
}
.stat-entrada { border-left-color: var(--receber-color); }
.stat-saida { border-left-color: var(--pagar-color); }
.stat-saldo { border-left-color: var(--primary-color); }
.stat-ticket { border-left-color: var(--warning-color); }
.stat-records { border-left-color: var(--meta-color); }
.stat-most-spent { border-left-color: var(--vencido-color); }
/* Stars */
.star-empty, .star {
    font-size: 1.3rem;
    cursor: pointer;
    transition: all 0.3s ease;
}
.star-empty {
    color: var(--text-secondary-dark);
}
.star-empty:hover {
    color: var(--warning-color);
    transform: scale(1.2);
}
.star {
    color: var(--warning-color);
}
/* Responsive */
@media(max-width: 1200px) {
    .content.two-col {
        grid-template-columns: 1fr;
    }
}
@media(max-width: 768px) {
    .container {
        padding: 15px;
    }
    header {
        padding: 30px 15px;
    }
    .cards-summary {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    .card {
        padding: 20px;
    }
    .card-value {
        font-size: 1.5rem;
    }
    .content.three-col {
        grid-template-columns: 1fr;
    }
    .form-section, .chart-section, .table-section {
        padding: 20px;
    }
    .filter-controls {
        grid-template-columns: 1fr;
    }
    .filter-item-large {
        grid-column: span 1;
    }
    .status-filters {
        justify-content: center;
        padding: 15px;
    }
    .status-filter-btn {
        font-size: 0.85rem;
        padding: 8px 16px;
    }
    table {
        font-size: 0.85rem;
    }
    th, td {
        padding: 12px 8px;
    }
    .actions button {
        margin-bottom: 5px;
        font-size: 0.8rem;
        padding: 8px 12px;
    }
    .theme-toggle-btn {
        top: 10px;
        right: 10px;
        padding: 10px 16px;
        font-size: 0.85rem;
    }
    .modal-box {
        min-width: 90%;
        padding: 30px;
    }
    .fab-container {
        bottom: 20px;
        right: 20px;
    }
    .fab-btn {
        width: 56px;
        height: 56px;
        font-size: 1.5em;
    }
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
@media(max-width: 480px) {
    header h1 {
        font-size: 1.8rem;
    }
    .cards-summary {
        grid-template-columns: 1fr;
    }
    .calendar-day {
        min-height: 60px;
        padding: 8px 4px;
    }
}
/* Scrollbar */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}
::-webkit-scrollbar-track {
    background: var(--input-bg-dark);
    border-radius: 10px;
}
::-webkit-scrollbar-thumb {
    background: var(--input-border-dark);
    border-radius: 10px;
}
::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color);
}
/* Smooth Animations */
.card, .form-section, .chart-section, .table-section, button, input, select {
    will-change: transform;
}
</style>
</head>
<body>
<button class="theme-toggle-btn" onclick="toggleTheme()">‚òÄÔ∏è Modo Claro</button>

<!-- REMOVIDO O LOGIN OVERLAY -->

<div class="modal-overlay" id="statisticsModal" style="display:none;">
    <div class="modal-box">
        <button class="modal-close" onclick="closeModal('statisticsModal')">X</button>
        <h2>üìä Estat√≠sticas do M√™s Atual</h2>
        <p style="text-align: center; color: var(--text-secondary-dark); margin-bottom: 20px;" id="statsCurrentMonth"></p>
        <div class="stats-grid">
            <div class="stat-item stat-entrada">
                <div class="stat-item-label">Entradas (Realiz.)</div>
                <div class="stat-item-value summary-value-receber" id="statsEntradas">R$ 0,00</div>
            </div>
            <div class="stat-item stat-saida">
                <div class="stat-item-label">Sa√≠das (Realiz.)</div>
                <div class="stat-item-value summary-value-pagar" id="statsSaidas">R$ 0,00</div>
            </div>
            <div class="stat-item stat-saldo">
                <div class="stat-item-label">Saldo Realizado</div>
                <div class="stat-item-value summary-value-saldo" id="statsSaldo">R$ 0,00</div>
            </div>
            <div class="stat-item stat-ticket">
                <div class="stat-item-label">Ticket M√©dio (Gastos)</div>
                <div class="stat-item-value" id="statsTicketMedio">R$ 0,00</div>
            </div>
            <div class="stat-item stat-most-spent">
                <div class="stat-item-label">Categoria Mais Gasta</div>
                <div class="stat-item-value" id="statsCategoriaMaisGasta">-</div>
            </div>
            <div class="stat-item stat-records">
                <div class="stat-item-label">Total de Registros</div>
                <div class="stat-item-value" id="statsTotalRegistros">0</div>
            </div>
        </div>
        <h3 style="margin-top: 30px; font-size: 1.2em; color: var(--header-color-dark);">Proje√ß√£o (Pendentes)</h3>
        <div class="stats-grid">
            <div class="stat-item stat-entrada">
                <div class="stat-item-label">Entradas (Pend.)</div>
                <div class="stat-item-value summary-value-receber" id="statsEntradasPendentes">R$ 0,00</div>
            </div>
            <div class="stat-item stat-saida">
                <div class="stat-item-label">Sa√≠das (Pend.)</div>
                <div class="stat-item-value summary-value-pagar" id="statsSaidasPendentes">R$ 0,00</div>
            </div>
            <div class="stat-item stat-saldo">
                <div class="stat-item-label">Saldo Projetado</div>
                <div class="stat-item-value summary-value-saldo" id="statsSaldoProjetado">R$ 0,00</div>
            </div>
        </div>
    </div>
</div>

<!-- MAIN CONTAINER: agora vis√≠vel por padr√£o -->
<div class="container" id="mainContainer">
<header>
<h1>üí∞ Controle Financeiro</h1>
<div class="sync-status" id="syncStatus">
  <div class="dot"></div>
  <span id="syncText">Sincronizado</span>
</div>
</header>
<div class="cards-summary">
    <div class="card card-pagar"><div class="card-label">Total a Pagar</div><div class="card-value" id="totalPagar">R$ 0,00</div></div>
    <div class="card card-receber"><div class="card-label">Total a Receber</div><div class="card-value" id="totalReceber">R$ 0,00</div></div>
    <div class="card card-saldo"><div class="card-label">Saldo do Dia</div><div class="card-value" id="totalDia">R$ 0,00</div></div>
    <div class="card card-vencido" id="cardVencidos"><div class="card-label">Contas Vencidas</div><div class="card-value" id="totalVencidos">R$ 0,00</div></div>
    <div class="card card-pagar"><div class="card-label">Vencem 7 Dias</div><div class="card-value" id="vencemSeteDias">R$ 0,00</div></div>
    <div class="card card-pagar"><div class="card-label">Gasto Hoje</div><div class="card-value" id="gastoHoje">R$ 0,00</div></div>
    <div class="card" id="cardSobraMes">
        <div class="card-label">Sobra/Falta (M√™s)</div>
        <div class="card-value" id="sobraFaltaMes">R$ 0,00</div>
        <div style="font-size: 0.8em; margin-top: 8px; color: var(--text-secondary-dark);">M√©dia 3M: <span id="media3Meses">R$ 0,00</span></div>
    </div>
    <div class="card card-meta" onclick="editarMeta('global')">
        <div class="edit-hint">‚úèÔ∏è</div>
        <div class="card-label" id="metaLabel">Meta de Gastos (M√™s)</div>
        <div class="card-value" id="metaValor">R$ 0,00</div>
        <div class="progress-bar">
            <div class="progress-fill" id="metaProgress"></div>
        </div>
        <div style="font-size: 0.85em; margin-top: 8px; color: var(--text-secondary-dark);" id="metaPercentual">0% utilizado</div>
    </div>
    <div class="card card-saldo">
        <div class="card-label">Renda L√≠quida Dispon√≠vel</div>
        <div class="card-value" id="rendaLiquidaDisponivel">R$ 0,00</div>
        <div style="font-size: 0.8em; margin-top: 8px; color: var(--text-secondary-dark);">
            (Total recebido ‚àí Total gasto)
        </div>
    </div>
</div>
<div class="content two-col">
<div class="form-section">
<h2>üìù Novo Registro</h2>
<form id="financeForm">
<input type="hidden" id="row">
<input type="hidden" id="sheetRowId">
<input type="hidden" id="categoriaSugerida" value="">
<div class="form-group">
<label for="data">Data</label>
<input type="date" id="data" required>
</div>
<div class="form-group">
<label for="tipo">Tipo</label>
<select id="tipo" required onchange="toggleParcelaRecorrente()">
<option value="Pagar">Pagar</option>
<option value="Receber">Receber</option>
</select>
</div>
<div class="form-group">
<label for="descricao">Descri√ß√£o</label>
<input type="text" id="descricao" placeholder="Ex: Aluguel, Sal√°rio..." required>
</div>
<div class="form-group">
    <label for="categoria">Categoria <span id="sugestaoEmoji" style="display:none; color:var(--warning-color); font-weight:700;">(Sug.)</span></label>
    <select id="categoria" required onchange="exibirMetaCategoria(this.value)">
        <option value="">Selecione a Categoria</option>
        <option value="Sal√°rio/Renda">Sal√°rio/Renda</option>
        <option value="Investimento">Investimento</option>
        <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
        <option value="Moradia/Aluguel">Moradia/Aluguel</option>
        <option value="Transporte">Transporte</option>
        <option value="Lazer">Lazer</option>
        <option value="Sa√∫de">Sa√∫de</option>
        <option value="Educa√ß√£o">Educa√ß√£o</option>
        <option value="Outros">Outros</option>
    </select>
    <div id="categoryMetaIndicator" style="font-size: 0.85em; margin-top: 8px; display:none;">
        <span style="font-weight: 600;">Meta: <span id="metaValorForm" style="color:var(--meta-color);">R$ 0,00</span></span> | 
        <span>Gasto: <span id="gastoAtualForm">R$ 0,00</span></span>
        <div class="progress-bar" style="height: 4px; margin-top: 5px;">
            <div class="progress-fill" id="metaCategoryProgress"></div>
        </div>
    </div>
</div>
<div class="form-group">
<label for="valor">Valor</label>
<input type="number" id="valor" placeholder="0,00" required step="0.01">
</div>
<div class="form-group" id="parcelamentoGroup" style="display: none;">
    <label for="parcelas">N√∫mero de Parcelas</label>
    <input type="number" id="parcelas" placeholder="1" min="1" value="1" onchange="toggleParcelaRecorrente()">
</div>
<div class="form-group" id="recorrenciaGroup" style="display: none;">
    <label for="recorrencia">Marcar como Recorrente (Mensal)</label>
    <select id="recorrencia">
        <option value="Nao">N√£o</option>
        <option value="Sim">Sim, Mensal</option>
    </select>
    <div style="font-size: 0.8em; color: var(--warning-color); margin-top: 5px;">* Criar√° lan√ßamentos autom√°ticos no pr√≥ximo m√™s.</div>
</div>
<div class="form-group">
<label for="status">Status</label>
<select id="status" required>
<option value="Pendente">Pendente</option>
<option value="Pago">Pago</option>
<option value="Recebido">Recebido</option>
</select>
</div>
<div class="form-group">
<label for="conta">Conta/Carteira</label>
<select id="conta">
    <option value="Conta Corrente">Conta Corrente</option>
    <option value="Poupan√ßa">Poupan√ßa</option>
    <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
    <option value="Carteira">Carteira (Dinheiro)</option>
</select>
</div>
<div class="form-group">
<label for="campo2">Campo Adicional 2</label>
<input type="text" id="campo2" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo3">Campo Adicional 3</label>
<input type="text" id="campo3" placeholder="Opcional">
</div>
<button type="submit" class="btn-primary">üíæ Salvar Registro</button>
</form>
</div>
<div class="chart-section">
<h2>üìä Gastos por Categoria</h2>
<canvas id="graficoTipo"></canvas>
<div class="category-progress-container">
    <h3 style="font-size: 1.1em; margin-bottom: 15px; color: var(--meta-color);">Metas por Categoria</h3>
    <div id="categoryMetasSummary">
        <div style="text-align: center; color: var(--text-secondary-dark);">Defina metas ao lado.</div>
    </div>
</div>
</div>
</div>
<div class="content three-col">
    <div class="chart-section">
        <h2>üìà Fluxo de Caixa</h2>
        <canvas id="graficoFluxoCaixa"></canvas>
    </div>
    <div class="chart-section">
        <h2>üìâ Comparativo Mensal</h2>
        <canvas id="graficoComparativoMensal"></canvas>
    </div>
    <div class="chart-section card-meta" onclick="editarMeta('objetivo')" style="cursor: pointer;">
        <div class="edit-hint">‚úèÔ∏è</div>
        <h2>üéØ Objetivo de Economia</h2>
        <div id="objetivoCardContent">
            <p style="color: var(--receber-color); font-weight: 600;">
                Meta: <span id="objetivoValorDisplay">R$ 0,00</span> em <span id="objetivoMesesDisplay">0</span> meses
            </p>
            <p style="font-size: 1.5em; margin: 15px 0;">
                Poupar: <span id="valorMensalPoupar" class="summary-value-receber">R$ 0,00/m√™s</span>
            </p>
            <div style="font-size: 0.85em; color: var(--text-secondary-dark);">
                (Baseado na sua meta de <span id="objetivoMesesAux">0</span> meses)
            </div>
        </div>
    </div>
</div>
<div class="content full-width">
<div class="table-section">
<h2>üìã Registros</h2>
<div class="loading" id="loading">‚è≥ Sincronizando...</div>
<div class="status-filters">
    <button class="status-filter-btn filter-todos active" onclick="filtrarPorStatus('todos')">
        üîç Todos <span class="filter-count" id="countTodos">0</span>
    </button>
    <button class="status-filter-btn filter-pendente" onclick="filtrarPorStatus('Pendente')">
        ‚è≥ Pendentes <span class="filter-count" id="countPendente">0</span>
    </button>
    <button class="status-filter-btn filter-pago" onclick="filtrarPorStatus('Pago')">
        ‚úÖ Pagos <span class="filter-count" id="countPago">0</span>
    </button>
    <button class="status-filter-btn filter-recebido" onclick="filtrarPorStatus('Recebido')">
        üí∞ Recebidos <span class="filter-count" id="countRecebido">0</span>
    </button>
    <button class="status-filter-btn filter-pagar" onclick="filtrarPorStatus('tipo-pagar')">
        üí∏ A Pagar <span class="filter-count" id="countPagar">0</span>
    </button>
    <button class="status-filter-btn filter-receber" onclick="filtrarPorStatus('tipo-receber')">
        üíµ A Receber <span class="filter-count" id="countReceber">0</span>
    </button>
</div>
<div class="filter-controls">
    <div class="filter-item filter-item-large">
        <label for="buscar">Buscar</label>
        <input type="text" id="buscar" placeholder="üîç Descri√ß√£o, data, tipo ou conta...">
    </div>
    <div class="filter-item">
        <label for="filtroCategoria">Categoria</label>
        <select id="filtroCategoria" onchange="aplicarFiltros()">
            <option value="all">Todas</option>
            <option value="Sal√°rio/Renda">Sal√°rio/Renda</option>
            <option value="Investimento">Investimento</option>
            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
            <option value="Moradia/Aluguel">Moradia/Aluguel</option>
            <option value="Transporte">Transporte</option>
            <option value="Lazer">Lazer</option>
            <option value="Sa√∫de">Sa√∫de</option>
            <option value="Educa√ß√£o">Educa√ß√£o</option>
            <option value="Outros">Outros</option>
        </select>
    </div>
    <div class="filter-item">
        <label for="filtroPeriodo">Per√≠odo</label>
        <select id="filtroPeriodo">
            <option value="all">Todos</option>
            <option value="1" selected>Dia Atual</option>
            <option value="2-30">√öltimos 30 Dias</option>
            <option value="90">√öltimos 90 Dias</option>
            <option value="customDays">Personalizado</option>
        </select>
    </div>
    <div class="filter-item" id="customDaysInput" style="display:none;">
        <label for="diasCustomizados">Dias</label>
        <input type="number" id="diasCustomizados" placeholder="Ex: 250">
    </div>
    <div class="filter-item">
        <label for="dataInicio">Data In√≠cio</label>
        <input type="date" id="dataInicio">
    </div>
    <div class="filter-item">
        <label for="dataFim">Data Fim</label>
        <input type="date" id="dataFim">
    </div>
    <div class="filter-item">
        <button class="btn-filter" id="btnFiltrarData" onclick="aplicarFiltros()" style="width: 100%; margin-top: 23px;">Filtrar</button>
    </div>
    <div class="filter-item">
        <button class="btn-filter" id="btnFiltrarFav" style="width: 100%; margin-top: 23px;">‚≠ê Favoritos</button>
    </div>
    <div class="filter-item">
        <button class="btn-danger" onclick="limparFiltros()" style="width: 100%; margin-top: 23px;">üßπ Limpar Filtros</button>
    </div>
    <div class="filter-item">
        <button class="btn-primary" onclick="exportarExcel()" style="width: 100%; margin-top: 23px;">üì• Excel</button>
    </div>
</div>
<div class="filter-summary" id="periodSummary">
    <span>Per√≠odo Filtrado:</span>
    <span>Pagar: <span class="summary-value-pagar" id="summaryPagar"></span></span>
    <span>Receber: <span class="summary-value-receber" id="summaryReceber"></span></span>
    <span>Saldo: <span class="summary-value-saldo" id="summarySaldo"></span></span>
</div>
<table id="tabelaFinance">
<thead>
<tr>
<th onclick="ordenarTabela('fav')">‚≠ê</th>
<th onclick="ordenarTabela('data')">Data <span id="sort-data" style="color:var(--primary-color);">‚ñº</span></th>
<th onclick="ordenarTabela('tipo')">Tipo</th>
<th onclick="ordenarTabela('descricao')">Descri√ß√£o</th>
<th onclick="ordenarTabela('categoria')">Categoria</th>
<th onclick="ordenarTabela('valor')">Valor</th>
<th onclick="ordenarTabela('conta')">Conta</th>
<th onclick="ordenarTabela('status')">Status</th>
<th>Info</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="content three-col">
    <div class="chart-section">
        <h2>üìà Gastos Di√°rios</h2>
        <canvas id="graficoDiario"></canvas>
    </div>
    <div class="chart-section">
        <h2>üìâ Gastos Mensais</h2>
        <canvas id="graficoMensal"></canvas>
    </div>
    <div class="chart-section">
        <h2>üìÖ Calend√°rio Financeiro</h2>
        <div class="calendar-controls">
            <button onclick="mudarMes(-1)">‚óÄÔ∏è M√™s Anterior</button>
            <div id="calendarHeader" style="font-weight: 700; color: var(--header-color-dark);">M√™s/Ano</div>
            <button onclick="mudarMes(1)">Pr√≥ximo M√™s ‚ñ∂Ô∏è</button>
        </div>
        <div class="financial-calendar" id="financialCalendar">
            <div class="calendar-header">Dom</div>
            <div class="calendar-header">Seg</div>
            <div class="calendar-header">Ter</div>
            <div class="calendar-header">Qua</div>
            <div class="calendar-header">Qui</div>
            <div class="calendar-header">Sex</div>
            <div class="calendar-header">S√°b</div>
        </div>
        <div style="font-size: 0.8em; color: var(--text-secondary-dark); margin-top: 15px; text-align: center;">* Clique no dia para detalhes</div>
    </div>
</div>
</div>
<div class="fab-container" id="fabContainer">
    <div class="quick-menu" id="quickMenu">
        <button class="btn-edit" onclick="focarFormulario('Receber')">üíµ Receber</button>
        <button class="btn-danger" onclick="focarFormulario('Pagar')">üí∏ Pagar</button>
        <button class="btn-primary" onclick="toggleStatistics()">üìä Estat√≠sticas</button>
        <button class="btn-filter" onclick="alert('Atalhos:
+ ou N: Focar Formul√°rio
F: Favoritos
Em desenvolvimento...')">üí° Atalhos</button>
    </div>
    <button class="fab-btn" onclick="toggleQuickMenu()">+</button>
</div>

<script>
let registros = [];
let chart, chartDiario, chartMensal, chartFluxoCaixa, chartCompMensal;
let mostraApenasFav = false;
let currentTheme = localStorage.getItem('theme') || 'dark';
let filtroStatusAtual = 'todos';
let filtroCategoriaAtual = 'all';
let ordenacaoAtual = { chave: 'data', direcao: 'desc' };
let calendarioMesAtual = new Date();
calendarioMesAtual.setDate(1);
let metasPorCategoria = JSON.parse(localStorage.getItem('metasPorCategoria')) || {
    "Alimenta√ß√£o": 800,
    "Moradia/Aluguel": 1500,
    "Transporte": 300
};
let objetivoEconomia = parseFloat(localStorage.getItem('objetivoEconomia')) || 10000;
let objetivoMeses = parseInt(localStorage.getItem('objetivoMeses')) || 12;
let metaTipo = localStorage.getItem('metaTipo') || 'mensal';
let metaValor = parseFloat(localStorage.getItem('metaValor')) || 5000;
const regrasAutomacao = [
    { termo: "uber", categoria: "Transporte" },
    { termo: "ifood", categoria: "Alimenta√ß√£o" },
    { termo: "netflix", categoria: "Lazer" },
    { termo: "aluguel", categoria: "Moradia/Aluguel" }
];
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxCkEbskP0tA-4Ii_9v1wS7z2_9yHP0nn-_GroK_Z4paEiurRMz6Iole6902c00FR-Q/exec";
const formatarMoeda = valor => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);

function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', currentTheme);
    applyTheme();
}
function applyTheme() {
    document.documentElement.setAttribute('data-theme', currentTheme);
    const themeButton = document.querySelector('.theme-toggle-btn');
    if (currentTheme === 'light') {
        themeButton.innerHTML = 'üåô Modo Escuro';
    } else {
        themeButton.innerHTML = '‚òÄÔ∏è Modo Claro';
    }
    if(chart) atualizarGraficos(registros); 
}

// REMOVIDO: login, verifica√ß√£o de senha, etc.

function corrigirData(dataInput) {
  const data = new Date(dataInput + 'T12:00:00'); 
  const ano = data.getFullYear();
  const mes = String(data.getMonth() + 1).padStart(2, '0');
  const dia = String(data.getDate()).padStart(2, '0');
  return `${ano}-${mes}-${dia}`;
}
function mostrarLoading(show) {
  const loading = document.getElementById("loading");
  if(show) loading.classList.add("show");
  else loading.classList.remove("show");
}
function atualizarStatusSync(sincronizado) {
  const status = document.getElementById("syncStatus");
  const text = document.getElementById("syncText");
  if(sincronizado) {
    status.classList.remove("offline");
    text.innerText = "‚úì Sincronizado";
  } else {
    status.classList.add("offline");
    text.innerText = "‚ö† Offline";
  }
}
function atualizarCardsGlobais(dataList) {
    let totalPagarGlobal = 0, totalReceberGlobal = 0;
    let gastoHojeGlobal = 0, gastoMesGlobal = 0;
    let totalVencidos = 0;
    let vencemSeteDias = 0;
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const hojeStr = hoje.toISOString().split('T')[0];
    const limiteSeteDias = new Date(hoje);
    limiteSeteDias.setDate(hoje.getDate() + 7);
    const mesAtual = new Date().getMonth();
    const anoAtual = new Date().getFullYear();
    let totalRecebidoGlobal = 0;
    let totalGastoGlobal = 0;
    dataList.forEach(r => {
        const dataRegistro = new Date(r.data + 'T12:00:00');
        const valor = parseFloat(r.valor);
        if (r.tipo === "Pagar") {
            if (r.status === "Pendente") totalPagarGlobal += valor;
        } else if (r.tipo === "Receber") {
            if (r.status === "Pendente") totalReceberGlobal += valor;
        }
        if (r.data === hojeStr && r.tipo === "Pagar" && r.status === "Pago") {
            gastoHojeGlobal += valor;
        }
        if (dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual && r.tipo === "Pagar" && r.status === "Pago") {
            gastoMesGlobal += valor;
        }
        if (r.tipo === "Pagar" && r.status === "Pendente") {
            if (dataRegistro < hoje) {
                totalVencidos += valor;
            }
            if (dataRegistro >= hoje && dataRegistro <= limiteSeteDias) {
                vencemSeteDias += valor;
            }
        }
        if (r.tipo === "Receber" && (r.status === "Recebido" || r.status === "Pago")) {
            totalRecebidoGlobal += valor;
        }
        if (r.tipo === "Pagar" && (r.status === "Pago" || r.status === "Recebido")) {
            totalGastoGlobal += valor;
        }
    });
    const rendaLiquida = totalRecebidoGlobal - totalGastoGlobal;
    document.getElementById("rendaLiquidaDisponivel").innerText = formatarMoeda(rendaLiquida);
    let entradaRealizadaMes = dataList.filter(r =>
        r.tipo === "Receber" &&
        (r.status === "Recebido" || r.status === "Pago") &&
        new Date(r.data + 'T12:00:00').getMonth() === mesAtual &&
        new Date(r.data + 'T12:00:00').getFullYear() === anoAtual
    ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
    let saidaRealizadaMes = dataList.filter(r =>
        r.tipo === "Pagar" &&
        (r.status === "Pago" || r.status === "Recebido") &&
        new Date(r.data + 'T12:00:00').getMonth() === mesAtual &&
        new Date(r.data + 'T12:00:00').getFullYear() === anoAtual
    ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
    const saldoMesAtual = entradaRealizadaMes - saidaRealizadaMes;
    let saldoTotal3M = 0;
    let mesesContados = 0;
    for (let i = 1; i <= 3; i++) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const mesAnterior = d.getMonth();
        const anoAnterior = d.getFullYear();
        const entradaAnt = dataList.filter(r =>
            r.tipo === "Receber" &&
            (r.status === "Recebido" || r.status === "Pago") &&
            new Date(r.data + 'T12:00:00').getMonth() === mesAnterior &&
            new Date(r.data + 'T12:00:00').getFullYear() === anoAnterior
        ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
        const saidaAnt = dataList.filter(r =>
            r.tipo === "Pagar" &&
            (r.status === "Pago" || r.status === "Recebido") &&
            new Date(r.data + 'T12:00:00').getMonth() === mesAnterior &&
            new Date(r.data + 'T12:00:00').getFullYear() === anoAnterior
        ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
        if (entradaAnt > 0 || saidaAnt > 0) {
            saldoTotal3M += (entradaAnt - saidaAnt);
            mesesContados++;
        }
    }
    const media3Meses = mesesContados > 0 ? saldoTotal3M / mesesContados : 0;
    document.getElementById("media3Meses").innerText = formatarMoeda(media3Meses);
    document.getElementById("sobraFaltaMes").innerText = formatarMoeda(saldoMesAtual);
    const cardSobra = document.getElementById("cardSobraMes");
    cardSobra.classList.remove('card-sobra', 'card-falta');
    if (saldoMesAtual >= 0) {
        cardSobra.classList.add('card-sobra');
    } else {
        cardSobra.classList.add('card-falta');
    }
    document.getElementById("totalPagar").innerText = formatarMoeda(totalPagarGlobal);
    document.getElementById("totalReceber").innerText = formatarMoeda(totalReceberGlobal);
    document.getElementById("totalDia").innerText = formatarMoeda(totalReceberGlobal - totalPagarGlobal);
    document.getElementById("gastoHoje").innerText = formatarMoeda(gastoHojeGlobal);
    document.getElementById("totalVencidos").innerText = formatarMoeda(totalVencidos);
    document.getElementById("vencemSeteDias").innerText = formatarMoeda(vencemSeteDias);
    const cardVencidos = document.getElementById("cardVencidos");
    if (totalVencidos > 0) {
        cardVencidos.classList.add("pulsing");
    } else {
        cardVencidos.classList.remove("pulsing");
    }
    atualizarCardMeta(gastoHojeGlobal, gastoMesGlobal);
    atualizarCardObjetivo();
    atualizarContadoresFiltros(dataList);
    atualizarCategoryMetas(dataList);
    renderizarCalendario(dataList, calendarioMesAtual);
    exibirMetaCategoria(document.getElementById("categoria").value);
}
function mostrarRegistros(lista){
  const tbody = document.querySelector("#tabelaFinance tbody");
  tbody.innerHTML="";
  lista.sort((a, b) => {
      let valA = a[ordenacaoAtual.chave];
      let valB = b[ordenacaoAtual.chave];
      if (ordenacaoAtual.chave === 'valor') {
          valA = parseFloat(valA);
          valB = parseFloat(valB);
      } else if (ordenacaoAtual.chave === 'data') {
          valA = new Date(valA);
          valB = new Date(valB);
      } else if (ordenacaoAtual.chave === 'fav') {
          valA = a.fav ? 1 : 0;
          valB = b.fav ? 1 : 0;
      }
      if (typeof valA === 'string' && typeof valB === 'string') {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
      }
      if (valA < valB) return ordenacaoAtual.direcao === 'asc' ? -1 : 1;
      if (valA > valB) return ordenacaoAtual.direcao === 'asc' ? 1 : -1;
      return 0;
  });
  if (lista === registros) {
      atualizarCardsGlobais(registros);
  }
  lista.forEach(r=>{
    const tr=document.createElement("tr");
    const tipoBadge=r.tipo==="Pagar"?"badge-pagar":"badge-receber";
    const statusBadge=r.status==="Pendente"?"badge-pendente":(r.status==="Pago"||r.status==="Recebido")?"badge-pago":"badge-pendente";
    const starClass = r.fav ? "star" : "star-empty";
    let camposAdicionais = `${r.campo2||'-'} ${r.campo3||''}`;
    if (r.recorrente === 'Sim') camposAdicionais += ' [REC]';
    if (r.parcelaTotal && r.parcelaTotal > 1) camposAdicionais += ` [${r.parcelaAtual}/${r.parcelaTotal}]`;
    let valorDisplay = formatarMoeda(parseFloat(r.valor));
    let acoesHtml = `<button class="btn-edit" onclick="editar(${r.row})">Editar</button><button class="btn-danger" onclick="excluir(${r.row})">Excluir</button>`;
    if (r.valorOriginal && parseFloat(r.valorOriginal) > parseFloat(r.valor)) {
        valorDisplay = `<span style="text-decoration:line-through; color:var(--pagar-color);">${formatarMoeda(parseFloat(r.valorOriginal))}</span> ${formatarMoeda(parseFloat(r.valor))}`;
    }
    if (r.tipo === 'Pagar' && r.status === 'Pendente') {
         acoesHtml = `<button class="btn-partial" onclick="pagamentoParcial(${r.row})">Parcial</button> ` + acoesHtml;
    }
    tr.innerHTML=`
      <td><span class="${starClass}" onclick="toggleFav(${r.row})">‚òÖ</span></td>
      <td>${new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
      <td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
      <td>${r.descricao}</td>
      <td>${r.categoria || '-'}</td>
      <td><strong>${valorDisplay}</strong></td>
      <td>${r.conta || 'N/A'}</td>
      <td><span class="badge ${statusBadge}" onclick="mudarStatus(${r.row})" style="cursor:pointer;">${r.status}</span></td>
      <td>${camposAdicionais}</td>
      <td>
        <div class="actions">
          ${acoesHtml}
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
  atualizarGraficos(registros); 
}
function ordenarTabela(chave) {
    if (ordenacaoAtual.chave === chave) {
        ordenacaoAtual.direcao = ordenacaoAtual.direcao === 'asc' ? 'desc' : 'asc';
    } else {
        ordenacaoAtual.chave = chave;
        ordenacaoAtual.direcao = chave === 'data' || chave === 'valor' ? 'desc' : 'asc';
    }
    document.querySelectorAll('[id^="sort-"]').forEach(span => {
        span.textContent = '';
        span.style.color = 'var(--text-secondary-dark)';
    });
    const indicador = document.getElementById(`sort-${chave}`);
    if (indicador) {
        indicador.textContent = ordenacaoAtual.direcao === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        indicador.style.color = 'var(--primary-color)';
    }
    aplicarFiltros(); 
}
function atualizarGraficos(dataList){
  const fontColor = currentTheme === 'light' ? '#1e293b' : '#e8eaf0';
  const gridColor = currentTheme === 'light' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
  const gastosRealizados = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pago");
  const pagamentosPendentes = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pendente");
  const entradasRealizadas = dataList.filter(r => r.tipo === "Receber" && r.status === "Recebido");
  const saidasRealizadas = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pago");
  const gastosPendentesPorCategoria = pagamentosPendentes.reduce((acc, r) => {
    acc[r.categoria] = (acc[r.categoria] || 0) + parseFloat(r.valor);
    return acc;
  }, {});
  const categoriasLabels = Object.keys(gastosPendentesPorCategoria);
  const categoriasValores = Object.values(gastosPendentesPorCategoria);
  const ctx=document.getElementById('graficoTipo').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels: categoriasLabels,
      datasets:[{
        data: categoriasValores,
        backgroundColor:['#ef4444','#10b981','#6366f1','#f59e0b','#8b5cf6','#f97316','#3b82f6','#ec4899','#64748b'],
        borderColor: currentTheme === 'light' ? '#ffffff' : '#1a1f3a',
        borderWidth:2
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom',labels:{color:fontColor,font:{size:11,weight:'600'}}},
        title: {display: true, text: 'Pendentes a Pagar', color: fontColor, font:{size:13,weight:'600'}}
      }
    }
  });
  const dadosFluxo = {};
  const dataInicioFluxo = new Date();
  dataInicioFluxo.setMonth(dataInicioFluxo.getMonth() - 5);
  dataInicioFluxo.setDate(1);
  entradasRealizadas.concat(saidasRealizadas).forEach(r => {
    const dataRegistro = new Date(r.data + 'T12:00:00');
    if (dataRegistro >= dataInicioFluxo) {
        const mesAno = dataRegistro.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
        if (!dadosFluxo[mesAno]) dadosFluxo[mesAno] = { entrada: 0, saida: 0 };
        if (r.tipo === "Receber") dadosFluxo[mesAno].entrada += parseFloat(r.valor);
        else if (r.tipo === "Pagar") dadosFluxo[mesAno].saida += parseFloat(r.valor);
    }
  });
  const mesesFluxo = Object.keys(dadosFluxo).sort((a, b) => {
    const [mesA, anoA] = a.split('/');
    const [mesB, anoB] = b.split('/');
    let dateA, dateB;
    try {
        dateA = new Date(`01 ${mesA} 20${anoA}`);
        dateB = new Date(`01 ${mesB} 20${anoB}`);
    } catch (e) {
        return a.localeCompare(b);
    }
    return dateA - dateB;
  });
  const ctxFluxoCaixa = document.getElementById('graficoFluxoCaixa').getContext('2d');
  if(chartFluxoCaixa) chartFluxoCaixa.destroy();
  chartFluxoCaixa = new Chart(ctxFluxoCaixa, {
    type: 'bar',
    data: {
      labels: mesesFluxo,
      datasets: [
        {
          label: 'Entradas',
          data: mesesFluxo.map(m => dadosFluxo[m].entrada),
          backgroundColor: '#10b981',
          stack: 'stack1'
        },
        {
          label: 'Sa√≠das',
          data: mesesFluxo.map(m => -dadosFluxo[m].saida),
          backgroundColor: '#ef4444',
          stack: 'stack1'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 11, weight: '600'}}},
        title: {display: true, text: 'Fluxo Mensal Realizado', color: fontColor, font:{size:13,weight:'600'}}
      },
      scales: {
        x: {ticks: {color: fontColor}, grid: {color: gridColor}},
        y: {ticks: {color: fontColor, callback: function(value) { return formatarMoeda(value); }}, grid: {color: gridColor}}
      }
    }
  });
  const hoje = new Date();
  const mesAtualNome = hoje.toLocaleDateString('pt-BR', { month: 'long' });
  const mesAnterior = new Date(hoje);
  mesAnterior.setMonth(hoje.getMonth() - 1);
  const mesAnteriorNome = mesAnterior.toLocaleDateString('pt-BR', { month: 'long' });
  const categoriaLabelsComp = ["Receitas", "Despesas"];
  let receitaAtual = 0, despesaAtual = 0;
  let receitaAnterior = 0, despesaAnterior = 0;
  dataList.forEach(r => {
    const dataRegistro = new Date(r.data + 'T12:00:00');
    const valor = parseFloat(r.valor);
    if (dataRegistro.getMonth() === new Date().getMonth() && dataRegistro.getFullYear() === new Date().getFullYear()) {
      if (r.tipo === "Receber" && (r.status === "Recebido" || r.status === "Pago")) receitaAtual += valor;
      else if (r.tipo === "Pagar" && (r.status === "Pago" || r.status === "Recebido")) despesaAtual += valor;
    }
    if (dataRegistro.getMonth() === mesAnterior.getMonth() && dataRegistro.getFullYear() === mesAnterior.getFullYear()) {
      if (r.tipo === "Receber" && (r.status === "Recebido" || r.status === "Pago")) receitaAnterior += valor;
      else if (r.tipo === "Pagar" && (r.status === "Pago" || r.status === "Recebido")) despesaAnterior += valor;
    }
  });
  const ctxCompMensal = document.getElementById('graficoComparativoMensal').getContext('2d');
  if(chartCompMensal) chartCompMensal.destroy();
  chartCompMensal = new Chart(ctxCompMensal, {
    type: 'bar',
    data: {
      labels: categoriaLabelsComp,
      datasets: [
        {
          label: `${mesAnteriorNome}`,
          data: [receitaAnterior, despesaAnterior],
          backgroundColor: 'rgba(99,102,241, 0.6)' 
        },
        {
          label: `${mesAtualNome}`,
          data: [receitaAtual, despesaAtual],
          backgroundColor: 'rgba(16,185,129, 0.8)' 
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {position: 'bottom', labels: {color: fontColor, font: {size: 11, weight: '600'}}},
        title: {display: true, text: 'Comparativo Realizado', color: fontColor, font:{size:13,weight:'600'}}
      },
      scales: {
        x: {ticks: {color: fontColor}, grid: {color: gridColor}},
        y: {beginAtZero: true, ticks: {color: fontColor, callback: function(value) { return formatarMoeda(value); }}, grid: {color: gridColor}}
      }
    }
  });
  const gastosPorDia = {};
  const hojeDia = new Date();
  for(let i = 6; i >= 0; i--) {
    const data = new Date(hojeDia);
    data.setDate(data.getDate() - i);
    const chave = data.toISOString().split('T')[0];
    gastosPorDia[chave] = 0;
  }
  gastosRealizados.forEach(r => {
    if(gastosPorDia.hasOwnProperty(r.data)) {
      gastosPorDia[r.data] += parseFloat(r.valor);
    }
  });
  const diasLabels = Object.keys(gastosPorDia).map(d => new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'}));
  const diasValores = Object.values(gastosPorDia);
  const ctxDiario = document.getElementById('graficoDiario').getContext('2d');
  if(chartDiario) chartDiario.destroy();
  chartDiario = new Chart(ctxDiario, {
    type: 'line',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Gastos Di√°rios',
        data: diasValores,
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#ef4444',
        pointBorderColor: currentTheme === 'light' ? '#1e293b' : '#fff',
        pointBorderWidth: 2,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 11, weight: '600'}}}
      },
      scales: {
        y: {beginAtZero: true, ticks: {color: fontColor}, grid: {color: gridColor}},
        x: {ticks: {color: fontColor}, grid: {color: gridColor}}
      }
    }
  });
  const gastosPorMesECategoria = {};
  const categorias = ["Alimenta√ß√£o", "Moradia/Aluguel", "Transporte", "Lazer", "Sa√∫de", "Educa√ß√£o", "Outros"];
  const mesesLabels = [];
  for(let i = 0; i < 12; i++) {
    const d = new Date();
    d.setMonth(d.getMonth() - i);
    const mes = d.getMonth();
    const ano = d.getFullYear();
    const nomeMes = new Date(ano, mes, 1).toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
    mesesLabels.push(nomeMes);
    gastosPorMesECategoria[nomeMes] = {};
    categorias.forEach(cat => gastosPorMesECategoria[nomeMes][cat] = 0);
  }
  mesesLabels.reverse();
  gastosRealizados.forEach(r => {
    if(categorias.includes(r.categoria)) {
      const dataParse = new Date(r.data + 'T12:00:00');
      const nomeMes = dataParse.toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
      if(gastosPorMesECategoria.hasOwnProperty(nomeMes)) {
        gastosPorMesECategoria[nomeMes][r.categoria] += parseFloat(r.valor);
      }
    }
  });
  const categoryColors = {
      "Alimenta√ß√£o": "#ef4444", "Moradia/Aluguel": "#3b82f6", "Transporte": "#f97316", 
      "Lazer": "#10b981", "Sa√∫de": "#8b5cf6", "Educa√ß√£o": "#f59e0b", "Outros": "#64748b"
  };
  const datasets = categorias.map(cat => ({
      label: cat,
      data: mesesLabels.map(mes => gastosPorMesECategoria[mes][cat]),
      backgroundColor: categoryColors[cat]
  }));
  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  if(chartMensal) chartMensal.destroy();
  chartMensal = new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: mesesLabels,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 10, weight: '600'}}},
        title: {display: true, text: 'Gastos por Categoria/M√™s', color: fontColor, font:{size:13,weight:'600'}}
      },
      scales: {
        x: {stacked: true, ticks: {color: fontColor}, grid: {color: gridColor}},
        y: {stacked: true, beginAtZero: true, ticks: {color: fontColor, callback: function(value) { return formatarMoeda(value); }}, grid: {color: gridColor}}
      }
    }
  });
}
function toggleParcelaRecorrente() {
    const tipo = document.getElementById("tipo").value;
    const parcelamentoGroup = document.getElementById("parcelamentoGroup");
    const recorrenciaGroup = document.getElementById("recorrenciaGroup");
    if (tipo === 'Pagar') {
        parcelamentoGroup.style.display = 'block';
        recorrenciaGroup.style.display = 'block';
    } else {
        parcelamentoGroup.style.display = 'none';
        document.getElementById("parcelas").value = 1;
        recorrenciaGroup.style.display = 'block';
    }
    if (parseInt(document.getElementById("parcelas").value) > 1) {
        document.getElementById("recorrencia").value = 'Nao';
        document.getElementById("recorrencia").disabled = true;
    } else {
        document.getElementById("recorrencia").disabled = false;
    }
}
async function enviarParaPlanilha(dados){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify(dados)
    });
    const result = await resp.json();
    atualizarStatusSync(true);
    mostrarLoading(false);
    return result;
  }catch(e){
    console.error("Erro ao sincronizar:",e);
    atualizarStatusSync(false);
    mostrarLoading(false);
    alert("‚ö†Ô∏è Erro ao sincronizar. Verifique sua conex√£o.");
  }
}
async function carregarRegistros(){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify({action:'get'})
    });
    const data = await resp.json();
    if(Array.isArray(data)) {
      registros = data.map((r, idx) => ({
          ...r, 
          row: idx + 1, 
          fav: r.fav || false,
          categoria: r.categoria || r.campo1 || 'Outros',
          conta: r.conta || 'Conta Corrente',
          recorrente: r.recorrente || 'Nao',
          parcelaAtual: parseInt(r.parcelaAtual) || 1,
          parcelaTotal: parseInt(r.parcelaTotal) || 1,
          valorOriginal: r.valorOriginal ? parseFloat(r.valorOriginal) : null
      }));
      atualizarStatusSync(true);
      aplicarFiltros(); 
    }
  }catch(e){
    console.error("Erro ao carregar:",e);
    atualizarStatusSync(false);
  }
  mostrarLoading(false);
}
function aplicarRegrasAutomacao(descricao, categoria) {
    if (categoria && categoria !== 'Selecione a Categoria' && document.getElementById("categoriaSugerida").value !== '') {
        return categoria;
    }
    const termoNormalizado = descricao.toLowerCase().trim();
    for (const regra of regrasAutomacao) {
        if (termoNormalizado.includes(regra.termo)) {
            return regra.categoria;
        }
    }
    return categoria;
}
document.getElementById("financeForm").addEventListener("submit",function(e){
  e.preventDefault();
  const tipo=document.getElementById("tipo").value;
  const descricao=document.getElementById("descricao").value;
  const valor=parseFloat(document.getElementById("valor").value);
  const status=document.getElementById("status").value;
  let categoria=document.getElementById("categoria").value;
  const conta=document.getElementById("conta").value;
  const campo2=document.getElementById("campo2").value;
  const campo3=document.getElementById("campo3").value;
  const recorrente = document.getElementById("recorrencia").value;
  const parcelas = tipo === 'Pagar' ? parseInt(document.getElementById("parcelas").value) : 1;
  if(!categoria || categoria === 'Selecione a Categoria') {
     categoria = document.getElementById("categoriaSugerida").value || 'Outros';
  }
  if(!categoria || categoria === 'Selecione a Categoria') {
    alert("Preencha a Categoria (obrigat√≥ria).");
    return;
  }
  const row=document.getElementById("row").value;
  const sheetRowId=document.getElementById("sheetRowId").value;
  if(row) {
    const idx = registros.findIndex(r=>r.id == sheetRowId);
    if(idx !== -1) {
      const registroExistente = registros[idx];
      const dadosRegistro = {
        data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status, 
        categoria, campo2, campo3, conta, recorrente,
        parcelaAtual: registroExistente.parcelaAtual, parcelaTotal: registroExistente.parcelaTotal,
        valorOriginal: registroExistente.valorOriginal || (registroExistente.valor !== valor ? registroExistente.valor : null) 
      };
      registros[idx]={...registroExistente,...dadosRegistro, row:parseInt(row)};
      enviarParaPlanilha({...registros[idx], action:'update', campo1: categoria});
    }
    document.getElementById("row").value="";
    document.getElementById("sheetRowId").value="";
  } else {
    if(tipo === 'Pagar' && parcelas > 1) {
        for(let i = 1; i <= parcelas; i++) {
            const dataParcela = new Date(document.getElementById("data").value + 'T12:00:00');
            dataParcela.setMonth(dataParcela.getMonth() + (i - 1));
            const novoRegistro = {
                data: corrigirData(dataParcela.toISOString().split('T')[0]), 
                tipo, descricao: `${descricao} (${i}/${parcelas})`, 
                valor: valor, status, categoria, campo2, campo3, conta, 
                recorrente: 'Nao', 
                parcelaAtual: i, 
                parcelaTotal: parcelas,
                row: registros.length + i, 
                fav: false
            };
            registros.push(novoRegistro);
            enviarParaPlanilha({...novoRegistro, action:'add', campo1: categoria});
        }
    } 
    else if (recorrente === 'Sim') {
        const novoRegistro = {
            data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status, 
            categoria, campo2, campo3, conta, recorrente,
            parcelaAtual: 1, parcelaTotal: 1,
            row: registros.length + 1, fav: false
        };
        registros.push(novoRegistro);
        enviarParaPlanilha({...novoRegistro, action:'add', campo1: categoria});
        alert(`‚úÖ Recorrente salvo!`);
    }
    else {
        const novoRegistro = {
            data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status, 
            categoria, campo2, campo3, conta, recorrente: 'Nao',
            parcelaAtual: 1, parcelaTotal: 1,
            row: registros.length + 1, fav: false
        };
        registros.push(novoRegistro);
        enviarParaPlanilha({...novoRegistro, action:'add', campo1: categoria});
    }
  }
  this.reset();
  document.getElementById("data").valueAsDate=new Date();
  document.getElementById("parcelas").value = 1;
  document.getElementById("recorrencia").value = 'Nao';
  document.getElementById("categoriaSugerida").value = '';
  document.getElementById("sugestaoEmoji").style.display = 'none';
  exibirMetaCategoria(document.getElementById("categoria").value);
  toggleParcelaRecorrente();
  mostraApenasFav = false;
  document.getElementById("btnFiltrarFav").classList.remove("active");
  aplicarFiltros(); 
  document.getElementById("descricao").focus();
});
document.getElementById("filtroPeriodo").addEventListener("change", function() {
    const customDaysInput = document.getElementById("customDaysInput");
    if (this.value === 'customDays') {
        customDaysInput.style.display = 'block';
    } else {
        customDaysInput.style.display = 'none';
        document.getElementById("diasCustomizados").value = '';
    }
    aplicarFiltros();
});
document.getElementById("diasCustomizados").addEventListener("input", aplicarFiltros);
function aplicarFiltros() {
    const termo = document.getElementById("buscar").value.toLowerCase();
    const categoriaFiltro = document.getElementById("filtroCategoria").value;
    const periodoSelecionado = document.getElementById("filtroPeriodo").value; 
    let dataInicioStr = document.getElementById("dataInicio").value;
    let dataFimStr = document.getElementById("dataFim").value;
    const diasCustomizados = document.getElementById("diasCustomizados").value;
    const summaryDiv = document.getElementById("periodSummary");
    let filtrados = registros;
    let totalPagarPeriodo = 0;
    let totalReceberPeriodo = 0;
    let dataFiltroAtivo = false;
    let dataInicioFiltro, dataFimFiltro;
    if (periodoSelecionado !== 'all') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); 
        dataFimFiltro = new Date();
        dataFimFiltro.setHours(23, 59, 59, 999); 
        if (periodoSelecionado === '1') {
            dataInicioFiltro = hoje;
        } else if (periodoSelecionado === '2-30') {
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - 30);
            dataInicioFiltro = inicio; 
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1); 
            dataFimFiltro = new Date(ontem.toISOString().split('T')[0] + 'T23:59:59'); 
        } else if (periodoSelecionado === 'customDays' && diasCustomizados) {
            const dias = parseInt(diasCustomizados);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            } else {
                dataFiltroAtivo = false;
            }
        }
        else {
            const dias = parseInt(periodoSelecionado);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1)); 
            }
        }
        if (dataInicioFiltro && dataFimFiltro) {
            dataFiltroAtivo = true; 
        }
        dataInicioStr = '';
        dataFimStr = '';
    }
    if (dataInicioStr && dataFimStr) {
        dataInicioFiltro = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        dataFimFiltro = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
        dataFiltroAtivo = true;
    }
    if (dataFiltroAtivo) {
        filtrados = filtrados.filter(r => {
            const dataRegistro = new Date(r.data + 'T12:00:00'); 
            return dataRegistro >= dataInicioFiltro && dataRegistro <= dataFimFiltro;
        });
    }
    if (filtroStatusAtual !== 'todos') {
        if (filtroStatusAtual === 'tipo-pagar') {
            filtrados = filtrados.filter(r => r.tipo === 'Pagar');
        } else if (filtroStatusAtual === 'tipo-receber') {
            filtrados = filtrados.filter(r => r.tipo === 'Receber');
        } else {
            filtrados = filtrados.filter(r => r.status === filtroStatusAtual);
        }
    }
    if (mostraApenasFav) {
        filtrados = filtrados.filter(r => r.fav);
    }
    if (categoriaFiltro !== 'all') {
        filtrados = filtrados.filter(r => r.categoria === categoriaFiltro);
    }
    if (termo) {
        filtrados = filtrados.filter(r => 
            r.descricao.toLowerCase().includes(termo) || 
            r.tipo.toLowerCase().includes(termo) || 
            r.categoria.toLowerCase().includes(termo) ||
            r.conta.toLowerCase().includes(termo) ||
            r.data.includes(termo)
        );
    }
    totalPagarPeriodo = filtrados.filter(r => r.tipo === "Pagar").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    totalReceberPeriodo = filtrados.filter(r => r.tipo === "Receber").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    if (dataFiltroAtivo || mostraApenasFav || termo || filtroStatusAtual !== 'todos' || categoriaFiltro !== 'all') {
        document.getElementById("summaryPagar").innerText = formatarMoeda(totalPagarPeriodo);
        document.getElementById("summaryReceber").innerText = formatarMoeda(totalReceberPeriodo);
        document.getElementById("summarySaldo").innerText = formatarMoeda(totalReceberPeriodo - totalPagarPeriodo);
        summaryDiv.style.display = 'flex';
    } else {
        summaryDiv.style.display = 'none';
    }
    mostrarRegistros(filtrados);
}
function limparFiltros() {
    document.getElementById("buscar").value = '';
    document.getElementById("filtroCategoria").value = 'all';
    document.getElementById("filtroPeriodo").value = '1';
    document.getElementById("customDaysInput").style.display = 'none';
    document.getElementById("diasCustomizados").value = '';
    document.getElementById("dataInicio").value = '';
    document.getElementById("dataFim").value = '';
    mostraApenasFav = false;
    document.getElementById("btnFiltrarFav").classList.remove("active");
    filtroStatusAtual = 'todos';
    document.querySelectorAll('.status-filter-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.filter-todos').classList.add('active');
    aplicarFiltros();
}
document.getElementById("buscar").addEventListener("input", aplicarFiltros);
document.getElementById("btnFiltrarData").addEventListener("click", aplicarFiltros);
document.getElementById("btnFiltrarFav").addEventListener("click", function(){
  mostraApenasFav = !mostraApenasFav;
  this.classList.toggle("active");
  aplicarFiltros();
});
function atualizarContadoresFiltros(dataList) {
    const countTodos = dataList.length;
    const countPendente = dataList.filter(r => r.status === "Pendente").length;
    const countPago = dataList.filter(r => r.status === "Pago").length;
    const countRecebido = dataList.filter(r => r.status === "Recebido").length;
    const countPagar = dataList.filter(r => r.tipo === "Pagar").length;
    const countReceber = dataList.filter(r => r.tipo === "Receber").length;
    document.getElementById("countTodos").innerText = countTodos;
    document.getElementById("countPendente").innerText = countPendente;
    document.getElementById("countPago").innerText = countPago;
    document.getElementById("countRecebido").innerText = countRecebido;
    document.getElementById("countPagar").innerText = countPagar;
    document.getElementById("countReceber").innerText = countReceber;
}
function filtrarPorStatus(tipo) {
    filtroStatusAtual = tipo;
    document.querySelectorAll('.status-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    if(tipo === 'todos') {
        document.querySelector('.filter-todos').classList.add('active');
    } else if(tipo === 'Pendente') {
        document.querySelector('.filter-pendente').classList.add('active');
    } else if(tipo === 'Pago') {
        document.querySelector('.filter-pago').classList.add('active');
    } else if(tipo === 'Recebido') {
        document.querySelector('.filter-recebido').classList.add('active');
    } else if(tipo === 'tipo-pagar') {
        document.querySelector('.filter-pagar').classList.add('active');
    } else if(tipo === 'tipo-receber') {
        document.querySelector('.filter-receber').classList.add('active');
    }
    aplicarFiltros();
}
function atualizarCardMeta(gastoHoje, gastoMes) {
    const label = metaTipo === 'diario' ? 'Meta de Gastos (Dia)' : 'Meta de Gastos (M√™s)';
    const gastoAtual = metaTipo === 'diario' ? gastoHoje : gastoMes;
    const percentual = metaValor > 0 ? (gastoAtual / metaValor * 100) : 0;
    document.getElementById("metaLabel").innerText = label;
    document.getElementById("metaValor").innerText = formatarMoeda(metaValor);
    document.getElementById("metaPercentual").innerText = `${percentual.toFixed(1)}% utilizado (${formatarMoeda(gastoAtual)} de ${formatarMoeda(metaValor)})`;
    const progressBar = document.getElementById("metaProgress");
    progressBar.style.width = Math.min(percentual, 100) + '%';
    progressBar.classList.remove('warning', 'danger');
    if(percentual >= 90) {
        progressBar.classList.add('danger');
    } else if(percentual >= 70) {
        progressBar.classList.add('warning');
    }
}
function atualizarCardObjetivo() {
    const valorMensalNecessario = objetivoMeses > 0 ? objetivoEconomia / objetivoMeses : 0;
    document.getElementById("objetivoValorDisplay").innerText = formatarMoeda(objetivoEconomia);
    document.getElementById("objetivoMesesDisplay").innerText = objetivoMeses;
    document.getElementById("objetivoMesesAux").innerText = objetivoMeses;
    document.getElementById("valorMensalPoupar").innerText = formatarMoeda(valorMensalNecessario) + "/m√™s";
}
function editarMeta(type) {
    if (type === 'global') {
        const tipoAtual = metaTipo === 'diario' ? 'Di√°rio' : 'Mensal';
        const novoTipo = prompt(`Tipo de Meta Atual: ${tipoAtual}
Digite:
1 - Para Meta Di√°ria
2 - Para Meta Mensal`, metaTipo === 'diario' ? '1' : '2');
        if(novoTipo === '1') {
            metaTipo = 'diario';
        } else if(novoTipo === '2') {
            metaTipo = 'mensal';
        } else if(novoTipo !== null) {
            alert('Op√ß√£o inv√°lida! Use 1 para Di√°rio ou 2 para Mensal.');
            return;
        } else {
            return;
        }
        const novoValor = prompt(`Meta de Gastos ${metaTipo === 'diario' ? 'Di√°ria' : 'Mensal'}:
Valor Atual: R$ ${metaValor.toFixed(2)}
Digite o novo valor (ex: 5000):`, metaValor);
        if(novoValor !== null) {
            const valorParseado = parseFloat(novoValor.replace(',', '.'));
            if(!isNaN(valorParseado) && valorParseado > 0) {
                metaValor = valorParseado;
                localStorage.setItem('metaTipo', metaTipo);
                localStorage.setItem('metaValor', metaValor);
                const hoje = new Date();
                const hojeStr = hoje.toISOString().split('T')[0];
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                let gastoHoje = 0, gastoMes = 0;
                registros.forEach(r => {
                    const dataRegistro = new Date(r.data + 'T12:00:00');
                    const valor = parseFloat(r.valor);
                    if(r.data === hojeStr && r.tipo === "Pagar" && r.status === "Pago") gastoHoje += valor;
                    if(dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual && r.tipo === "Pagar" && r.status === "Pago") gastoMes += valor;
                });
                atualizarCardMeta(gastoHoje, gastoMes);
                alert(`‚úÖ Meta ${metaTipo === 'diario' ? 'Di√°ria' : 'Mensal'} atualizada para ${formatarMoeda(metaValor)}`);
            } else {
                alert('‚ùå Valor inv√°lido! Digite um n√∫mero positivo.');
            }
        }
    } else if (type === 'objetivo') {
        const novoObjetivo = prompt(`Objetivo de Economia/Investimento:
Valor Atual: R$ ${objetivoEconomia.toFixed(2)}
Digite o valor total do objetivo (ex: 10000):`, objetivoEconomia);
        if (novoObjetivo !== null) {
            const valorParseado = parseFloat(novoObjetivo.replace(',', '.'));
            if (!isNaN(valorParseado) && valorParseado > 0) {
                objetivoEconomia = valorParseado;
                localStorage.setItem('objetivoEconomia', objetivoEconomia);
            } else {
                alert('‚ùå Valor do Objetivo inv√°lido!');
                return;
            }
        } else {
            return;
        }
        const novosMeses = prompt(`Prazo (em meses) para o Objetivo:
Prazo Atual: ${objetivoMeses} meses
Digite o novo prazo (ex: 12):`, objetivoMeses);
        if (novosMeses !== null) {
            const mesesParseado = parseInt(novosMeses);
            if (!isNaN(mesesParseado) && mesesParseado > 0) {
                objetivoMeses = mesesParseado;
                localStorage.setItem('objetivoMeses', objetivoMeses);
            } else {
                alert('‚ùå Prazo inv√°lido!');
                return;
            }
        } else {
            return;
        }
        atualizarCardObjetivo();
        alert(`‚úÖ Objetivo atualizado: ${formatarMoeda(objetivoEconomia)} em ${objetivoMeses} meses.`);
    } else {
        const cat = prompt(`Digite a categoria para definir/editar a meta (ex: Alimenta√ß√£o):`);
        if (!cat) return;
        const valorAtual = metasPorCategoria[cat] || 0;
        const novoValorStr = prompt(`Meta de Gastos MENSAL para ${cat}:
Valor Atual: R$ ${valorAtual.toFixed(2)}
Digite o novo valor (0 para remover):`, valorAtual);
        if (novoValorStr !== null) {
            const novoValor = parseFloat(novoValorStr.replace(',', '.'));
            if (!isNaN(novoValor) && novoValor >= 0) {
                if (novoValor === 0) {
                    delete metasPorCategoria[cat];
                    alert(`‚úÖ Meta para ${cat} removida.`);
                } else {
                    metasPorCategoria[cat] = novoValor;
                    alert(`‚úÖ Meta para ${cat} definida em ${formatarMoeda(novoValor)}.`);
                }
                localStorage.setItem('metasPorCategoria', JSON.stringify(metasPorCategoria));
                atualizarCardsGlobais(registros);
                exibirMetaCategoria(document.getElementById("categoria").value);
            } else {
                alert('‚ùå Valor inv√°lido!');
            }
        }
    }
}
function getGastosMesCategoria(categoria) {
    const mesAtual = new Date().getMonth();
    const anoAtual = new Date().getFullYear();
    return registros.filter(r => 
        r.tipo === "Pagar" && 
        (r.status === "Pago" || r.status === "Recebido") &&
        r.categoria === categoria &&
        new Date(r.data + 'T12:00:00').getMonth() === mesAtual && 
        new Date(r.data + 'T12:00:00').getFullYear() === anoAtual
    ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
}
function exibirMetaCategoria(categoria) {
    const indicator = document.getElementById("categoryMetaIndicator");
    const meta = metasPorCategoria[categoria];
    if (!categoria || categoria === 'Selecione a Categoria' || !meta) {
        indicator.style.display = 'none';
        return;
    }
    const gastoAtual = getGastosMesCategoria(categoria);
    const percentual = meta > 0 ? (gastoAtual / meta * 100) : 0;
    document.getElementById("metaValorForm").innerText = formatarMoeda(meta);
    document.getElementById("gastoAtualForm").innerText = formatarMoeda(gastoAtual);
    indicator.style.display = 'block';
    const progressBar = document.getElementById("metaCategoryProgress");
    progressBar.style.width = Math.min(percentual, 100) + '%';
    progressBar.classList.remove('warning', 'danger');
    progressBar.style.backgroundColor = 'var(--receber-color)'; 
    if(percentual >= 100) {
        progressBar.classList.add('danger');
        progressBar.style.backgroundColor = 'var(--pagar-color)';
        document.getElementById("gastoAtualForm").style.color = 'var(--pagar-color)';
    } else if(percentual >= 80) {
        progressBar.classList.add('warning');
        progressBar.style.backgroundColor = 'var(--warning-color)';
        document.getElementById("gastoAtualForm").style.color = 'var(--warning-color)';
    } else {
        progressBar.style.backgroundColor = 'var(--receber-color)';
        document.getElementById("gastoAtualForm").style.color = 'var(--receber-color)';
    }
}
function atualizarCategoryMetas(dataList) {
    const summaryDiv = document.getElementById("categoryMetasSummary");
    summaryDiv.innerHTML = '';
    const gastosMesPorCategoria = dataList.filter(r => r.tipo === "Pagar" && (r.status === "Pago" || r.status === "Recebido"))
        .reduce((acc, r) => {
            const dataRegistro = new Date(r.data + 'T12:00:00');
            const mesAtual = new Date().getMonth();
            const anoAtual = new Date().getFullYear();
            if (dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual) {
                acc[r.categoria] = (acc[r.categoria] || 0) + parseFloat(r.valor);
            }
            return acc;
        }, {});
    const categoriasComMeta = Object.keys(metasPorCategoria).sort();
    if (categoriasComMeta.length === 0) {
        summaryDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary-dark);">Clique no card acima para <span style="cursor:pointer; color:var(--meta-color); font-weight:700;" onclick="editarMeta(\'category\')">definir metas</span>.</div>';
        return;
    }
    categoriasComMeta.forEach(cat => {
        const meta = metasPorCategoria[cat];
        const gasto = gastosMesPorCategoria[cat] || 0;
        const percentual = meta > 0 ? (gasto / meta * 100) : 0;
        const item = document.createElement('div');
        item.classList.add('category-progress-item');
        item.onclick = () => editarMeta('category');
        let progressClass = '';
        let progressColor = 'var(--receber-color)';
        let gastoColor = 'var(--receber-color)';
        if (percentual >= 100) {
            progressClass = 'danger';
            progressColor = 'var(--pagar-color)';
            gastoColor = 'var(--pagar-color)';
        } else if (percentual >= 80) {
            progressClass = 'warning';
            progressColor = 'var(--warning-color)';
            gastoColor = 'var(--warning-color)';
        }
        item.innerHTML = `
            <div class="label">
                <span>${cat}</span>
                <span style="color: ${gastoColor};">
                    ${formatarMoeda(gasto)} / ${formatarMoeda(meta)} 
                    <span style="font-weight: 800;">(${percentual.toFixed(0)}%)</span>
                </span>
            </div>
            <div class="progress-bar" style="height: 6px;">
                <div class="progress-fill ${progressClass}" style="width: ${Math.min(percentual, 100)}%; background-color: ${progressColor};"></div>
            </div>
        `;
        summaryDiv.appendChild(item);
    });
}
function mudarMes(delta) {
    calendarioMesAtual.setMonth(calendarioMesAtual.getMonth() + delta);
    renderizarCalendario(registros, calendarioMesAtual);
}
function renderizarCalendario(dataList, dataBase) {
    const calDiv = document.getElementById('financialCalendar');
    calDiv.innerHTML = '<div class="calendar-header">Dom</div><div class="calendar-header">Seg</div><div class="calendar-header">Ter</div><div class="calendar-header">Qua</div><div class="calendar-header">Qui</div><div class="calendar-header">Sex</div><div class="calendar-header">S√°b</div>';
    const ano = dataBase.getFullYear();
    const mes = dataBase.getMonth();
    document.getElementById('calendarHeader').innerText = dataBase.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    const primeiroDia = new Date(ano, mes, 1);
    const ultimoDia = new Date(ano, mes + 1, 0);
    const diasNoMes = ultimoDia.getDate();
    const diaDaSemanaInicio = primeiroDia.getDay();
    for (let i = 0; i < diaDaSemanaInicio; i++) {
        calDiv.innerHTML += '<div class="calendar-day" style="background:none; border:none; border-top:none; border-bottom:none;"></div>';
    }
    const eventosDoMes = dataList.filter(r => {
        const dataReg = new Date(r.data + 'T12:00:00');
        return dataReg.getFullYear() === ano && dataReg.getMonth() === mes;
    }).reduce((acc, r) => {
        const dia = new Date(r.data + 'T12:00:00').getDate();
        if (!acc[dia]) acc[dia] = { pagar: 0, receber: 0, itens: [] };
        if (r.status === 'Pendente') {
            if (r.tipo === 'Pagar') acc[dia].pagar += parseFloat(r.valor);
            else if (r.tipo === 'Receber') acc[dia].receber += parseFloat(r.valor);
            acc[dia].itens.push(r);
        }
        return acc;
    }, {});
    for (let dia = 1; dia <= diasNoMes; dia++) {
        const diaDiv = document.createElement('div');
        diaDiv.classList.add('calendar-day');
        if (eventosDoMes[dia] && (eventosDoMes[dia].pagar > 0 || eventosDoMes[dia].receber > 0)) {
            diaDiv.classList.add('day-has-events');
            diaDiv.onclick = () => {
                const itens = eventosDoMes[dia].itens.map(i => `${i.tipo}: ${i.descricao} (${formatarMoeda(i.valor)})`).join('\n');
                alert(`Lan√ßamentos para ${dia}/${mes+1}:\n${itens}`);
            };
        }
        let diaHtml = `<span class="calendar-day-number">${dia}</span>`;
        if (eventosDoMes[dia]) {
            if (eventosDoMes[dia].pagar > 0) {
                diaHtml += `<div class="day-pagar">P: ${formatarMoeda(eventosDoMes[dia].pagar)}</div>`;
            }
            if (eventosDoMes[dia].receber > 0) {
                diaHtml += `<div class="day-receber">R: ${formatarMoeda(eventosDoMes[dia].receber)}</div>`;
            }
        }
        diaDiv.innerHTML = diaHtml;
        calDiv.appendChild(diaDiv);
    }
}
function pagamentoParcial(row) {
    const registro = registros.find(r => r.row === row);
    if (!registro || registro.tipo !== 'Pagar' || registro.status !== 'Pendente') return;
    const valorOriginal = registro.valorOriginal || parseFloat(registro.valor);
    const valorAtual = parseFloat(registro.valor);
    const valorPagoStr = prompt(`Pagamento Parcial para:
${registro.descricao} - ${formatarMoeda(valorAtual)}
Digite o valor a pagar (m√°x: ${formatarMoeda(valorAtual)}):`);
    if (valorPagoStr === null) return;
    const valorPago = parseFloat(valorPagoStr.replace(',', '.'));
    if (isNaN(valorPago) || valorPago <= 0) {
        alert("‚ùå Valor inv√°lido.");
        return;
    }
    if (valorPago > valorAtual) {
        alert("‚ùå O valor pago n√£o pode ser maior que o saldo devedor.");
        return;
    }
    const novoValorRestante = valorAtual - valorPago;
    if (novoValorRestante <= 0.01) {
        registro.valor = 0;
        registro.status = 'Pago';
        registro.valorOriginal = valorOriginal; 
        alert(`‚úÖ ${formatarMoeda(valorPago)} pago. Registro marcado como 'Pago'.`);
    } else {
        registro.valor = novoValorRestante.toFixed(2);
        registro.valorOriginal = valorOriginal; 
        alert(`‚úÖ ${formatarMoeda(valorPago)} pago. Saldo restante: ${formatarMoeda(novoValorRestante)}.`);
    }
    enviarParaPlanilha({...registro, action:'update', campo1: registro.categoria});
    aplicarFiltros(); 
}
function mudarStatus(row) {
  const registro = registros.find(r => r.row === row);
  if(!registro) return;
  let novoStatus = registro.status;
  if(registro.status === "Pendente") {
    novoStatus = registro.tipo === "Pagar" ? "Pago" : "Recebido";
    if (registro.valorOriginal && parseFloat(registro.valorOriginal) > parseFloat(registro.valor)) {
        if (!confirm(`O saldo devedor √© ${formatarMoeda(parseFloat(registro.valor))}. Deseja marcar como '${novoStatus}' (assumindo que o restante foi pago)?`)) {
            return;
        }
    }
    if (registro.valorOriginal) {
        registro.valor = registro.valorOriginal;
    }
    registro.valorOriginal = null;
  } else {
    novoStatus = "Pendente";
    registro.valorOriginal = null;
  }
  registro.status = novoStatus;
  enviarParaPlanilha({...registro, action:'update', campo1: registro.categoria});
  aplicarFiltros(); 
}
function exportarExcel(){
    const termo = document.getElementById("buscar").value.toLowerCase();
    const periodoSelecionado = document.getElementById("filtroPeriodo").value; 
    let dataInicioStr = document.getElementById("dataInicio").value;
    let dataFimStr = document.getElementById("dataFim").value;
    const diasCustomizados = document.getElementById("diasCustomizados").value;
    const categoriaFiltro = document.getElementById("filtroCategoria").value;
    let listaExportar = registros;
    let dataFiltroAtivo = false;
    let dataInicioFiltro, dataFimFiltro;
    if (periodoSelecionado !== 'all') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); 
        dataFimFiltro = new Date();
        dataFimFiltro.setHours(23, 59, 59, 999); 
        if (periodoSelecionado === '1') {
            dataInicioFiltro = hoje;
        } else if (periodoSelecionado === '2-30') {
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - 30);
            dataInicioFiltro = inicio; 
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1); 
            dataFimFiltro = new Date(ontem.toISOString().split('T')[0] + 'T23:59:59'); 
        } else if (periodoSelecionado === 'customDays' && diasCustomizados) {
            const dias = parseInt(diasCustomizados);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            } else {
                dataFiltroAtivo = false;
            }
        } else {
            const dias = parseInt(periodoSelecionado);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1)); 
            }
        }
        if (dataInicioFiltro && dataFimFiltro) {
            dataFiltroAtivo = true;
        }
    }
    if (dataInicioStr && dataFimStr) {
        dataInicioFiltro = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        dataFimFiltro = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
        dataFiltroAtivo = true;
    }
    if (dataFiltroAtivo) {
        listaExportar = listaExportar.filter(r => {
            const dataRegistro = new Date(r.data + 'T12:00:00'); 
            return dataRegistro >= dataInicioFiltro && dataRegistro <= dataFimFiltro;
        });
    }
    if (filtroStatusAtual !== 'todos') {
        if (filtroStatusAtual === 'tipo-pagar') {
            listaExportar = listaExportar.filter(r => r.tipo === 'Pagar');
        } else if (filtroStatusAtual === 'tipo-receber') {
            listaExportar = listaExportar.filter(r => r.tipo === 'Receber');
        } else {
            listaExportar = listaExportar.filter(r => r.status === filtroStatusAtual);
        }
    }
    if (mostraApenasFav) {
        listaExportar = listaExportar.filter(r => r.fav);
    }
    if (categoriaFiltro !== 'all') {
        listaExportar = listaExportar.filter(r => r.categoria === categoriaFiltro);
    }
    if (termo) {
        listaExportar = listaExportar.filter(r => 
            r.descricao.toLowerCase().includes(termo) || 
            r.tipo.toLowerCase().includes(termo) || 
            r.categoria.toLowerCase().includes(termo) ||
            r.conta.toLowerCase().includes(termo) ||
            r.data.includes(termo)
        );
    }
  const ws_data=listaExportar.map(r=>[
    r.fav?"‚òÖ":"",
    new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR'),
    r.tipo,
    r.descricao,
    r.categoria || '-',
    r.valor,
    r.valorOriginal ? r.valorOriginal : '',
    r.status,
    r.conta || 'N/A', 
    r.recorrente, 
    r.parcelaTotal > 1 ? `${r.parcelaAtual}/${r.parcelaTotal}` : '', 
    r.campo2||'',
    r.campo3||''
  ]);
  ws_data.unshift(["Fav","Data","Tipo","Descri√ß√£o","Categoria","Valor","Valor Original","Status","Conta","Recorrente","Parcelas","Campo2","Campo3"]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Financeiro");
  XLSX.writeFile(wb,"Controle_Financeiro_Moderno.xlsx");
}
function editar(row){
  const r=registros.find(r=>r.row===row);
  if(r){
    document.getElementById("row").value=r.row;
    document.getElementById("sheetRowId").value=r.id;
    document.getElementById("data").value=r.data;
    document.getElementById("tipo").value=r.tipo;
    document.getElementById("valor").value=r.valorOriginal ? r.valorOriginal : r.valor;
    document.getElementById("status").value=r.status;
    document.getElementById("descricao").value=r.descricao.replace(/\s\(\d+\/\d+\)$/, '');
    document.getElementById("categoria").value=r.categoria || '';
    document.getElementById("conta").value=r.conta || 'Conta Corrente';
    document.getElementById("recorrencia").value=r.recorrente || 'Nao';
    document.getElementById("parcelas").value=r.parcelaTotal || 1;
    document.getElementById("categoriaSugerida").value = '';
    document.getElementById("sugestaoEmoji").style.display = 'none';
    exibirMetaCategoria(r.categoria);
    toggleParcelaRecorrente();
    document.getElementById("campo2").value=r.campo2||'';
    document.getElementById("campo3").value=r.campo3||'';
    window.scrollTo({top:0,behavior:'smooth'});
  }
}
function excluir(row){
  if(confirm("Deseja excluir este registro?")){
    const r = registros.find(r=>r.row===row);
    const idx = registros.findIndex(r=>r.row===row);
    enviarParaPlanilha({...r,action:'delete'});
    registros.splice(idx,1);
    mostraApenasFav = false;
    document.getElementById("btnFiltrarFav").classList.remove("active");
    aplicarFiltros();
  }
}
function toggleFav(row){
  const idx = registros.findIndex(r=>r.row===row);
  registros[idx].fav=!registros[idx].fav;
  enviarParaPlanilha({...registros[idx],action:'update'});
  aplicarFiltros();
}
document.getElementById("descricao").addEventListener("input", function() {
    const categoriaSelecionada = document.getElementById("categoria").value;
    const categoriaSugerida = aplicarRegrasAutomacao(this.value, null);
    document.getElementById("categoriaSugerida").value = categoriaSugerida;
    if (categoriaSugerida && categoriaSugerida !== 'Selecione a Categoria' && (!categoriaSelecionada || categoriaSelecionada === 'Selecione a Categoria')) {
        document.getElementById("categoria").value = categoriaSugerida;
        document.getElementById("sugestaoEmoji").style.display = 'inline';
    } else {
        document.getElementById("sugestaoEmoji").style.display = 'none';
    }
    exibirMetaCategoria(document.getElementById("categoria").value);
});
document.getElementById("categoria").addEventListener("change", function() {
    document.getElementById("categoriaSugerida").value = '';
    document.getElementById("sugestaoEmoji").style.display = 'none';
    exibirMetaCategoria(this.value);
});
function toggleQuickMenu() {
    const quickMenu = document.getElementById('quickMenu');
    quickMenu.classList.toggle('visible');
    if (quickMenu.classList.contains('visible')) {
        document.addEventListener('click', closeQuickMenuOnClickOutside);
    } else {
        document.removeEventListener('click', closeQuickMenuOnClickOutside);
    }
}
function closeQuickMenuOnClickOutside(event) {
    const fabContainer = document.getElementById('fabContainer');
    const quickMenu = document.getElementById('quickMenu');
    if (quickMenu.classList.contains('visible') && !fabContainer.contains(event.target)) {
        quickMenu.classList.remove('visible');
        document.removeEventListener('click', closeQuickMenuOnClickOutside);
    }
}
function focarFormulario(tipo) {
    document.getElementById("tipo").value = tipo;
    toggleParcelaRecorrente();
    document.getElementById("descricao").focus();
    toggleQuickMenu();
    window.scrollTo({top: 0, behavior: 'smooth'});
}
function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}
function toggleStatistics() {
    const modal = document.getElementById('statisticsModal');
    if (modal.style.display === 'flex') {
        closeModal('statisticsModal');
    } else {
        updateMonthlyStatistics();
        modal.style.display = 'flex';
        toggleQuickMenu();
    }
}
function updateMonthlyStatistics() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    const mesNome = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    document.getElementById('statsCurrentMonth').innerText = mesNome.toUpperCase();
    let entradaRealizada = 0;
    let saidaRealizada = 0;
    let entradaPendente = 0;
    let saidaPendente = 0;
    let totalGastos = 0;
    let contagemGastos = 0;
    let gastosPorCategoria = {};
    let totalRegistros = 0;
    registros.forEach(r => {
        const dataRegistro = new Date(r.data + 'T12:00:00');
        if (dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual) {
            totalRegistros++;
            const valor = parseFloat(r.valor);
            if (r.tipo === "Receber") {
                if (r.status === "Recebido" || r.status === "Pago") {
                    entradaRealizada += valor;
                } else if (r.status === "Pendente") {
                    entradaPendente += valor;
                }
            } else if (r.tipo === "Pagar") {
                if (r.status === "Pago" || r.status === "Recebido") {
                    saidaRealizada += valor;
                    totalGastos += valor;
                    contagemGastos++;
                    gastosPorCategoria[r.categoria] = (gastosPorCategoria[r.categoria] || 0) + valor;
                } else if (r.status === "Pendente") {
                    saidaPendente += valor;
                }
            }
        }
    });
    const saldoRealizado = entradaRealizada - saidaRealizada;
    const saldoProjetado = (entradaRealizada + entradaPendente) - (saidaRealizada + saidaPendente);
    const ticketMedio = contagemGastos > 0 ? totalGastos / contagemGastos : 0;
    let categoriaMaisGasta = '-';
    let maxGasto = 0;
    for (const cat in gastosPorCategoria) {
        if (gastosPorCategoria[cat] > maxGasto) {
            maxGasto = gastosPorCategoria[cat];
            categoriaMaisGasta = `${cat} (${formatarMoeda(maxGasto)})`;
        }
    }
    document.getElementById('statsEntradas').innerText = formatarMoeda(entradaRealizada);
    document.getElementById('statsSaidas').innerText = formatarMoeda(saidaRealizada);
    document.getElementById('statsSaldo').innerText = formatarMoeda(saldoRealizado);
    document.getElementById('statsTicketMedio').innerText = formatarMoeda(ticketMedio);
    document.getElementById('statsCategoriaMaisGasta').innerText = categoriaMaisGasta;
    document.getElementById('statsTotalRegistros').innerText = totalRegistros;
    document.getElementById('statsEntradasPendentes').innerText = formatarMoeda(entradaPendente);
    document.getElementById('statsSaidasPendentes').innerText = formatarMoeda(saidaPendente);
    document.getElementById('statsSaldoProjetado').innerText = formatarMoeda(saldoProjetado);
}
document.addEventListener('keydown', (e) => {
    // Atalhos funcionam diretamente, sem checagem de login
    if (e.key === '+' || e.key.toLowerCase() === 'n') {
        e.preventDefault();
        document.getElementById("descricao").focus();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
});
document.getElementById("data").valueAsDate=new Date();
applyTheme();
toggleParcelaRecorrente();
atualizarCardObjetivo();
renderizarCalendario(registros, calendarioMesAtual);
document.getElementById(`sort-${ordenacaoAtual.chave}`).textContent = ordenacaoAtual.direcao === 'asc' ? ' ‚ñ≤' : ' ‚ñº';

// Carregar registros ao iniciar
carregarRegistros();

// Atualiza√ß√£o autom√°tica a cada 10 segundos
setInterval(() => {
  carregarRegistros();
}, 10000);
</script>
</body>
</html>


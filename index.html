<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
  .container{ max-width:1200px; margin:0 auto; }
  header{ text-align:center; color:white; margin-bottom:30px; }
  header h1{ font-size:2.5em; font-weight:300; letter-spacing:2px; margin-bottom:10px; }
  .cards-summary{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px; }
  .card{ background:white; border-radius:15px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; }
  .card:hover{ transform:translateY(-5px); box-shadow:0 15px 40px rgba(0,0,0,0.3); }
  .card-label{ font-size:0.9em; color:#666; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }
  .card-value{ font-size:2em; font-weight:600; margin-bottom:5px; }
  .card-pagar{ border-left:5px solid #ff6b6b; }
  .card-pagar .card-value{ color:#ff6b6b; }
  .card-receber{ border-left:5px solid #51cf66; }
  .card-receber .card-value{ color:#51cf66; }
  .card-saldo{ border-left:5px solid #667eea; }
  .card-saldo .card-value{ color:#667eea; }
  .content{ display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px; }
  .form-section,.chart-section{ background:white; border-radius:15px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
  .form-section h2,.chart-section h2{ font-size:1.3em; margin-bottom:20px; color:#333; }
  .form-group{ margin-bottom:15px; }
  label{ display:block; font-size:0.85em; color:#666; margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px; }
  input,select{ width:100%; padding:12px; border:2px solid #eee; border-radius:8px; font-size:1em; transition:all 0.3s ease; }
  input:focus,select:focus{ outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1); }
  .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  button{ padding:12px 25px; border:none; border-radius:8px; font-size:1em; font-weight:600; cursor:pointer; transition:all 0.3s ease; text-transform:uppercase; letter-spacing:1px; }
  .btn-primary{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; width:100%; }
  .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 10px 20px rgba(102,126,234,0.3); }
  .btn-danger{ background:#ff6b6b; color:white; font-size:0.8em; padding:8px 12px; }
  .btn-danger:hover{ background:#ff5252; }
  .btn-edit{ background:#667eea; color:white; font-size:0.8em; padding:8px 12px; margin-right:5px; }
  .btn-edit:hover{ background:#5568d3; }
  .search-bar{ margin-bottom:20px; }
  .search-bar input{ width:100%; padding:12px; border:2px solid #eee; border-radius:8px; font-size:1em; }
  .table-section{ background:white; border-radius:15px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
  table{ width:100%; border-collapse:collapse; }
  thead{ background:#f8f9fa; }
  th{ padding:15px; text-align:left; font-weight:600; color:#333; border-bottom:2px solid #eee; text-transform:uppercase; font-size:0.85em; letter-spacing:0.5px; }
  td{ padding:15px; border-bottom:1px solid #f0f0f0; }
  tr:hover{ background:#f8f9fa; }
  .badge{ display:inline-block; padding:5px 10px; border-radius:20px; font-size:0.75em; font-weight:600; text-transform:uppercase; }
  .badge-pagar{ background: rgba(255,107,107,0.1); color:#ff6b6b; }
  .badge-receber{ background: rgba(81,207,102,0.1); color:#51cf66; }
  .badge-pendente{ background: rgba(255,193,7,0.1); color:#ffc107; }
  .badge-pago{ background: rgba(81,207,102,0.1); color:#51cf66; }
  .actions{ display:flex; gap:5px; }
  .export-btn{ margin-bottom:20px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }
  @media(max-width:768px){ .content{ grid-template-columns:1fr; } .form-row{ grid-template-columns:1fr; } header h1{ font-size:1.8em; } table{ font-size:0.85em; } td,th{ padding:10px; } }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>💰 Controle Financeiro</h1>
  </header>

  <div class="cards-summary">
    <div class="card card-pagar">
      <div class="card-label">Total a Pagar</div>
      <div class="card-value" id="totalPagar">R$ 0,00</div>
    </div>
    <div class="card card-receber">
      <div class="card-label">Total a Receber</div>
      <div class="card-value" id="totalReceber">R$ 0,00</div>
    </div>
    <div class="card card-saldo">
      <div class="card-label">Saldo do Dia</div>
      <div class="card-value" id="totalDia">R$ 0,00</div>
    </div>
  </div>

  <div class="content">
    <div class="form-section">
      <h2>Novo Registro</h2>
      <form id="financeForm">
        <input type="hidden" id="row">
        <div class="form-row">
          <div class="form-group">
            <label for="data">Data</label>
            <input type="date" id="data" required>
          </div>
          <div class="form-group">
            <label for="tipo">Tipo</label>
            <select id="tipo" required>
              <option value="Pagar">Pagar</option>
              <option value="Receber">Receber</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="descricao">Descrição</label>
          <input type="text" id="descricao" placeholder="Ex: Aluguel, Salário..." required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="valor">Valor</label>
            <input type="number" id="valor" placeholder="0,00" required step="0.01">
          </div>
          <div class="form-group">
            <label for="status">Status</label>
            <select id="status" required>
              <option value="Pendente">Pendente</option>
              <option value="Pago">Pago</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="campo1">Campo Adicional 1</label>
          <input type="text" id="campo1" placeholder="Opcional">
        </div>
        <div class="form-group">
          <label for="campo2">Campo Adicional 2</label>
          <input type="text" id="campo2" placeholder="Opcional">
        </div>
        <div class="form-group">
          <label for="campo3">Campo Adicional 3</label>
          <input type="text" id="campo3" placeholder="Opcional">
        </div>
        <button type="submit" class="btn-primary">Salvar Registro</button>
      </form>
    </div>

    <div class="chart-section">
      <h2>Resumo Visual</h2>
      <canvas id="graficoTipo"></canvas>
    </div>
  </div>

  <div class="table-section">
    <h2>Registros</h2>
    <div class="search-bar">
      <input type="text" id="buscar" placeholder="🔍 Buscar por descrição, data ou tipo...">
    </div>
    <button class="btn-primary export-btn" onclick="exportarExcel()">📊 Exportar para Excel</button>
    <table id="tabelaFinance">
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Descrição</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Campos</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby8RMoklQLNtr6Ffg9_ubqo8cH2in9hJgpP5zezr5CyzrULaRF74k4mnWzd11lmx-P2/exec";
let registros = [];
let chart;

const formatarMoeda = (valor)=> new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);

async function carregarRegistros(){
  const res = await fetch(API_URL + "?action=get");
  registros = await res.json();
  mostrarRegistros(registros);
  atualizarGrafico();
}

function mostrarRegistros(lista){
  const tbody = document.querySelector("#tabelaFinance tbody");
  tbody.innerHTML="";
  let totalPagar=0,totalReceber=0;

  lista.forEach(r=>{
    const tr = document.createElement("tr");
    const tipoBadge = r.tipo==="Pagar"?"badge-pagar":"badge-receber";
    const statusBadge = r.status==="Pendente"?"badge-pendente":"badge-pago";
    tr.innerHTML=`
      <td>${new Date(r.data).toLocaleDateString('pt-BR')}</td>
      <td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
      <td>${r.descricao}</td>
      <td>${formatarMoeda(parseFloat(r.valor))}</td>
      <td><span class="badge ${statusBadge}">${r.status}</span></td>
      <td>${r.campo1||'-'} ${r.campo2||''} ${r.campo3||''}</td>
      <td>
        <div class="actions">
          <button class="btn-edit" onclick="editar(${r.row})">Editar</button>
          <button class="btn-danger" onclick="excluir(${r.row})">Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
    if(r.tipo==="Pagar") totalPagar+=parseFloat(r.valor);
    if(r.tipo==="Receber") totalReceber+=parseFloat(r.valor);
  });

  document.getElementById("totalPagar").innerText=formatarMoeda(totalPagar);
  document.getElementById("totalReceber").innerText=formatarMoeda(totalReceber);
  document.getElementById("totalDia").innerText=formatarMoeda(totalReceber-totalPagar);
}

function atualizarGrafico(filtro=registros){
  const pagar = filtro.filter(r=>r.tipo==="Pagar").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  const receber = filtro.filter(r=>r.tipo==="Receber").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  const ctx=document.getElementById('graficoTipo').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:'doughnut',
    data:{ labels:['Pagar','Receber'], datasets:[{data:[pagar,receber],backgroundColor:['#ff6b6b','#51cf66'],borderColor:'white',borderWidth:3}] },
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'bottom', labels:{ padding:15, font:{ size:12, weight:'600' } } } } }
  });
}

document.getElementById("financeForm").addEventListener("submit", async function(e){
  e.preventDefault();
  const data=document.getElementById("data").value;
  const tipo=document.getElementById("tipo").value;
  const descricao=document.getElementById("descricao").value;
  const valor=document.getElementById("valor").value;
  const status=document.getElementById("status").value;
  const campo1=document.getElementById("campo1").value;
  const campo2=document.getElementById("campo2").value;
  const campo3=document.getElementById("campo3").value;
  const rowId=document.getElementById("row").value;

  const payload={
    action: rowId?"update":"add",
    row: rowId?parseInt(rowId):null,
    data,tipo,descricao,valor,status,campo1,campo2,campo3,favorito:false
  };

  await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
  this.reset(); document.getElementById("row").value="";
  await carregarRegistros();
});

function editar(row){
  const r = registros.find(r=>r.row===row);
  if(r){
    document.getElementById("row").value=r.row;
    document.getElementById("data").value=r.data;
    document.getElementById("tipo").value=r.tipo;
    document.getElementById("descricao").value=r.descricao;
    document.getElementById("valor").value=r.valor;
    document.getElementById("status").value=r.status;
    document.getElementById("campo1").value=r.campo1;
    document.getElementById("campo2").value=r.campo2;
    document.getElementById("campo3").value=r.campo3;
    window.scrollTo({ top:0, behavior:'smooth' });
  }
}

async function excluir(row){
  if(confirm("Deseja excluir este registro?")){
    await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delete",row})});
    await carregarRegistros();
  }
}

document.getElementById("buscar").addEventListener("input", function(){
  const termo=this.value.toLowerCase();
  const filtrados=registros.filter(r=>r.descricao.toLowerCase().includes(termo)||r.data.includes(termo)||r.tipo.toLowerCase().includes(termo));
  mostrarRegistros(filtrados);
  atualizarGrafico(filtrados);
});

function exportarExcel(){
  const ws_data = registros.map(r=>[new Date(r.data).toLocaleDateString('pt-BR'),r.tipo,r.descricao,r.valor,r.status,r.campo1,r.campo2,r.campo3]);
  ws_data.unshift(["Data","Tipo","Descrição","Valor","Status","Campo1","Campo2","Campo3"]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Financeiro");
  XLSX.writeFile(wb,"Controle_Financeiro.xlsx");
}

// Inicializar
carregarRegistros();
document.getElementById("data").valueAsDate = new Date();
</script>
</body>
</html>

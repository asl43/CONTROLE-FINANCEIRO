<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* VARIÁVEIS DE COR E TEMA */
:root {
    --bg-dark: linear-gradient(135deg,#1e1e2e 0%,#2a2a3e 100%);
    --bg-light: linear-gradient(135deg,#f0f0f5 0%,#e0e0eeb0 100%);
    --card-bg-dark: linear-gradient(135deg,#2a2a3e 0%,#1f1f2e 100%);
    --card-bg-light: #ffffff;
    --text-color-dark: #e0e0e0;
    --text-color-light: #333333;
    --header-color-dark: #fff;
    --header-color-light: #4a90e2;
    --input-bg-dark: rgba(255,255,255,0.05);
    --input-bg-light: #ffffff;
    --input-border-dark: rgba(255,255,255,0.2);
    --input-border-light: #dddddd;
    --table-header-bg-dark: rgba(255,255,255,0.05);
    --table-header-bg-light: #f5f5f5;
    --table-row-hover-dark: rgba(255,255,255,0.05);
    --table-row-hover-light: #f0f0f0;
    --primary-color: #4a90e2;
    --pagar-color: #ff6b9d;
    --receber-color: #26de81;
}

/* TEMA CLARO */
html[data-theme="light"] {
    --bg-dark: var(--bg-light);
    --card-bg-dark: var(--card-bg-light);
    --text-color-dark: var(--text-color-light);
    --header-color-dark: var(--header-color-light);
    --input-bg-dark: var(--input-bg-light);
    --input-border-dark: var(--input-border-light);
    --table-header-bg-dark: var(--table-header-bg-light);
    --table-row-hover-dark: var(--table-row-hover-light);
    --sync-dot-dark: #26de81;
}

/* ESTILOS BASEADOS EM VARIÁVEIS */
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background:var(--bg-dark);
  padding:20px; 
  color:var(--text-color-dark);
  min-height:100vh;
  transition: background 0.5s, color 0.5s;
}
.container { max-width:1400px; margin:0 auto; }
header { text-align:center; margin-bottom:40px; }
header h1 { 
  font-size:2.5em; 
  color:var(--header-color-dark); 
  font-weight:700;
  letter-spacing:-1px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
}
/* Estilos para o botão de tema */
.theme-toggle-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-color);
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.sync-status {
  background:rgba(38,222,129,0.2);
  border:1px solid rgba(38,222,129,0.5);
  color:var(--receber-color);
  padding:10px 15px;
  border-radius:10px;
  font-size:0.9em;
  margin-bottom:20px;
  display:flex;
  align-items:center;
  gap:10px;
  width:fit-content;
  margin-left:auto;
  margin-right:auto;
}
.sync-status.offline {
  background:rgba(255,107,157,0.2);
  border-color:rgba(255,107,157,0.5);
  color:var(--pagar-color);
}
.sync-status .dot {
  width:10px;
  height:10px;
  border-radius:50%;
  background:var(--receber-color);
  animation:pulse 2s infinite;
}
.sync-status.offline .dot {
  background:var(--pagar-color);
  animation:none;
}
@keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.5; } }
.cards-summary { 
  display:grid; 
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); 
  gap:20px; 
  margin-bottom:30px; 
}
.card { 
  background:var(--card-bg-dark);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  transition:transform 0.3s ease,box-shadow 0.3s ease, background 0.5s;
  backdrop-filter:blur(10px);
}
html[data-theme="light"] .card {
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    border: 1px solid #eeeeee;
}
.card:hover { 
  transform:translateY(-5px); 
  box-shadow:0 15px 50px rgba(0,0,0,0.4);
}
.card-label { 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:10px; 
  text-transform:uppercase; 
  letter-spacing:1px;
  font-weight:600;
}
.card-value { 
  font-size:2em; 
  font-weight:700;
  letter-spacing:-1px;
}
.card-pagar .card-value { color:var(--pagar-color); }
.card-receber .card-value { color:var(--receber-color); }
.card-saldo .card-value { color:var(--primary-color); }
.content { 
  display:grid; 
  grid-template-columns:1fr 1fr; 
  gap:25px; 
  margin-bottom:30px; 
}
.form-section, .chart-section, .table-section { 
  background:var(--card-bg-dark);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  transition: background 0.5s;
}
html[data-theme="light"] .form-section, 
html[data-theme="light"] .chart-section, 
html[data-theme="light"] .table-section {
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    border: 1px solid #eeeeee;
}
.form-section h2, .chart-section h2, .table-section h2 { 
  font-size:1.4em; 
  margin-bottom:20px;
  color:var(--header-color-dark);
  font-weight:700;
  transition: color 0.5s;
}
.form-group { margin-bottom:15px; }
label { 
  display:block; 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:8px; 
  text-transform:uppercase; 
  font-weight:600;
  letter-spacing:0.5px;
}
input, select { 
  width:100%; 
  padding:12px 15px; 
  border:1px solid var(--input-border-dark); 
  border-radius:10px; 
  background:var(--input-bg-dark);
  color:var(--text-color-dark);
  font-size:1em;
  transition:all 0.3s ease;
}
html[data-theme="light"] input, 
html[data-theme="light"] select {
    color: var(--text-color-light);
}
input:focus, select:focus { 
  outline:none;
  border-color:var(--primary-color);
  background:rgba(74,144,226,0.1);
  box-shadow:0 0 20px rgba(74,144,226,0.3);
}
button { 
  padding:12px 24px; 
  border:none; 
  border-radius:10px; 
  cursor:pointer; 
  font-weight:600;
  font-size:1em;
  transition:all 0.3s ease;
}
.btn-primary { 
  background:linear-gradient(135deg,var(--primary-color) 0%,#357abd 100%);
  color:white; 
  width:100%; 
}
.btn-primary:hover { 
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(74,144,226,0.4);
}
.btn-danger { 
  background:linear-gradient(135deg,var(--pagar-color) 0%,#d63447 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-edit { 
  background:linear-gradient(135deg,var(--receber-color) 0%,#1bb366 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-filter {
  background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%);
  color:white;
  padding:10px 20px;
  margin-bottom:0; 
  font-size:0.95em;
  width: auto;
}
.btn-filter.active {
  background:linear-gradient(135deg,var(--pagar-color) 0%,#d63447 100%);
}
.search-bar { margin-bottom:15px; }
.search-bar input { width:100%; }
table { width:100%; border-collapse:collapse; }
th { 
  padding:15px 10px; 
  text-align:left; 
  background:var(--table-header-bg-dark);
  border-bottom:2px solid rgba(255,255,255,0.1);
  font-weight:700;
  color:var(--header-color-dark);
  font-size:0.95em;
  transition: background 0.5s, color 0.5s;
}
td { 
  padding:15px 10px; 
  border-bottom:1px solid rgba(255,255,255,0.05); 
}
html[data-theme="light"] td {
    border-bottom: 1px solid #eeeeee;
}
tr:hover { background:var(--table-row-hover-dark); }
.badge { 
  padding:6px 12px; 
  border-radius:20px; 
  font-size:0.8em; 
  font-weight:700; 
  text-transform:uppercase;
  letter-spacing:0.5px;
  display:inline-block;
}
.badge-pagar { 
  background:rgba(255,107,157,0.2); 
  color:var(--pagar-color); 
  border:1px solid rgba(255,107,157,0.5);
}
.badge-receber { 
  background:rgba(38,222,129,0.2); 
  color:var(--receber-color); 
  border:1px solid rgba(38,222,129,0.5);
}
.badge-pendente { 
  background:rgba(255,193,7,0.2); 
  color:#ffc107; 
  border:1px solid rgba(255,193,7,0.5);
}
.badge-pago { 
  background:rgba(38,222,129,0.2); 
  color:var(--receber-color); 
  border:1px solid rgba(38,222,129,0.5);
}
.actions { 
  display:flex; 
  gap:8px;
}
.filter-controls {
    display:flex; 
    gap:10px; 
    margin-bottom:15px; 
    flex-wrap:wrap; 
    align-items:flex-end;
}
.filter-item {
    min-width:150px;
    flex: 1;
}
.filter-item-large {
    flex: 2;
    min-width: 250px;
}
.filter-summary {
    background: rgba(74,144,226,0.1);
    border: 1px solid var(--primary-color);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    font-weight: 600;
    display: flex;
    justify-content: space-around;
    align-items: center;
    flex-wrap: wrap;
    display: none; /* Inicia oculto */
}
.filter-summary span {
    margin: 5px 10px;
}
.summary-value-pagar { color: var(--pagar-color); font-weight: 700; }
.summary-value-receber { color: var(--receber-color); font-weight: 700; }
.summary-value-saldo { color: var(--primary-color); font-weight: 700; }

@media(max-width:768px){
  .content{ grid-template-columns:1fr; }
  header h1 { font-size:1.8em; }
  .card-value { font-size:1.5em; }
  table { font-size:0.9em; }
  th, td { padding:10px 5px; }
  .filter-controls > div {
      min-width: 100%;
  }
}
</style>
</head>
<body>

<button class="theme-toggle-btn" onclick="toggleTheme()">☀️ Modo Diurno</button>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>🔐 Acesso Restrito</h2>
    <p style="color:#b0b0b0; margin-bottom:20px;">Digite a senha para acessar o sistema</p>
    <input type="password" id="senhaInput" placeholder="Digite sua senha" onkeypress="if(event.key==='Enter') fazerLogin()">
    <button onclick="fazerLogin()">🔓 Entrar</button>
    <div class="erro-senha" id="erroSenha"></div>
  </div>
</div>

<div class="container" id="mainContainer" style="display:none;">
<header>
<h1>💰 Controle Financeiro</h1>
<div class="sync-status" id="syncStatus">
  <div class="dot"></div>
  <span id="syncText">Sincronizado</span>
</div>
</header>

<div class="cards-summary">
<div class="card card-pagar"><div class="card-label">Total a Pagar</div><div class="card-value" id="totalPagar">R$ 0,00</div></div>
<div class="card card-receber"><div class="card-label">Total a Receber</div><div class="card-value" id="totalReceber">R$ 0,00</div></div>
<div class="card card-saldo"><div class="card-label">Saldo do Dia</div><div class="card-value" id="totalDia">R$ 0,00</div></div>
<div class="card card-pagar"><div class="card-label">Gasto Hoje</div><div class="card-value" id="gastoHoje">R$ 0,00</div></div>
<div class="card card-pagar"><div class="card-label">Gasto este Mês</div><div class="card-value" id="gastoMes">R$ 0,00</div></div>
</div>

<div class="content">
<div class="form-section">
<h2>📝 Novo Registro</h2>
<form id="financeForm">
<input type="hidden" id="row">
<input type="hidden" id="sheetRowId">

<div class="form-group">
<label for="data">Data</label>
<input type="date" id="data" required>
</div>

<div class="form-group">
<label for="tipo">Tipo</label>
<select id="tipo" required>
<option value="Pagar">Pagar</option>
<option value="Receber">Receber</option>
</select>
</div>

<div class="form-group">
<label for="descricao">Descrição</label>
<input type="text" id="descricao" placeholder="Ex: Aluguel, Salário..." required>
</div>

<div class="form-group">
<label for="valor">Valor</label>
<input type="number" id="valor" placeholder="0,00" required step="0.01">
</div>

<div class="form-group">
<label for="status">Status</label>
<select id="status" required>
<option value="Pendente">Pendente</option>
<option value="Pago">Pago</option>
<option value="Recebido">Recebido</option>
</select>
</div>

<div class="form-group">
<label for="campo1">Campo Adicional 1</label>
<input type="text" id="campo1" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo2">Campo Adicional 2</label>
<input type="text" id="campo2" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo3">Campo Adicional 3</label>
<input type="text" id="campo3" placeholder="Opcional">
</div>

<button type="submit" class="btn-primary">💾 Salvar Registro</button>
</form>
</div>

<div class="chart-section">
<h2>📊 Resumo Visual (Pendentes)</h2>
<canvas id="graficoTipo"></canvas>
</div>
</div>

<div class="content" style="grid-template-columns: 1fr;">
<div class="table-section">
<h2>📋 Registros</h2>
<div class="loading" id="loading">⏳ Sincronizando...</div>
    
<div class="filter-controls">
    <div class="filter-item-large">
        <label for="buscar" style="margin-bottom: 5px; font-size: 0.8em; color:var(--primary-color);">Buscar Texto</label>
        <input type="text" id="buscar" placeholder="🔍 Descrição, data ou tipo..." style="width:100%; padding:12px 15px; border-radius:10px;">
    </div>
    
    <div class="filter-item">
        <label for="dataInicio" style="margin-bottom: 5px; font-size: 0.8em;">Início</label>
        <input type="date" id="dataInicio" style="padding:10px 15px;">
    </div>
    <div class="filter-item">
        <label for="dataFim" style="margin-bottom: 5px; font-size: 0.8em;">Fim</label>
        <input type="date" id="dataFim" style="padding:10px 15px;">
    </div>
    
    <button class="btn-filter" id="btnFiltrarData" style="min-width:120px; height: 45px; padding:10px 20px; align-self:flex-end;">Filtrar</button>
    
    <button class="btn-filter" id="btnFiltrarFav" style="height: 45px; padding:10px 20px; align-self:flex-end;">⭐ Apenas Favoritos</button>
    <button class="btn-primary export-btn" onclick="exportarExcel()" style="width: auto; height: 45px; padding:10px 20px; align-self:flex-end;">📥 Exportar Excel</button>
</div>

<div class="filter-summary" id="periodSummary">
    <span>Período Filtrado:</span>
    <span>Total Pagar: <span class="summary-value-pagar" id="summaryPagar"></span></span>
    <span>Total Receber: <span class="summary-value-receber" id="summaryReceber"></span></span>
    <span>Saldo Período: <span class="summary-value-saldo" id="summarySaldo"></span></span>
</div>

<table id="tabelaFinance">
<thead>
<tr>
<th>Fav</th>
<th>Data</th><th>Tipo</th><th>Descrição</th><th>Valor</th><th>Status</th><th>Campos</th><th>Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="content" style="grid-template-columns: 1fr 1fr;">
    <div class="chart-section">
        <h2>📈 Gastos por Dia (Últimos 7 dias)</h2>
        <canvas id="graficoDiario"></canvas>
    </div>

    <div class="chart-section">
        <h2>📉 Gastos Mensais (Últimos 12 meses)</h2>
        <canvas id="graficoMensal"></canvas>
    </div>
</div>


<script>
let registros = [];
let chart;
let chartDiario;
let chartMensal;
let mostraApenasFav = false;
let usuarioAutenticado = false;
let currentTheme = localStorage.getItem('theme') || 'dark';

// URL DO WEB APP CONFIGURADA
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxCkEbskP0tA-4Ii_9v1wS7z2_9yHP0nn-_GroK_Z4paEiurRMz6Iole6902c00FR-Q/exec";

// CONFIGURE SUA SENHA AQUI (troque por uma senha forte!)
const SENHA_ACESSO = "minhasenha123";

const formatarMoeda = valor => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);

function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', currentTheme);
    applyTheme();
}

function applyTheme() {
    document.documentElement.setAttribute('data-theme', currentTheme);
    const themeButton = document.querySelector('.theme-toggle-btn');
    if (currentTheme === 'light') {
        themeButton.innerHTML = '🌙 Modo Noturno';
        // Ajusta a cor dos gráficos ao mudar o tema
        if(chart) atualizarGraficos(registros); 
    } else {
        themeButton.innerHTML = '☀️ Modo Diurno';
        if(chart) atualizarGraficos(registros); 
    }
}

function fazerLogin() {
  const senha = document.getElementById("senhaInput").value;
  const erroDiv = document.getElementById("erroSenha");
  
  if(senha === SENHA_ACESSO) {
    usuarioAutenticado = true;
    sessionStorage.setItem("autenticado", "true");
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainContainer").style.display = "block";
    carregarRegistros();
    erroDiv.innerText = "";
  } else {
    erroDiv.innerText = "❌ Senha incorreta! Tente novamente.";
    document.getElementById("senhaInput").value = "";
  }
}

function verificarAutenticacao() {
  if(sessionStorage.getItem("autenticado") === "true") {
    usuarioAutenticado = true;
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainContainer").style.display = "block";
  }
}

/**
 * Corrige o problema do fuso horário em inputs de data.
 */
function corrigirData(dataInput) {
  const data = new Date(dataInput + 'T12:00:00'); 
  const ano = data.getFullYear();
  const mes = String(data.getMonth() + 1).padStart(2, '0');
  const dia = String(data.getDate()).padStart(2, '0');
  return `${ano}-${mes}-${dia}`;
}

function mostrarLoading(show) {
  const loading = document.getElementById("loading");
  if(show) loading.classList.add("show");
  else loading.classList.remove("show");
}

function atualizarStatusSync(sincronizado) {
  const status = document.getElementById("syncStatus");
  const text = document.getElementById("syncText");
  
  if(sincronizado) {
    status.classList.remove("offline");
    text.innerText = "✓ Sincronizado";
  } else {
    status.classList.add("offline");
    text.innerText = "⚠ Offline - Dados locais";
  }
}

function atualizarCardsGlobais(dataList) {
    let totalPagarGlobal=0,totalReceberGlobal=0;
    let gastoHojeGlobal = 0, gastoMesGlobal = 0;
    const hoje = new Date().toISOString().split('T')[0];
    const mesAtual = new Date().getMonth();
    const anoAtual = new Date().getFullYear();

    dataList.forEach(r => {
        if(r.tipo==="Pagar" && r.status==="Pendente") totalPagarGlobal+=parseFloat(r.valor);
        if(r.tipo==="Receber" && r.status==="Pendente") totalReceberGlobal+=parseFloat(r.valor);
        
        // Calcular gastos de hoje (apenas `Pagar`)
        if(r.data === hoje && r.tipo==="Pagar") {
            gastoHojeGlobal += parseFloat(r.valor);
        }
        
        // Calcular gastos do mês (apenas `Pagar`)
        const dataParse = new Date(r.data);
        if(dataParse.getMonth() === mesAtual && dataParse.getFullYear() === anoAtual && r.tipo==="Pagar") {
            gastoMesGlobal += parseFloat(r.valor);
        }
    });

    document.getElementById("totalPagar").innerText=formatarMoeda(totalPagarGlobal);
    document.getElementById("totalReceber").innerText=formatarMoeda(totalReceberGlobal);
    document.getElementById("totalDia").innerText=formatarMoeda(totalReceberGlobal-totalPagarGlobal);
    document.getElementById("gastoHoje").innerText=formatarMoeda(gastoHojeGlobal);
    document.getElementById("gastoMes").innerText=formatarMoeda(gastoMesGlobal);
}


function mostrarRegistros(lista){
  const tbody = document.querySelector("#tabelaFinance tbody");
  tbody.innerHTML="";
  
  // 1. Atualiza os cards de resumo com os totais GLOBAIS
  atualizarCardsGlobais(registros);
  
  // 2. Preenche a tabela com a lista filtrada
  lista.forEach(r=>{
    const tr=document.createElement("tr");
    const tipoBadge=r.tipo==="Pagar"?"badge-pagar":"badge-receber";
    const statusBadge=r.status==="Pendente"?"badge-pendente":(r.status==="Pago"||r.status==="Recebido")?"badge-pago":"badge-pendente";
    const starClass = r.fav ? "star" : "star-empty";
    
    // Usando a correção de data para exibição
    tr.innerHTML=`
      <td><span class="${starClass}" onclick="toggleFav(${r.row})">★</span></td>
      <td>${new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
      <td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
      <td>${r.descricao}</td>
      <td><strong>${formatarMoeda(parseFloat(r.valor))}</strong></td>
      <td><span class="badge ${statusBadge}" onclick="mudarStatus(${r.row})" style="cursor:pointer;">${r.status}</span></td>
      <td>${r.campo1||'-'} ${r.campo2||''} ${r.campo3||''}</td>
      <td>
        <div class="actions">
          <button class="btn-edit" onclick="editar(${r.row})">Editar</button>
          <button class="btn-danger" onclick="excluir(${r.row})">Excluir</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // 3. Atualiza os gráficos (sempre com a lista completa)
  atualizarGraficos(registros); 
}

function atualizarGraficos(dataList){
  const fontColor = currentTheme === 'light' ? '#333333' : '#e0e0e0';
  const gridColor = currentTheme === 'light' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
  
  const pagar=dataList.filter(r=>r.tipo==="Pagar" && r.status==="Pendente").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  const receber=dataList.filter(r=>r.tipo==="Receber" && r.status==="Pendente").reduce((sum,r)=>sum+parseFloat(r.valor),0);
  
  // Gráfico Tipo (Pizza)
  const ctx=document.getElementById('graficoTipo').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['A Pagar','A Receber'],
      datasets:[{
        data:[pagar,receber],
        backgroundColor:['#ff6b9d','#26de81'],
        borderColor: currentTheme === 'light' ? '#ffffff' : '#1f1f2e',
        borderWidth:3
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom',labels:{color:fontColor,font:{size:12,weight:'bold'}}}
      }
    }
  });
  
  // Gráfico Diário (Linha - Últimos 7 dias)
  const gastosPorDia = {};
  const hoje = new Date();
  
  for(let i = 6; i >= 0; i--) {
    const data = new Date(hoje);
    data.setDate(data.getDate() - i);
    const chave = data.toISOString().split('T')[0];
    gastosPorDia[chave] = 0;
  }
  
  dataList.forEach(r => {
    if(r.tipo==="Pagar") {
      if(gastosPorDia.hasOwnProperty(r.data)) {
        gastosPorDia[r.data] += parseFloat(r.valor);
      }
    }
  });
  
  const diasLabels = Object.keys(gastosPorDia).map(d => new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'}));
  const diasValores = Object.values(gastosPorDia);
  
  const ctxDiario = document.getElementById('graficoDiario').getContext('2d');
  if(chartDiario) chartDiario.destroy();
  chartDiario = new Chart(ctxDiario, {
    type: 'line',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Gastos Diários',
        data: diasValores,
        borderColor: '#ff6b9d',
        backgroundColor: 'rgba(255, 107, 157, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#ff6b9d',
        pointBorderColor: currentTheme === 'light' ? '#333' : '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 12, weight: 'bold'}}}
      },
      scales: {
        y: {beginAtZero: true, ticks: {color: fontColor}, grid: {color: gridColor}},
        x: {ticks: {color: fontColor}, grid: {color: gridColor}}
      }
    }
  });
  
  // Gráfico Mensal (Coluna - Últimos 12 meses)
  const gastosPorMes = {};
  const hojeMes = new Date().getMonth();
  const hojeAno = new Date().getFullYear();
  
  for(let i = 0; i < 12; i++) {
    const mes = (hojeMes - i + 12) % 12;
    const ano = hojeAno - Math.floor((hojeMes - i) / 12);
    const nomeMes = new Date(ano, mes, 1).toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
    gastosPorMes[nomeMes] = 0;
  }
  
  dataList.forEach(r => {
    if(r.tipo==="Pagar") {
      const dataParse = new Date(r.data);
      const nomeMes = dataParse.toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
      if(gastosPorMes.hasOwnProperty(nomeMes)) {
        gastosPorMes[nomeMes] += parseFloat(r.valor);
      }
    }
  });

  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  if(chartMensal) chartMensal.destroy();
  chartMensal = new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: Object.keys(gastosPorMes),
      datasets: [{
        label: 'Gastos Mensais',
        data: Object.values(gastosPorMes),
        backgroundColor: '#4a90e2',
        borderColor: '#357abd',
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 12, weight: 'bold'}}}
      },
      scales: {
        y: {beginAtZero: true, ticks: {color: fontColor}, grid: {color: gridColor}},
        x: {ticks: {color: fontColor}, grid: {color: gridColor}}
      }
    }
  });
}


async function enviarParaPlanilha(dados){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify(dados)
    });
    const result = await resp.json();
    atualizarStatusSync(true);
    mostrarLoading(false);
    return result;
  }catch(e){
    console.error("Erro ao sincronizar:",e);
    atualizarStatusSync(false);
    mostrarLoading(false);
    alert("⚠️ Erro ao sincronizar. Verifique sua conexão e a URL do Web App.");
  }
}

async function carregarRegistros(){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify({action:'get'})
    });
    const data = await resp.json();
    
    if(Array.isArray(data)) {
      registros = data.map((r, idx) => ({...r, row: idx + 1, fav: r.fav || false}));
      atualizarStatusSync(true);
      aplicarFiltros(); 
      console.log("✓ Carregados " + registros.length + " registros");
    }
  }catch(e){
    console.error("Erro ao carregar:",e);
    atualizarStatusSync(false);
  }
  mostrarLoading(false);
}

document.getElementById("financeForm").addEventListener("submit",function(e){
  e.preventDefault();
  const data=corrigirData(document.getElementById("data").value);
  const tipo=document.getElementById("tipo").value;
  const descricao=document.getElementById("descricao").value;
  const valor=document.getElementById("valor").value;
  const status=document.getElementById("status").value;
  const campo1=document.getElementById("campo1").value;
  const campo2=document.getElementById("campo2").value;
  const campo3=document.getElementById("campo3").value;
  
  if(!data||!tipo||!descricao||!valor||!status){alert("Preencha todos os campos!"); return;}
  
  const row=document.getElementById("row").value;
  const sheetRowId=document.getElementById("sheetRowId").value;
  
  if(row){
    const idx = registros.findIndex(r=>r.id == sheetRowId);
    if(idx !== -1) {
      registros[idx]={...registros[idx],data,tipo,descricao,valor,status,campo1,campo2,campo3};
      enviarParaPlanilha({...registros[idx],action:'update'});
    }
    document.getElementById("row").value="";
    document.getElementById("sheetRowId").value="";
  }else{
    const novoRegistro={data,tipo,descricao,valor,status,campo1,campo2,campo3,fav:false};
    registros.push(novoRegistro);
    enviarParaPlanilha({...novoRegistro,action:'add'});
  }
  
  this.reset();
  document.getElementById("data").valueAsDate=new Date();
  mostraApenasFav = false;
  document.getElementById("btnFiltrarFav").classList.remove("active");
  aplicarFiltros(); 
});

/**
 * Função unificada para aplicar todos os filtros (texto, data, favoritos) e atualizar a tabela.
 */
function aplicarFiltros() {
    const termo = document.getElementById("buscar").value.toLowerCase();
    const dataInicioStr = document.getElementById("dataInicio").value;
    const dataFimStr = document.getElementById("dataFim").value;
    const summaryDiv = document.getElementById("periodSummary");
    
    let filtrados = registros;
    let totalPagarPeriodo = 0;
    let totalReceberPeriodo = 0;
    let dataFiltroAtivo = false;

    // 1. Filtragem por data
    if (dataInicioStr && dataFimStr) {
        dataFiltroAtivo = true;
        const dataInicio = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        const dataFim = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
        
        filtrados = filtrados.filter(r => {
            const dataRegistro = new Date(r.data + 'T12:00:00'); 
            return dataRegistro >= dataInicio && dataRegistro <= dataFim;
        });
    }

    // 2. Filtragem por favoritos
    if (mostraApenasFav) {
        filtrados = filtrados.filter(r => r.fav);
    }

    // 3. Filtragem por texto
    if (termo) {
        filtrados = filtrados.filter(r => 
            r.descricao.toLowerCase().includes(termo) || 
            r.tipo.toLowerCase().includes(termo) || 
            r.data.includes(termo)
        );
    }
    
    // CALCULA A SOMA TOTAL APÓS TODOS OS FILTROS SEREM APLICADOS
    totalPagarPeriodo = filtrados.filter(r => r.tipo === "Pagar").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    totalReceberPeriodo = filtrados.filter(r => r.tipo === "Receber").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    
    // EXIBE O RESUMO DO PERÍODO
    if (dataFiltroAtivo || mostraApenasFav || termo) {
        document.getElementById("summaryPagar").innerText = formatarMoeda(totalPagarPeriodo);
        document.getElementById("summaryReceber").innerText = formatarMoeda(totalReceberPeriodo);
        document.getElementById("summarySaldo").innerText = formatarMoeda(totalReceberPeriodo - totalPagarPeriodo);
        summaryDiv.style.display = 'flex';
    } else {
        summaryDiv.style.display = 'none';
    }

    mostrarRegistros(filtrados);
}

// Event Listeners
document.getElementById("buscar").addEventListener("input", aplicarFiltros);
document.getElementById("btnFiltrarData").addEventListener("click", aplicarFiltros);

document.getElementById("btnFiltrarFav").addEventListener("click", function(){
  mostraApenasFav = !mostraApenasFav;
  this.classList.toggle("active");
  aplicarFiltros();
});

function mudarStatus(row) {
  const registro = registros.find(r => r.row === row);
  if(!registro) return;
  
  let novoStatus = registro.status;
  if(registro.status === "Pendente") {
    novoStatus = registro.tipo === "Pagar" ? "Pago" : "Recebido";
  } else {
    novoStatus = "Pendente";
  }
  
  registro.status = novoStatus;
  enviarParaPlanilha({...registro, action:'update'});
  aplicarFiltros(); 
}

function exportarExcel(){
  // A exportação usa a mesma lógica de filtro da função aplicarFiltros
  const termo = document.getElementById("buscar").value.toLowerCase();
  const dataInicioStr = document.getElementById("dataInicio").value;
  const dataFimStr = document.getElementById("dataFim").value;
  
  let listaExportar = registros;

  if (dataInicioStr && dataFimStr) {
      const dataInicio = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
      const dataFim = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
      listaExportar = listaExportar.filter(r => {
          const dataRegistro = new Date(r.data + 'T12:00:00'); 
          return dataRegistro >= dataInicio && dataRegistro <= dataFim;
      });
  }

  if (mostraApenasFav) {
      listaExportar = listaExportar.filter(r => r.fav);
  }

  if (termo) {
      listaExportar = listaExportar.filter(r => 
          r.descricao.toLowerCase().includes(termo) || 
          r.tipo.toLowerCase().includes(termo) || 
          r.data.includes(termo)
      );
  }

  const ws_data=listaExportar.map(r=>[r.fav?"★":"",new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR'),r.tipo,r.descricao,r.valor,r.status,r.campo1||'',r.campo2||'',r.campo3||'']);
  ws_data.unshift(["Fav","Data","Tipo","Descrição","Valor","Status","Campo1","Campo2","Campo3"]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Financeiro");
  XLSX.writeFile(wb,"Controle_Financeiro.xlsx");
}

function editar(row){
  const r=registros.find(r=>r.row===row);
  if(r){
    document.getElementById("row").value=r.row;
    document.getElementById("sheetRowId").value=r.id;
    document.getElementById("data").value=r.data;
    document.getElementById("tipo").value=r.tipo;
    document.getElementById("descricao").value=r.descricao;
    document.getElementById("valor").value=r.valor;
    document.getElementById("status").value=r.status;
    document.getElementById("campo1").value=r.campo1||'';
    document.getElementById("campo2").value=r.campo2||'';
    document.getElementById("campo3").value=r.campo3||'';
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

function excluir(row){
  if(confirm("Deseja excluir este registro?")){
    const r = registros.find(r=>r.row===row);
    const idx = registros.findIndex(r=>r.row===row);
    enviarParaPlanilha({...r,action:'delete'});
    registros.splice(idx,1);
    mostraApenasFav = false;
    document.getElementById("btnFiltrarFav").classList.remove("active");
    aplicarFiltros();
  }
}

function toggleFav(row){
  const idx = registros.findIndex(r=>r.row===row);
  registros[idx].fav=!registros[idx].fav;
  enviarParaPlanilha({...registros[idx],action:'update'});
  aplicarFiltros();
}

document.getElementById("data").valueAsDate=new Date();
verificarAutenticacao();
applyTheme(); // Aplica o tema salvo ao carregar

// Sincronizar a cada 10 segundos (apenas se autenticado)
setInterval(() => {
  if(usuarioAutenticado) {
    carregarRegistros();
    console.log("↻ Sincronizando...");
  }
}, 10000);
</script>

</body>
</html>
